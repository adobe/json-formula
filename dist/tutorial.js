var jsonFormula;(()=>{"use strict";var t=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e={};(()=>{t(e);const r={TYPE_NUMBER:0,TYPE_ANY:1,TYPE_STRING:2,TYPE_ARRAY:3,TYPE_OBJECT:4,TYPE_BOOLEAN:5,TYPE_EXPREF:6,TYPE_NULL:7,TYPE_ARRAY_NUMBER:8,TYPE_ARRAY_STRING:9,TYPE_ARRAY_ARRAY:10,TYPE_EMPTY_ARRAY:11},n={[r.TYPE_NUMBER]:"number",[r.TYPE_ANY]:"any",[r.TYPE_STRING]:"string",[r.TYPE_ARRAY]:"array",[r.TYPE_OBJECT]:"object",[r.TYPE_BOOLEAN]:"boolean",[r.TYPE_EXPREF]:"expression",[r.TYPE_NULL]:"null",[r.TYPE_ARRAY_NUMBER]:"Array<number>",[r.TYPE_ARRAY_STRING]:"Array<string>",[r.TYPE_ARRAY_ARRAY]:"Array<array>",[r.TYPE_EMPTY_ARRAY]:"array"},s={TOK_EOF:"EOF",TOK_IDENTIFIER:"Identifier",TOK_QUOTEDIDENTIFIER:"QuotedIdentifier",TOK_RBRACKET:"Rbracket",TOK_RPAREN:"Rparen",TOK_COMMA:"Comma",TOK_COLON:"Colon",TOK_CONCATENATE:"Concatenate",TOK_RBRACE:"Rbrace",TOK_NUMBER:"Number",TOK_CURRENT:"Current",TOK_GLOBAL:"Global",TOK_EXPREF:"Expref",TOK_PIPE:"Pipe",TOK_OR:"Or",TOK_AND:"And",TOK_ADD:"Add",TOK_SUBTRACT:"Subtract",TOK_UNARY_MINUS:"UnaryMinus",TOK_MULTIPLY:"Multiply",TOK_UNION:"Union",TOK_DIVIDE:"Divide",TOK_COMPARATOR:"Comparator",TOK_FLATTEN:"Flatten",TOK_STAR:"Star",TOK_FILTER:"Filter",TOK_DOT:"Dot",TOK_NOT:"Not",TOK_LBRACE:"Lbrace",TOK_LBRACKET:"Lbracket",TOK_LPAREN:"Lparen",TOK_JSON:"Literal",TOK_STRING:"String",TOK_INT:"Integer"};function i(t){return new TypeError(t)}function a(t){const e=new Error(t);return e.name="SyntaxError",e}function o(t){const e=new Error(t);return e.name="FunctionError",e}function u(t){const e=new Error(t);return e.name="EvaluationError",e}const{TYPE_NUMBER:c,TYPE_ANY:l,TYPE_STRING:h,TYPE_ARRAY:p,TYPE_OBJECT:_,TYPE_BOOLEAN:f,TYPE_EXPREF:d,TYPE_NULL:y,TYPE_ARRAY_NUMBER:g,TYPE_ARRAY_STRING:m,TYPE_ARRAY_ARRAY:v,TYPE_EMPTY_ARRAY:T}=r,{TOK_EXPREF:E}=s;function O(t){return[p,g,m,v,T].includes(t)}function b(t){function e(t){if(null===t)return y;const e=typeof t;return"string"===e?h:"number"===e?c:"boolean"===e?f:Array.isArray(t)?0===t.length?T:t.flat(1/0).every((t=>b(t)===c))?g:t.flat(1/0).every((t=>b(t)===h))?m:t.every((t=>O(b(t))))?v:p:t.jmespathType===E?d:_}let r=e(t);return r!==_||(r=e(JSON.parse(JSON.stringify(t)))),r}function A(t){return[p,g,m,v,T].includes(b(t))}function N(t){return n[b(t)]}function R(t,e,r,s,a){const o=b(e);if(e?.jmespathType===E&&!t.includes(d))throw i(`${r} does not accept an expression reference argument.`);const u=t=>t===_;if(t.some((t=>{return(e=t)===(r=o)||e===l||e===p&&O(r)||O(e)&&r===T;var e,r})))return e;const A=t.filter((t=>{return e=t,{[c]:[h,p,g,f],[f]:[h,c,p],[p]:[f,m,g],[g]:[f,m,p],[m]:[f,g,p],[v]:[f],[T]:[f],[_]:[f],[y]:[h,c,f],[h]:[c,m,p,f]}[o].includes(e);var e}));if(0===A.length)throw i(`${r} expected argument to be type ${n[t[0]]} but received type ${n[o]} instead.`);const N=A.length>1,R=A[0];let w=!1;if(O(o)&&[g,m].includes(R)&&e.flat(1/0).some((t=>{const e=b(t);return O(e)||u(e)}))&&(w=!0),N&&R===_&&(w=!0),N)throw i(`${r} cannot process type: ${n[o]}. Must be one of: ${t.map((t=>n[t])).join(", ")}.`);if(w)throw i(`${r} expected argument to be type ${n[R]} but received type ${n[o]} instead.`);if(u(o)&&R===f)return 0===Object.keys(e).length;if(O(o)){const t=t=>Array.isArray(t)?t:[t],r=t=>Array.isArray(t)?t.map(r):a(t),n=t=>Array.isArray(t)?t.map(n):s(t);if(R===f)return e.length>0;if(R===m)return e.map(r);if(R===g)return e.map(n);if(R===v)return e.map(t)}if(!O(o)&&!u(o)){if(R===m)return[a(e)];if(R===g)return[s(e)];if(R===p)return[e];if(R===c)return s(e);if(R===h)return a(e);if(R===f)return!!e}throw i(`${r} expected argument to be type ${n[R]} but received type ${n[o]} instead.`)}function w(t){return Array.isArray(t)}function x(t){return null!==t&&"[object Object]"===Object.prototype.toString.call(t)}function P(t){return null==t?t:w(t)?t.map((t=>P(t))):"function"!=typeof t.valueOf?t:t.valueOf()}function S(t){if(null===t)return!1;const e=P(t);return Array.isArray(e)?e.length>0:x(e)?Object.keys(e).length>0:!!e}function I(t,e){const r=P(t),n=P(e);if(r===n)return!0;if(Object.prototype.toString.call(r)!==Object.prototype.toString.call(n))return!1;if(!0===w(r))return r.length===n.length&&r.every(((t,e)=>I(t,n[e])));if(!0===x(r)){if(Object.keys(r).length!==Object.keys(n).length)return!1;for(const t in r)if(hasOwnProperty.call(r,t)&&!1===I(r[t],n[t]))return!1;return!0}return!1}function $(t,e){const r=Object.getOwnPropertyDescriptor(t,e);if(r?.enumerable||r?.get)return t[e]?.[Symbol.for("track")]?.(t,e),t[e]}function K(t,e,r,n=null){try{let s=[];if(w(e)&&e.length>0)return t.push(`Failed to find: '${r}' on an array object.`),void t.push(`Did you mean to use a projection? e.g. ${n||"array"}[*].${r}`);t.push(`Failed to find: '${r}'`),null!==e&&(s=[...s,...Object.entries(Object.getOwnPropertyDescriptors(e,r)).filter((([t,e])=>(e?.enumerable||!!e?.get)&&!/^[0-9]+$/.test(t)&&(!t.startsWith("$")||r.startsWith("$")))).map((([t])=>`'${t}'`))]),s.length&&t.push(`Available fields: ${s}`)}catch(t){}}const{TOK_CURRENT:j,TOK_GLOBAL:Y,TOK_EXPREF:k,TOK_PIPE:M,TOK_FLATTEN:F}=s,{TYPE_STRING:C,TYPE_ARRAY_STRING:L,TYPE_ARRAY:B,TYPE_NUMBER:U}=r;function D(t,e){if(w(t)&&w(e)){const r=t.length<e.length?t:e,n=Math.abs(t.length-e.length);r.length+=n,r.fill(null,r.length-n)}}class q{constructor(t,e,r,n,s,i){this.runtime=t,this.globals=e,this.toNumber=r,this.toString=n,this.debug=s,this.language=i,this.visitFunctions=this.initVisitFunctions(),this.debugChainStart=null}search(t,e){return this.visit(t,e)}field(t,e){if(null!==e&&(x(e)||w(e))){const r=$(e,t.name);return void 0===r?(K(this.debug,e,t.name,this.debugChainStart),null):r}return K(this.debug,e,t.name,this.debugChainStart),null}initVisitFunctions(){return{Identifier:this.field.bind(this),QuotedIdentifier:this.field.bind(this),ChainedExpression:(t,e)=>{let r=this.visit(t.children[0],e);this.debugChainStart=t.children[0].name;for(let e=1;e<t.children.length;e+=1)if(r=this.visit(t.children[1],r),null===r)return null;return r},BracketExpression:(t,e)=>{const r=this.visit(t.children[0],e);return this.visit(t.children[1],r)},Index:(t,e)=>{if(w(e)){let r=t.value.value;r<0&&(r=e.length+r);const n=e[r];return void 0===n?(this.debug.push(`Index: ${r} out of range for array size: ${e.length}`),null):n}return this.debug.push("Left side of index expression must be an array"),this.debug.push(`Did you intend a single-element array? if so, use a JSON literal: \`[${t.value.value}]\``),null},Slice:(t,e)=>{if(!w(e))return this.debug.push("Slices apply to arrays only"),null;const r=t.children.map((t=>null===t?null:t.value)),[n,s,i]=this.computeSliceParams(e.length,r),a=[];if(i>0)for(let t=n;t<s;t+=i)a.push(e[t]);else for(let t=n;t>s;t+=i)a.push(e[t]);return a},Projection:(t,e)=>{const r=this.visit(t.children[0],e);if(!w(r))return"Wildcard"===t.debug&&this.debug.push("Bracketed wildcards apply to arrays only"),null;const n=[];return r.forEach((e=>{const r=this.visit(t.children[1],e);n.push(r)})),n},ValueProjection:(t,e)=>{const r=this.visit(t.children[0],e);if(!x(P(r)))return this.debug.push("Chained wildcards apply to objects only"),null;const n=[];var s;return(s=r,Object.values(s)).forEach((e=>{const r=this.visit(t.children[1],e);n.push(r)})),n},FilterProjection:(t,e)=>{const r=this.visit(t.children[0],e);if(!w(r))return this.debug.push("Filter expressions apply to arrays only"),null;const n=r.filter((e=>S(this.visit(t.children[2],e)))),s=[];return n.forEach((e=>{const r=this.visit(t.children[1],e);s.push(r)})),s},Comparator:(t,e)=>{let r=P(this.visit(t.children[0],e)),n=P(this.visit(t.children[1],e));if("=="===t.value)return I(r,n);if("!="===t.value)return!I(r,n);if(x(r)||w(r))return this.debug.push(`Cannot use comparators with ${N(r)}`),!1;if(x(n)||w(n))return this.debug.push(`Cannot use comparators with ${N(n)}`),!1;const s=b(r),i=b(n);if(s===U||i===U)try{if(r=this.toNumber(r),n=this.toNumber(n),null===r||null===n)return!1}catch(t){return!1}return">"===t.value?r>n:">="===t.value?r>=n:"<"===t.value?r<n:r<=n},[F]:(t,e)=>{const r=this.visit(t.children[0],e);if(!w(r))return this.debug.push("Flatten expressions apply to arrays only. If you want an empty array, use a JSON literal: `[]`"),null;const n=[];return r.forEach((t=>{w(t)?n.push(...t):n.push(t)})),n},Identity:(t,e)=>e,ArrayExpression:(t,e)=>t.children.map((t=>this.visit(t,e))),ObjectExpression:(t,e)=>{const r={};return t.children.forEach((t=>{void 0!==r[t.name]&&this.debug.push(`Duplicate key: '${t.name}'`),r[t.name]=this.visit(t.value,e)})),r},OrExpression:(t,e)=>{let r=this.visit(t.children[0],e);return S(r)||(r=this.visit(t.children[1],e)),r},AndExpression:(t,e)=>{const r=this.visit(t.children[0],e);return S(r)?this.visit(t.children[1],e):r},AddExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return D(r,n),this.applyOperator(r,n,"+")},ConcatenateExpression:(t,e)=>{let r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return D(r,n),r=A(r)?R([L],r,"concatenate",this.toNumber,this.toString):R([C],r,"concatenate",this.toNumber,this.toString),n=A(n)?R([L],n,"concatenate",this.toNumber,this.toString):R([C],n,"concatenate",this.toNumber,this.toString),this.applyOperator(r,n,"&")},UnionExpression:(t,e)=>{let r=this.visit(t.children[0],e);null===r&&(r=[null]);let n=this.visit(t.children[1],e);return null===n&&(n=[null]),r=R([B],r,"union",this.toNumber,this.toString),n=R([B],n,"union",this.toNumber,this.toString),r.concat(n)},SubtractExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return D(r,n),this.applyOperator(r,n,"-")},MultiplyExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return D(r,n),this.applyOperator(r,n,"*")},DivideExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return D(r,n),this.applyOperator(r,n,"/")},NotExpression:(t,e)=>!S(this.visit(t.children[0],e)),UnaryMinusExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=-1*r;if(Number.isNaN(n))throw i(`Failed to convert "${r}" to number`);return n},String:t=>t.value,Literal:t=>t.value,Number:t=>t.value,Integer:t=>t.value,[M]:(t,e)=>{const r=this.visit(t.children[0],e);return this.visit(t.children[1],r)},[j]:(t,e)=>e,[Y]:t=>{const e=this.globals[t.name];return void 0===e?null:e},Function:(t,e)=>{if("if"===t.name)return this.runtime.callFunction(t.name,t.children,e,this,!1);const r=t.children.map((t=>this.visit(t,e)));return this.runtime.callFunction(t.name,r,e,this)},ExpressionReference:t=>{const[e]=t.children;return e.jmespathType=k,e}}}visit(t,e=null){return(t&&this.visitFunctions[t.type])(t,e)}computeSliceParams(t,e){function r(t,e,r){let n=e;return n<0?(n+=t,n<0&&(n=r<0?-1:0)):n>=t&&(n=r<0?t-1:t),n}let[n,s,i]=e;if(null===i)i=1;else if(0===i)throw u("Invalid slice, step cannot be 0");const a=i<0;return n=null===n?a?t-1:0:r(t,n,i),s=null===s?a?-1:t:r(t,s,i),[n,s,i]}applyOperator(t,e,r){if(w(t)&&w(e)){const n=[];for(let s=0;s<t.length;s+=1)n.push(this.applyOperator(t[s],e[s],r));return n}if(w(t))return t.map((t=>this.applyOperator(t,e,r)));if(w(e))return e.map((e=>this.applyOperator(t,e,r)));if("&"===r)return t+e;if("*"===r)return this.toNumber(t)*this.toNumber(e);const n=this.toNumber(t),s=this.toNumber(e);if("+"===r)return n+s;if("-"===r)return n-s;const i=n/s;if(!Number.isFinite(i))throw u(`Division by zero ${t}/${e}`);return i}}const{TOK_IDENTIFIER:J,TOK_QUOTEDIDENTIFIER:G,TOK_RBRACKET:H,TOK_RPAREN:z,TOK_COMMA:V,TOK_COLON:X,TOK_CONCATENATE:Q,TOK_RBRACE:W,TOK_NUMBER:Z,TOK_CURRENT:tt,TOK_GLOBAL:et,TOK_EXPREF:rt,TOK_PIPE:nt,TOK_OR:st,TOK_COMPARATOR:it,TOK_AND:at,TOK_ADD:ot,TOK_SUBTRACT:ut,TOK_UNARY_MINUS:ct,TOK_DIVIDE:lt,TOK_UNION:ht,TOK_FLATTEN:pt,TOK_STAR:_t,TOK_FILTER:ft,TOK_DOT:dt,TOK_NOT:yt,TOK_LBRACE:gt,TOK_LBRACKET:mt,TOK_LPAREN:vt,TOK_JSON:Tt,TOK_STRING:Et,TOK_INT:Ot}=s,bt={".":dt,",":V,":":X,"{":gt,"}":W,"]":H,"(":vt,")":z,"@":tt},At={"<":!0,">":!0,"=":!0,"!":!0},Nt={" ":!0,"\t":!0,"\n":!0};function Rt(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"||t>="0"&&t<="9"||"_"===t}function wt(t,e){const r=t[e];return"$"===r||r>="a"&&r<="z"||r>="A"&&r<="Z"||"_"===r}class xt{constructor(t=[],e=[]){this._allowedGlobalNames=t,this.debug=e}tokenize(t){const e=[];let r,n,s;for(this._current=0;this._current<t.length;){const i=e.length?e.slice(-1)[0].type:null;if(this._isGlobal(i,t,this._current))e.push(this._consumeGlobal(t));else if(wt(t,this._current))r=this._current,n=this._consumeUnquotedIdentifier(t),e.push({type:J,value:n,start:r});else if(this._isNumber(t))s=this._consumeNumber(t),e.push(s);else if(void 0!==bt[t[this._current]])e.push({type:bt[t[this._current]],value:t[this._current],start:this._current}),this._current+=1;else if("-"!==t[this._current]||[et,tt,Z,Ot,z,J,G,H,Tt,Et].includes(i))if("["===t[this._current])s=this._consumeLBracket(t),e.push(s);else if("'"===t[this._current])r=this._current,n=this._consumeQuotedIdentifier(t),e.push({type:G,value:n,start:r});else if('"'===t[this._current])r=this._current,n=this._consumeRawStringLiteral(t),e.push({type:Et,value:n,start:r});else if("`"===t[this._current]){r=this._current;const n=this._consumeJson(t);e.push({type:Tt,value:n,start:r})}else if(void 0!==At[t[this._current]])e.push(this._consumeOperator(t));else if(void 0!==Nt[t[this._current]])this._current+=1;else if("&"===t[this._current])r=this._current,this._current+=1,"&"===t[this._current]?(this._current+=1,e.push({type:at,value:"&&",start:r})):i===V||i===vt?e.push({type:rt,value:"&",start:r}):e.push({type:Q,value:"&",start:r});else if("~"===t[this._current])r=this._current,this._current+=1,e.push({type:ht,value:"~",start:r});else if("+"===t[this._current])r=this._current,this._current+=1,e.push({type:ot,value:"+",start:r});else if("-"===t[this._current])r=this._current,this._current+=1,e.push({type:ut,value:"-",start:r});else if("*"===t[this._current])r=this._current,this._current+=1,e.push({type:_t,value:"*",start:r});else if("/"===t[this._current])r=this._current,this._current+=1,e.push({type:lt,value:"/",start:r});else{if("|"!==t[this._current])throw a(`Unknown character:${t[this._current]}`);r=this._current,this._current+=1,"|"===t[this._current]?(this._current+=1,e.push({type:st,value:"||",start:r})):e.push({type:nt,value:"|",start:r})}else s=this._consumeUnaryMinus(t),e.push(s)}return e}_consumeUnquotedIdentifier(t){const e=this._current;for(this._current+=1;this._current<t.length&&("$"===t[this._current]||Rt(t[this._current]));)this._current+=1;return t.slice(e,this._current)}_consumeQuotedIdentifier(t){const e=this._current;this._current+=1;const r=t.length;let n=!wt(t,e+1);for(;"'"!==t[this._current]&&this._current<r;){let e=this._current;Rt(t[e])||(n=!0),"\\"!==t[e]||"\\"!==t[e+1]&&"'"!==t[e+1]?e+=1:e+=2,this._current=e}this._current+=1;const s=t.slice(e,this._current);try{n||(this.debug.push(`Suspicious quotes: ${s}`),this.debug.push(`Did you intend a literal? "${s.replace(/'/g,"")}"?`))}catch(t){}return JSON.parse(`"${s.substring(1,s.length-1).replace(/\\'/g,"'")}"`)}_consumeRawStringLiteral(t){const e=this._current;this._current+=1;const r=t.length;for(;'"'!==t[this._current]&&this._current<r;){let e=this._current;"\\"!==t[e]||"\\"!==t[e+1]&&'"'!==t[e+1]?e+=1:e+=2,this._current=e}this._current+=1;const n=t.slice(e+1,this._current-1);if(this._current>r)throw a(`Unterminated string literal at ${e}, "${n}`);try{return JSON.parse(`"${n}"`)}catch(t){throw a(`Invalid string literal: ${n}`)}}_isNumber(t){let e=t[this._current];return e>="0"&&e<="9"||"."===e&&this._current!==t.length&&(e=t[this._current+1],e>="0"&&e<="9")}_consumeNumber(t){const e=this._current,r=t.slice(e),n=r.match(/^[0-9]*\.?[0-9]+(?:[eE][-+]?[0-9]+)?/);if(!n)throw a(`Invalid number: ${r}`);const s=n[0];let i;return this._current+=s.length,s.includes(".")||s.toLowerCase().includes("e")?(i=parseFloat(s),{type:Z,value:i,start:e}):(i=parseInt(s,10),{type:Ot,value:i,start:e})}_consumeUnaryMinus(){const t=this._current;return this._current+=1,{type:ct,value:"-",start:t}}_consumeLBracket(t){const e=this._current;return this._current+=1,"?"===t[this._current]?(this._current+=1,{type:ft,value:"[?",start:e}):"]"===t[this._current]?(this._current+=1,{type:pt,value:"[]",start:e}):{type:mt,value:"[",start:e}}_isGlobal(t,e,r){if(null!==t&&t===dt)return!1;if("$"!==e[r])return!1;let n=r+1;for(;n<e.length&&("$"===e[n]||Rt(e[n]));)n+=1;const s=e.slice(r,n);return this._allowedGlobalNames.includes(s)}_consumeGlobal(t){const e=this._current;for(this._current+=1;this._current<t.length&&("$"===t[this._current]||Rt(t[this._current]));)this._current+=1;const r=t.slice(e,this._current);return{type:et,name:r,start:e}}_consumeOperator(t){const e=this._current,r=t[e];return this._current+=1,"!"===r?"="===t[this._current]?(this._current+=1,{type:it,value:"!=",start:e}):{type:yt,value:"!",start:e}:"<"===r?"="===t[this._current]?(this._current+=1,{type:it,value:"<=",start:e}):">"===t[this._current]?(this._current+=1,{type:it,value:"!=",start:e}):{type:it,value:"<",start:e}:">"===r?"="===t[this._current]?(this._current+=1,{type:it,value:">=",start:e}):{type:it,value:">",start:e}:("="===t[this._current]&&(this._current+=1),{type:it,value:"==",start:e})}_consumeJson(t){this._current+=1;const e=this._current,r=t.length;for(;"`"!==t[this._current]&&this._current<r;){let e=this._current;"\\"===t[e]&&"`"===t[e+1]?e+=2:e+=1,this._current=e}let n=t.slice(e,this._current).trimStart();if(n=n.replaceAll("\\`","`"),this._current+=1,this._current>r)throw a(`Unterminated JSON literal at ${e}: \`${n}`);return JSON.parse(n)}}const{TOK_JSON:Pt,TOK_COLON:St,TOK_EOF:It,TOK_IDENTIFIER:$t,TOK_QUOTEDIDENTIFIER:Kt,TOK_RBRACKET:jt,TOK_RPAREN:Yt,TOK_COMMA:kt,TOK_CONCATENATE:Mt,TOK_RBRACE:Ft,TOK_NUMBER:Ct,TOK_CURRENT:Lt,TOK_GLOBAL:Bt,TOK_EXPREF:Ut,TOK_PIPE:Dt,TOK_OR:qt,TOK_AND:Jt,TOK_ADD:Gt,TOK_SUBTRACT:Ht,TOK_UNARY_MINUS:zt,TOK_MULTIPLY:Vt,TOK_DIVIDE:Xt,TOK_UNION:Qt,TOK_COMPARATOR:Wt,TOK_FLATTEN:Zt,TOK_STAR:te,TOK_FILTER:ee,TOK_DOT:re,TOK_NOT:ne,TOK_LBRACE:se,TOK_LBRACKET:ie,TOK_LPAREN:ae,TOK_STRING:oe,TOK_INT:ue}=s,ce={[It]:0,[$t]:0,[Kt]:0,[jt]:0,[Yt]:0,[kt]:0,[Ft]:0,[Ct]:0,[ue]:0,[Lt]:0,[Bt]:0,[Ut]:0,[Dt]:1,[qt]:2,[Jt]:3,[Wt]:4,[Mt]:5,[Gt]:6,[Ht]:6,[Qt]:6,[Vt]:7,[Xt]:7,[ne]:8,[zt]:8,[Zt]:10,[te]:20,[ee]:21,[re]:40,[se]:50,[ie]:55,[ae]:60};class le{constructor(t=[]){this._allowedGlobalNames=t}parse(t,e){this.debug=e,this._loadTokens(t),this.index=0;const r=this.expression(0);if(this._lookahead(0)!==It){const t=this._lookaheadToken(0);throw a(`Unexpected token type: ${t.type}, value: ${t.value}`)}return r}_loadTokens(t){const e=new xt(this._allowedGlobalNames,this.debug).tokenize(t);e.push({type:It,value:"",start:t.length}),this.tokens=e}expression(t){const e=this._lookaheadToken(0);this._advance();let r=this.nud(e),n=this._lookaheadToken(0,r);for(;t<ce[n.type];)this._advance(),r=this.led(n,r),n=this._lookaheadToken(0,r);return r}_lookahead(t){return this.tokens[this.index+t].type}_lookaheadToken(t,e={}){const r=this.tokens[this.index+t];return r.type===te&&([void 0,ie,re,Dt,Jt,qt,kt,ne,Vt,Gt,Ht,Xt,ae,Mt,Qt,Wt].includes(e.type)||(r.type=Vt)),r}_advance(){this.index+=1}_lookAheadIndex(){let t=0;return this._lookahead(t)===zt&&(t+=1),this._lookahead(t)===ue&&(t+=1),this._lookahead(t)===jt||this._lookahead(t)===St}_getIndex(){return this.index}_setIndex(t){this.index=t}nud(t){let e,r,n,s,i;switch(t.type){case oe:return{type:"String",value:t.value};case Pt:return{type:"Literal",value:t.value};case Ct:return{type:"Number",value:t.value};case ue:return{type:"Integer",value:t.value};case $t:return{type:"Identifier",name:t.value};case Kt:return s={type:"QuotedIdentifier",name:t.value},s;case ne:return r=this.expression(ce.Not),{type:"NotExpression",children:[r]};case zt:return r=this.expression(ce.UnaryMinus),{type:"UnaryMinusExpression",children:[r]};case te:return e={type:"Identity"},r=this._lookahead(0)===jt?{type:"Identity"}:this._parseProjectionRHS(ce.Star),{type:"ValueProjection",children:[e,r]};case ee:return this.led(t,{type:"Identity"});case se:return this._parseObjectExpression();case Zt:return e={type:Zt,children:[{type:"Identity"}]},r=this._parseProjectionRHS(ce.Flatten),{type:"Projection",children:[e,r]};case ie:return this._lookAheadIndex()?(r=this._parseIndexExpression(),this._projectIfSlice({type:"Identity"},r)):this._lookahead(0)===te&&this._lookahead(1)===jt?(this._advance(),this._advance(),r=this._parseProjectionRHS(ce.Star),{type:"Projection",children:[{type:"Identity"},r],debug:"Wildcard"}):this._parseArrayExpression();case Lt:return{type:Lt};case Bt:return{type:Bt,name:t.name};case Ut:return n=this.expression(ce.Expref),{type:"ExpressionReference",children:[n]};case ae:for(i=[];this._lookahead(0)!==Yt;)n=this.expression(0),i.push(n);return this._match(Yt),i[0];default:this._errorToken(t)}}led(t,e){let r,n,s,i,o,u,c,l;switch(t.type){case Mt:return n=this.expression(ce.Concatenate),{type:"ConcatenateExpression",children:[e,n]};case re:return u=ce.Dot,this._lookahead(0)!==te?(n=this._parseDotRHS(u),{type:"ChainedExpression",children:[e,n]}):(this._advance(),n=this._parseProjectionRHS(u),{type:"ValueProjection",children:[e,n]});case Dt:return n=this.expression(ce.Pipe),{type:Dt,children:[e,n]};case qt:return n=this.expression(ce.Or),{type:"OrExpression",children:[e,n]};case Jt:return n=this.expression(ce.And),{type:"AndExpression",children:[e,n]};case Gt:return n=this.expression(ce.Add),{type:"AddExpression",children:[e,n]};case Ht:return n=this.expression(ce.Subtract),{type:"SubtractExpression",children:[e,n]};case Vt:return n=this.expression(ce.Multiply),{type:"MultiplyExpression",children:[e,n]};case Xt:return n=this.expression(ce.Divide),{type:"DivideExpression",children:[e,n]};case Qt:return n=this.expression(ce.Union),{type:"UnionExpression",children:[e,n]};case ae:if(e.type!==$t)throw a("Bad function syntax. Parenthesis must be preceded by an unquoted identifier");return s=e.name,i=this._parseFunctionArgs(),o={type:"Function",name:s,children:i},o;case ee:return r=this.expression(0),this._match(jt),n=this._parseProjectionRHS(ce.Filter),{type:"FilterProjection",children:[e,n,r]};case Zt:return c={type:Zt,children:[e]},l=this._parseProjectionRHS(ce.Flatten),{type:"Projection",children:[c,l]};case Wt:return this._parseComparator(e,t);case ie:return this._lookahead(0)===te&&this._lookahead(1)===jt?(this._advance(),this._advance(),n=this._parseProjectionRHS(ce.Star),{type:"Projection",children:[e,n],debug:"Wildcard"}):(n=this._parseIndexExpression(),this._projectIfSlice(e,n));default:this._errorToken(t)}}_match(t){const e=this._lookaheadToken(0);if(e.type===t)return this._advance(),e;throw a(`Expected ${t}, got: ${e.type}`)}_errorToken(t){throw a(`Unexpected token (${t.type}): "${t.value||t.name}"`)}_parseFunctionArgs(){let t=!0;const e=[];for(;this._lookahead(0)!==Yt;)t||this._match(kt),e.push(this.expression(0)),t=!1;return this._match(Yt),e}_parseSignedInt(){const t=this._lookaheadToken(0);return t.type===zt?(this._advance(),{type:"SignedInt",value:-this._match(ue).value}):(t.type!==ue&&this._errorToken(t),this._advance(),{type:"SignedInt",value:t.value})}_parseIndexExpression(){const t=this._getIndex();if(this._lookahead(0)===St)return this._parseSliceExpression();const e=this._parseSignedInt();return this._lookahead(0)===St?(this._setIndex(t),this._parseSliceExpression()):(this._match(jt),{type:"Index",value:e})}_projectIfSlice(t,e){const r={type:"BracketExpression",children:[t,e]};return"Slice"===e.type?{type:"Projection",children:[r,this._parseProjectionRHS(ce.Star)]}:r}_parseSliceExpression(){const t=[null,null,null];let e=0,r=this._lookahead(0);for(;r!==jt&&e<3;){if(r===St&&e<2)e+=1,this._advance();else{t[e]=this._parseSignedInt();const r=this._lookahead(0);if(r!==St&&r!==jt)throw a(`Unexpected token: ${r.value}(${r.type})`)}r=this._lookahead(0)}return this._match(jt),{type:"Slice",children:t}}_parseComparator(t,e){const r=this.expression(ce[e.type]);return{type:"Comparator",value:e.value,children:[t,r]}}_parseDotRHS(t){const e=this._lookahead(0);if([$t,Kt,te].indexOf(e)>=0)return this.expression(t);if(e===ie)return this._match(ie),this._parseArrayExpression();if(e===se)return this._match(se),this._parseObjectExpression();throw a('Expecting one of: "*", "[", "{", name or quoted name after a dot')}_parseProjectionRHS(t){let e;const r=this._lookaheadToken(0,{type:te});if(ce[r.type]<=ce[Zt])e={type:"Identity"};else if(r.type===ie)e=this.expression(t);else if(r.type===ee)e=this.expression(t);else{if(r.type!==re)throw a(`Unexpected token: ${r.value}(${r.type})`);this._match(re),e=this._parseDotRHS(t)}return e}_parseArrayExpression(){const t=[];for(;this._lookahead(0)!==jt;){const e=this.expression(0);if(t.push(e),this._lookahead(0)===kt&&(this._match(kt),this._lookahead(0)===jt))throw a("Unexpected token Rbracket")}return this._match(jt),{type:"ArrayExpression",children:t}}_parseObjectExpression(){const t=[],e=[$t,Kt];let r,n,s,i;if(this._lookahead(0)===Ft)throw this.debug.push("To create an empty object, use a JSON literal: `{}`"),a("An empty object expression is not allowed");for(;;){if(r=this._lookaheadToken(0),e.indexOf(r.type)<0)throw a(`Expecting an identifier token, got: ${r.type}`);if(n=r.value,this._advance(),this._match(St),s=this.expression(0),i={type:"KeyValuePair",name:n,value:s},t.push(i),this._lookahead(0)===kt)this._match(kt);else if(this._lookahead(0)===Ft){this._match(Ft);break}}return{type:"ObjectExpression",children:t}}}const he=864e5;function pe(t){return new Date(Math.round(t*he))}function _e(t){return t/he}function fe(t,e){if(Number.isNaN(t)||!Number.isFinite(t))throw u(`Call to "${e}()" resulted in an invalid number`);return t}const{TYPE_OBJECT:de}=r;function ye(t){if(null==t)return"";const e=b(t);if(A(e))throw i("Failed to convert array to string");if(e===de)throw i("Failed to convert object to string");return t.toString()}const ge=t=>{const e=+t;return Number.isNaN(e)?0:e};class me{constructor(t,e,s={}){this.strictDeepEqual=I,this.toNumber=e,this.functionTable=function(t,e,s,a,c,l,h,p){const{TYPE_NUMBER:_,TYPE_ANY:f,TYPE_STRING:d,TYPE_ARRAY:y,TYPE_OBJECT:g,TYPE_BOOLEAN:m,TYPE_EXPREF:v,TYPE_NULL:T,TYPE_ARRAY_NUMBER:E,TYPE_ARRAY_STRING:O,TYPE_ARRAY_ARRAY:b}=r;function A(t){let e=l(t);return a(e)===d&&(e=s(e)),e=Math.trunc(t),Number.isNaN(e)?t:e}function N(t,e){const r=l(t);if(a(r)===d)return t;const n=e?A(e):0;return JSON.stringify(r,null,n)}function R(t,e){return t.some(Array.isArray)?function(t){const e=Math.max(...t.map((t=>Array.isArray(t)?t.length:0))),r=t.map((t=>Array.isArray(t)?t.concat(Array(e-t.length).fill(null)):Array(e).fill(t))),n=[];for(let t=0;t<e;t+=1){const e=[];for(let n=0;n<r.length;n+=1)e.push(r[n][t]);n.push(e)}return n}(t).map((t=>R(t,e))):e(...t)}function w(t,e,r){const n=h(r).toLowerCase(),s=pe(t),i=pe(e);if(i===s)return 0;if(i<s)throw o("end_date must be >= start_date in datedif()");if("d"===n)return Math.floor(_e(i-s));const a=i.getFullYear()-s.getFullYear();let u=i.getMonth()-s.getMonth();const c=i.getDate()-s.getDate();if("y"===n){let t=a;return u<0&&(t-=1),0===u&&c<0&&(t-=1),t}if("m"===n)return 12*a+u+(c<0?-1:0);if("ym"===n)return c<0&&(u-=1),u<=0&&a>0?12+u:u;if("yd"===n)return c<0&&(u-=1),u<0?i.setFullYear(s.getFullYear()+1):i.setFullYear(s.getFullYear()),Math.floor(_e(i-s));throw o(`Unrecognized unit parameter "${n}" for datedif()`)}function x(t,e){const r=l(t),n=l(e),s=Array.from(r).reverse();return Array.from(n).reverse().every(((t,e)=>t===s[e]))}function P(t,e){const r=pe(t),n=A(e);return _e(new Date(r.getFullYear(),r.getMonth()+n+1,0))}function j(t,e,r){const n=Array.from(h(t)),s=Array.from(h(e)),i=A(r);if(i<0)throw u("find() start position must be >= 0");if(0===n.length)return i>s.length?null:i;for(let t=i;t<s.length;t+=1)if(s.slice(t,t+n.length).every(((t,e)=>t===n[e])))return t;return null}function Y(t){const e=t=>`${t.charAt(0).toUpperCase()}${t.slice(1).toLowerCase()}`,r=h(t),n=r.match(/[\s\d\p{P}]+|[^\s\d\p{P}]+/gu);return null!==n?n.map((t=>e(t))).join(""):e(r)}function k(t,e){const r=h(t),n=A(e);if(n<0)throw u("rept() count must be greater than or equal to 0");return r.repeat(n)}function M(t,e,r=0){const n=h(t),s=h(e),i=A(r);if(i<0)throw o("search() startPos must be greater than or equal to 0");if(null===n||null===s||0===s.length)return[];const a=Array.from(n).reduce(((t,e)=>t.escape?{escape:!1,result:t.result.concat(e)}:"\\"===e?{escape:!0,result:t.result}:"?"===e?{escape:!1,result:t.result.concat("dot")}:"*"===e?"star"===t.result.slice(-1).pop()?t:{escape:!1,result:t.result.concat("star")}:{escape:!1,result:t.result.concat(e)}),{escape:!1,result:[]}).result,u=(t,e,r)=>{if(0===e.length)return r;if(0===t.length)return null;const n=t[0];let[s,...i]=e;const a="star"===s;if(a){if(1===e.length)return r;[s,...i]=e.slice(1)}return n===s||"dot"===s?u(t.slice(1),i,r.concat(n)):a?u(t.slice(1),e,r.concat(n)):null},c=Array.from(s);for(let t=i;t<c.length;t+=1){const e=u(c.slice(t),a,[]);if(null!==e)return[t,e.join("")]}return[]}function F(t,e){const r=h(t),n=h(e);return 0===n.length?Array.from(r):r.split(n)}function C(t,e){const r=Array.from(h(t)),n=Array.from(h(e));if(n.length>r.length)return!1;for(let t=0;t<n.length;t+=1)if(n[t]!==r[t])return!1;return!0}function L(t,e,r,n){const s=Array.from(h(t)),i=Array.from(h(e)),a=Array.from(h(r));if(0===i.length)return t;let o=!0,u=0;n>-1&&(o=!1,u=n+1);let c=0;const l=[];for(let t=0;t<s.length;){const e=i.every(((e,r)=>s[t+r]===e));e&&(c+=1),e&&(o||c===u)?(l.push(...a),t+=i.length):(l.push(s[t]),t+=1)}return l.join("")}function B(t,e){const r=A(e);return(t>=0?Math.floor:Math.ceil)(t*10**r)/10**r}function U(t,e){const r=pe(t).getDay();switch(A(e)){case 1:return r+1;case 2:return(r+6)%7+1;case 3:return(r+6)%7;default:throw o(`Unsupported returnType: "${e}" for weekday()`)}}const D={abs:{_func:t=>R(t,Math.abs),_signature:[{types:[_,E]}]},acos:{_func:t=>R(t,(t=>fe(Math.acos(t),"acos"))),_signature:[{types:[_,E]}]},and:{_func:t=>{let e=S(l(t[0]));return t.slice(1).forEach((t=>{e=e&&S(l(t))})),e},_signature:[{types:[f],variadic:!0}]},asin:{_func:t=>R(t,(t=>fe(Math.asin(t),"asin"))),_signature:[{types:[_,E]}]},atan2:{_func:t=>R(t,Math.atan2),_signature:[{types:[_,E]},{types:[_,E]}]},avg:{_func:t=>{let e=0;const r=t.flat(1/0).filter((t=>a(t)===_));if(0===r.length)throw u("avg() requires at least one argument");return r.forEach((t=>{e+=t})),e/r.length},_signature:[{types:[y]}]},avgA:{_func:t=>{let e,r=0;try{e=t.flat(1/0).filter((t=>a(t)!==T)).map(s)}catch(t){throw i("avgA() received non-numeric parameters")}if(0===e.length)throw u("avg() requires at least one argument");return e.forEach((t=>{r+=t})),r/e.length},_signature:[{types:[y]}]},casefold:{_func:(t,e,r)=>R(t,(t=>h(t).toLocaleUpperCase(r.language).toLocaleLowerCase(r.language))),_signature:[{types:[d,O]}]},ceil:{_func:t=>R(t,Math.ceil),_signature:[{types:[_,E]}]},codePoint:{_func:t=>R(t,(t=>{const e=h(t);return 0===e.length?null:e.codePointAt(0)})),_signature:[{types:[d,O]}]},contains:{_func:t=>{const e=l(t[0]),r=l(t[1]);if(c(t[0]))return e.some((t=>I(t,r)));const n=Array.from(e);if(a(r)!==d)throw i("contains() requires a string search value for string subjects");if(""===r)return!0;const s=Array.from(r).length;for(let t=0;t<n.length;t+=1)if(n.slice(t,t+s).join("")===r)return!0;return!1},_signature:[{types:[d,y]},{types:[f]}]},cos:{_func:t=>R(t,Math.cos),_signature:[{types:[_,E]}]},datedif:{_func:t=>R(t,w),_signature:[{types:[_,E]},{types:[_,E]},{types:[d,O]}]},datetime:{_func:t=>{const e=A(t[0]),r=A(t[1])-1,n=A(t[2]),s=t.length>3?A(t[3]):0,i=t.length>4?A(t[4]):0,a=t.length>5?A(t[5]):0,o=t.length>6?A(t[6]):0;return _e(new Date(e,r,n,s,i,a,o))},_signature:[{types:[_]},{types:[_]},{types:[_]},{types:[_],optional:!0},{types:[_],optional:!0},{types:[_],optional:!0},{types:[_],optional:!0}]},day:{_func:t=>R(t,(t=>pe(t).getDate())),_signature:[{types:[_,E]}]},debug:{_func:e=>{const r=e[0];return e.length>1?a(e[1])===v?p.push(t.interpreter.visit(e[1],r)):p.push(e[1]):p.push(N(e[0])),r},_signature:[{types:[f]},{types:[f,v],optional:!0}]},deepScan:{_func:t=>{const[r,n]=t,[s,i]=a(n)===_?[A(n),!0]:[h(n),!1],o=[];return function t(r){null!==r&&(c(r)?(i&&void 0!==r[s]&&o.push(r[s]),r.forEach(t)):e(r)&&Object.entries(r).forEach((([e,r])=>{i||e!==s||o.push(r),t(r)})))}(r),o},_signature:[{types:[g,y,T]},{types:[d,_]}]},endsWith:{_func:t=>R(t,x),_signature:[{types:[d,O]},{types:[d,O]}]},entries:{_func:t=>{const e=l(t[0]);return Object.entries(e)},_signature:[{types:[y,g]}]},eomonth:{_func:t=>R(t,P),_signature:[{types:[_,E]},{types:[_,E]}]},exp:{_func:t=>R(t,Math.exp),_signature:[{types:[_,E]}]},false:{_func:()=>!1,_signature:[]},find:{_func:t=>{const e=t.slice();return e.length<3&&e.push(0),R(e,j)},_signature:[{types:[d,O]},{types:[d,O]},{types:[_,E],optional:!0}]},floor:{_func:t=>R(t,Math.floor),_signature:[{types:[_,E]}]},fromCodePoint:{_func:t=>{try{const e=Array.isArray(t[0])?t[0]:[t[0]];return String.fromCodePoint(...e.map(A))}catch(e){throw u(`Invalid code point: "${t[0]}"`)}},_signature:[{types:[_,E]}]},fromEntries:{_func:t=>{const e=t[0];if(!e.every((t=>!!Array.isArray(t)&&2===t.length&&a(t[0])===d)))throw i("fromEntries() requires an array of key value pairs");return Object.fromEntries(e)},_signature:[{types:[b,O,E]}]},fround:{_func:t=>R(t,Math.fround),_signature:[{types:[_,E]}]},hasProperty:{_func:t=>{let e=t[1];const r=a(e);if(null!==t[0]&&Object.getOwnPropertyDescriptor(t[0],e)?.get)return!0;const n=l(t[0]);if(null===n)return!1;const s=c(n);if(!s&&a(n)!==g)throw i("First parameter to hasProperty() must be either an object or array.");if(s){if(r!==_)throw TypeError("hasProperty(): Array index must be an integer");e=A(e)}else if(r!==d)throw TypeError("hasProperty(): Object key must be a string");return void 0!==$(n,e)},_signature:[{types:[f]},{types:[d,_]}]},hour:{_func:t=>R(t,(t=>pe(t).getHours())),_signature:[{types:[_,E]}]},if:{_func:(t,e,r)=>{const n=t[0],s=t[1],a=t[2];t.forEach((t=>{if("ExpressionReference"===t.type)throw i('"if()" does not accept an expression reference argument.')}));const o=r.visit(n,e);return S(l(o))?r.visit(s,e):r.visit(a,e)},_signature:[{types:[f]},{types:[f]},{types:[f]}]},join:{_func:t=>{const e=t[0],r=t[1];return e.map((t=>N(t))).join(r)},_signature:[{types:[y]},{types:[d]}]},keys:{_func:t=>Object.keys(t[0]),_signature:[{types:[g]}]},left:{_func:t=>{const e=t.length>1?A(t[1]):1;if(e<0)throw u("left() requires a non-negative number of elements");return c(t[0])?t[0].slice(0,e):Array.from(h(t[0])).slice(0,e).join("")},_signature:[{types:[d,y]},{types:[_],optional:!0}]},length:{_func:t=>{const r=l(t[0]);return e(r)?Object.keys(r).length:c(r)?r.length:Array.from(h(r)).length},_signature:[{types:[d,y,g]}]},log:{_func:t=>R(t,(t=>fe(Math.log(t),"log"))),_signature:[{types:[_,E]}]},log10:{_func:t=>R(t,(t=>fe(Math.log10(t),"log10"))),_signature:[{types:[_,E]}]},lower:{_func:t=>R(t,(t=>h(t).toLowerCase())),_signature:[{types:[d,O]}]},map:{_func:e=>{const r=e[1];return e[0].map((e=>t.interpreter.visit(r,e)))},_signature:[{types:[y]},{types:[v]}]},max:{_func:t=>{const e=t.flat(1/0).filter((t=>"number"==typeof l(t)));return 0===e.length?0:Math.max(...e)},_signature:[{types:[y,f],variadic:!0}]},maxA:{_func:t=>{const e=t.flat(1/0).filter((t=>null!==l(t))).map(s);if(e.find((t=>null===t)))throw u("maxA() received non-numeric parameters");return 0===e.length?0:Math.max(...e)},_signature:[{types:[y,f],variadic:!0}]},merge:{_func:t=>{const e={};return t.forEach((t=>{null!==t&&Object.entries(t||{}).forEach((([t,r])=>{e[t]=r}))})),e},_signature:[{types:[g,T],variadic:!0}]},mid:{_func:t=>{const e=A(t[1]),r=A(t[2]);if(e<0)throw u("mid() requires a non-negative start position");if(r<0)throw u("mid() requires a non-negative length parameter");return c(t[0])?t[0].slice(e,e+r):Array.from(h(t[0])).slice(e,e+r).join("")},_signature:[{types:[d,y]},{types:[_]},{types:[_]}]},millisecond:{_func:t=>R(t,(t=>pe(t).getMilliseconds())),_signature:[{types:[_,E]}]},min:{_func:t=>{const e=t.flat(1/0).filter((t=>"number"==typeof l(t)));return 0===e.length?0:Math.min(...e)},_signature:[{types:[y,f],variadic:!0}]},minA:{_func:t=>{const e=t.flat(1/0).filter((t=>null!==l(t))).map(s);if(e.find((t=>null===t)))throw u("minA() received non-numeric parameters");return 0===e.length?0:Math.min(...e)},_signature:[{types:[y,f],variadic:!0}]},minute:{_func:t=>R(t,(t=>pe(t).getMinutes())),_signature:[{types:[_,E]}]},mod:{_func:t=>R(t,((t,e)=>{const r=t%e;if(Number.isNaN(r))throw u(`Bad parameter for mod: '${t} % ${e}'`);return r})),_signature:[{types:[_,E]},{types:[_,E]}]},month:{_func:t=>R(t,(t=>pe(t).getMonth()+1)),_signature:[{types:[_,E]}]},not:{_func:t=>!S(l(t[0])),_signature:[{types:[f]}]},notNull:{_func:t=>{const e=t.find((t=>a(t)!==T));return void 0===e?null:e},_signature:[{types:[f],variadic:!0}]},now:{_func:()=>_e(Date.now()),_signature:[]},null:{_func:()=>null,_signature:[]},or:{_func:t=>{let e=S(l(t[0]));return t.slice(1).forEach((t=>{e=e||S(l(t))})),e},_signature:[{types:[f],variadic:!0}]},power:{_func:t=>R(t,((t,e)=>fe(t**e,"power"))),_signature:[{types:[_,E]},{types:[_,E]}]},proper:{_func:t=>R(t,Y),_signature:[{types:[d,O]}]},random:{_func:()=>Math.random(),_signature:[]},reduce:{_func:e=>{const r=e[1];return e[0].reduce(((e,n,s,i)=>t.interpreter.visit(r,{accumulated:e,current:n,index:s,array:i})),3===e.length?e[2]:null)},_signature:[{types:[y]},{types:[v]},{types:[f],optional:!0}]},register:{_func:e=>{const r=e[0],n=e[1];if(!/^[_A-Z][_a-zA-Z0-9$]*$/.test(r))throw o(`Invalid function name: "${r}"`);if(D[r]&&D[r]._exprefNode.value!==n.value)throw o(`Cannot override function: "${r}" with a different definition`);return D[r]={_func:e=>t.interpreter.visit(n,...e),_signature:[{types:[f],optional:!0}],_exprefNode:n},{}},_signature:[{types:[d]},{types:[v]}]},registerWithParams:{_func:e=>{const r=e[0],n=e[1];if(!/^[_A-Z][_a-zA-Z0-9$]*$/.test(r))throw o(`Invalid function name: "${r}"`);if(D[r]&&D[r]._exprefNode.value!==n.value)throw o(`Cannot override function: "${r}" with a different definition`);return D[r]={_func:e=>t.interpreter.visit(n,e),_signature:[{types:[f],optional:!0,variadic:!0}],_exprefNode:n},{}},_signature:[{types:[d]},{types:[v]}]},replace:{_func:t=>{const e=A(t[1]),r=A(t[2]);if(e<0)throw u("replace() start position must be greater than or equal to 0");if(r<0)throw u("replace() length must be greater than or equal to 0");if(c(t[0])){const n=l(t[0]);let s=l(t[3]);return c(s)||(s=[s]),n.splice(e,r,...s),n}const n=Array.from(h(t[0]));if(c(t[3])||a(t[3])===g)throw i("replace() replacement must not be an array or object");const s=h(t[3]);return n.splice(e,r,s),n.join("")},_signature:[{types:[d,y]},{types:[_]},{types:[_]},{types:[f]}]},rept:{_func:t=>R(t,k),_signature:[{types:[d,O]},{types:[_,E]}]},reverse:{_func:t=>{const e=l(t[0]);return a(e)===d?Array.from(e).reverse().join(""):t[0].slice(0).reverse()},_signature:[{types:[d,y]}]},right:{_func:t=>{const e=t.length>1?A(t[1]):1;if(e<0)throw u("right() count must be greater than or equal to 0");return t[0]instanceof Array?0===e?[]:t[0].slice(-1*e):0===e?"":Array.from(h(t[0])).slice(-1*e).join("")},_signature:[{types:[d,y]},{types:[_],optional:!0}]},round:{_func:t=>{const e=t.slice();return e.length<2&&e.push(0),R(e,((t,e)=>function(t,e){const r=10**e;return Math.round(t*r)/r}(t,A(e))))},_signature:[{types:[_,E]},{types:[_,E],optional:!0}]},search:{_func:t=>{const e=t.slice();return e.length<2&&e.push(0),R(e,M)},_signature:[{types:[d,O]},{types:[d,O]},{types:[_,E],optional:!0}]},second:{_func:t=>R(t,(t=>pe(t).getSeconds())),_signature:[{types:[_,E]}]},sign:{_func:t=>R(t,Math.sign),_signature:[{types:[_,E]}]},sin:{_func:t=>R(t,Math.sin),_signature:[{types:[_,E]}]},sort:{_func:t=>{const e=t[0].map((t=>{const e=a(t);if(![_,d,m,T].includes(e))throw u("Bad datatype for sort");return{type:e,value:t}})),r=e.filter((t=>t.type===_)).map((t=>t.value)).sort(((t,e)=>t<e?-1:t>e?1:0));return r.push(...e.filter((t=>t.type===d)).map((t=>t.value)).sort()),r.push(...e.filter((t=>t.type===m)).map((t=>t.value))),r.push(...e.filter((t=>t.type===T)).map((t=>t.value))),r},_signature:[{types:[y]}]},sortBy:{_func:e=>{const r=e[0].slice(0);if(0===r.length)return r;const s=e[1],o=a(t.interpreter.visit(s,r[0]));if(![_,d].includes(o))throw i("Bad data type for sortBy()");const u=[];for(let t=0;t<r.length;t+=1)u.push([t,r[t]]);u.sort(((e,r)=>{const u=t.interpreter.visit(s,e[1]),c=a(u),l=t.interpreter.visit(s,r[1]),h=a(l);if(c!==o)throw i(`sortBy expected ${n[o]}, received ${n[c]}`);if(h!==o)throw i(`sortyBy expected ${n[o]}, received ${n[h]}`);return u>l?1:u<l?-1:e[0]-r[0]}));for(let t=0;t<u.length;t+=1)[,r[t]]=u[t];return r},_signature:[{types:[y]},{types:[v]}]},split:{_func:t=>R(t,F),_signature:[{types:[d,O]},{types:[d,O]}]},sqrt:{_func:t=>R(t,(t=>fe(Math.sqrt(t),"sqrt"))),_signature:[{types:[_,E]}]},startsWith:{_func:t=>R(t,C),_signature:[{types:[d,O]},{types:[d,O]}]},stdev:{_func:t=>{const e=t.flat(1/0).filter((t=>a(t)===_));if(e.length<=1)throw u("stdev() must have at least two values");const r=e.reduce(((t,e)=>t+e),0)/e.length,n=e.reduce(((t,e)=>t+e*e),0);return fe(Math.sqrt((n-e.length*r*r)/(e.length-1)),"stdev")},_signature:[{types:[y]}]},stdevA:{_func:t=>{let e;try{e=t.flat(1/0).filter((t=>a(t)!==T)).map(s)}catch(t){throw u("stdevA() received non-numeric parameters")}if(e.length<=1)throw u("stdevA() must have at least two values");const r=e.reduce(((t,e)=>t+e),0)/e.length,n=e.reduce(((t,e)=>t+e*e),0);return fe(Math.sqrt((n-e.length*r*r)/(e.length-1)),"stdevA")},_signature:[{types:[y]}]},stdevp:{_func:t=>{const e=t[0].flat(1/0).filter((t=>a(t)===_));if(0===e.length)throw u("stdevp() must have at least one value");const r=e.reduce(((t,e)=>t+e),0)/e.length,n=e.reduce(((t,e)=>t+e*e),0)/e.length;return fe(Math.sqrt(n-r*r),"stdevp")},_signature:[{types:[y]}]},stdevpA:{_func:t=>{const e=t[0].flat(1/0).filter((t=>a(t)!==T)).map(s);if(0===e.length)throw u("stdevp() must have at least one value");const r=e.reduce(((t,e)=>t+e),0)/e.length,n=e.reduce(((t,e)=>t+e*e),0)/e.length;return fe(Math.sqrt(n-r*r),"stdevp")},_signature:[{types:[y]}]},substitute:{_func:t=>{const e=t.slice();let r;if(e.length>3){if(Array.isArray(e[3])){if(r=e[3].map(A),void 0!==r.find((t=>t<0)))throw u("substitute() which parameter must be greater than or equal to 0")}else if(r=A(e[3]),r<0)throw u("substitute() which parameter must be greater than or equal to 0");e[3]=r}return R(e,L)},_signature:[{types:[d,O]},{types:[d,O]},{types:[d,O]},{types:[_,E],optional:!0}]},sum:{_func:t=>{let e=0;return t[0].flat(1/0).filter((t=>a(t)===_)).forEach((t=>{e+=1*t})),e},_signature:[{types:[y]}]},tan:{_func:t=>R(t,Math.tan),_signature:[{types:[_,E]}]},time:{_func:t=>{const e=A(t[0]),r=t.length>1?A(t[1]):0,n=t.length>2?A(t[2]):0;return _e(new Date(1970,0,1,e,r,n))},_signature:[{types:[_]},{types:[_],optional:!0},{types:[_],optional:!0}]},toArray:{_func:t=>c(t[0])?t[0]:[t[0]],_signature:[{types:[f]}]},toDate:{_func:t=>{const e=h(t[0]).replace(/(\d\d\d\d)(\d\d)(\d\d)/,"$1-$2-$3").replace(/T(\d\d)(\d\d)(\d\d)/,"T$1:$2:$3"),r=e.split(/[\D,zZ]+/);let n;if(r.length<=3&&(r.length<3||""===r.find((t=>""===t))))return p.push(`Failed to convert "${t[0]}" to a date`),null;if(r.length<7){const e=[99999,12,31,23,59,59,999];for(let n=0;n<r.length;n+=1)if(r[n]>e[n])return p.push(`Failed to convert "${t[0]}" to a date`),null;n=new Date(...r.map(((t,e)=>1===e?t-1:1*t)))}else n=new Date(e);return n instanceof Date&&Number.isFinite(n.getTime())?_e(n):(p.push(`Failed to convert "${t[0]}" to a date`),null)},_signature:[{types:[d]}]},today:{_func:()=>{const t=new Date(Date.now());return _e(new Date(t.getFullYear(),t.getMonth(),t.getDate()))},_signature:[]},toNumber:{_func:t=>{let e=10;return t.length>1&&(e=Array.isArray(t[1])?t.map(A):A(t[1])),R([t[0],e],((t,e)=>{const r=l(t);if(a(r)===d&&10!==e){let t;if(2===e)t=/^\s*(\+|-)?[01.]+\s*$/;else if(8===e)t=/^\s*(\+|-)?[0-7.]+\s*$/;else{if(16!==e)throw u(`Invalid base: "${e}" for toNumber()`);t=/^\s*(\+|-)?[0-9A-Fa-f.]+\s*$/}if(""===r)return 0;if(!t.test(r))return p.push(`Failed to convert "${r}" base "${e}" to number`),null;const n=r.split(".").map((t=>t.trim()));let s=0;n.length>1&&(s=parseInt(n[1],e)*e**-n[1].length);const i=parseInt(n[0],e)+s;return n.length>2||Number.isNaN(i)?(p.push(`Failed to convert "${r}" base "${e}" to number`),null):i}try{return s(r)}catch(t){const e=t=>{const e=N(t);return e.length>50?`${e.substring(0,20)} ...`:e};return p.push(`Failed to convert "${e(r)}" to number`),null}}))},_signature:[{types:[f]},{types:[_,E],optional:!0}]},toString:{_func:t=>N(t[0],t.length>1?t[1]:0),_signature:[{types:[f]},{types:[_],optional:!0}]},trim:{_func:t=>R(t,(t=>h(t).split(" ").filter((t=>t)).join(" "))),_signature:[{types:[d,O]}]},true:{_func:()=>!0,_signature:[]},trunc:{_func:t=>{const e=t.slice();return e.length<2&&e.push(0),R(e,B)},_signature:[{types:[_,E]},{types:[_,E],optional:!0}]},type:{_func:t=>({[_]:"number",[d]:"string",[y]:"array",[E]:"array",[O]:"array",[b]:"array",[g]:"object",[m]:"boolean",[v]:"expref",[T]:"null"}[a(t[0])]),_signature:[{types:[f]}]},unique:{_func:t=>{const e=t[0].map((t=>l(t)));return t[0].filter(((t,r)=>e.findIndex((e=>I(e,l(t))))===r))},_signature:[{types:[y]}]},upper:{_func:t=>R(t,(t=>h(t).toUpperCase())),_signature:[{types:[d,O]}]},value:{_func:t=>{const e=a(t[1]);let r=t[1];const n=c(t[0]);if(null!==t[0]&&Object.getOwnPropertyDescriptor(t[0],r)?.get)return $(t[0],r);const s=l(t[0]);if(null===s)return null;if(a(s)!==g&&!n)throw i("First parameter to value() must be one of: object, array, null.");if(n){if(e!==_)throw i("value() requires an integer index for arrays");r=A(r)}else if(e!==d)throw i("value() requires a string index for objects");const o=$(t[0],r);return void 0===o?(n?p.push(`Index: ${r} out of range for array size: ${s.length}`):K(p,s,r),null):o},_signature:[{types:[f]},{types:[d,_]}]},values:{_func:t=>Object.values(t[0]),_signature:[{types:[g]}]},weekday:{_func:t=>{const e=t.slice();return e.length<2&&e.push(1),R(e,U)},_signature:[{types:[_,E]},{types:[_],optional:!0}]},year:{_func:t=>R(t,(t=>pe(t).getFullYear())),_signature:[{types:[_,E]}]},zip:{_func:t=>{const e=t.reduce(((t,e)=>Math.min(t,e.length)),t[0].length),r=new Array(e);for(let n=0;n<e;n+=1)r[n]=[],t.forEach((t=>{r[n].push(t[n])}));return r},_signature:[{types:[y],variadic:!0}]}};return D}(this,x,e,b,A,P,ye,t),Object.entries(s).forEach((([t,e])=>{e._runtime=this,this.functionTable[t]=e}))}_validateArgs(t,e,r,n){if(0===r.length&&e.length>0)throw o(`${t}() does not accept parameters`);if(0===r.length)return;let s;const i=r.filter((t=>!t.optional)).length,a=r[r.length-1];if(a.variadic){if(e.length<r.length&&!a.optional)throw s=1===r.length?" argument":" arguments",o(`${t}() takes at least ${r.length}${s} but received ${e.length}`)}else if(e.length<i||e.length>r.length)throw s=1===r.length?" argument":" arguments",o(`${t}() takes ${r.length}${s} but received ${e.length}`);if(!n)return;let u;const c=r[r.length-1].variadic?e.length:Math.min(r.length,e.length);for(let n=0;n<c;n+=1)u=n>r.length-1?r[r.length-1].types:r[n].types,e[n]=R(u,e[n],t,this.toNumber,ye)}callFunction(t,e,r,n,s=!0){if(!Object.prototype.hasOwnProperty.call(this.functionTable,t))throw o(`No such function: ${t}()`);const i=this.functionTable[t];return this._validateArgs(t,e,i._signature,s),i._func.call(this,e,r,n)}}class ve{constructor(t,e,r){this.debug=t,this.toNumber=function(t){return e=>{const r=P(e);if(null===r)return 0;if(r instanceof Array)throw i("Failed to convert array to number");const n=typeof r;if("number"===n)return r;if("string"===n)return t(r);if("boolean"===n)return r?1:0;throw i("Failed to convert object to number")}}(r||ge),this.runtime=new me(t,this.toNumber,e)}compile(t,e=[]){return new le(e).parse(t,this.debug)}search(t,e,r={},n="en-US"){this.runtime.interpreter=new q(this.runtime,r,this.toNumber,ye,this.debug,n);try{return this.runtime.interpreter.search(t,e)}catch(t){if(this.debug.push(t.message||t.toString()),"Error"===t.name)throw u(t.message||t.toString());throw t}}}const Te=class{constructor(t={},e=null,r=[]){this.customFunctions={...t},this.stringToNumber=e,this.debug=r,this.formula=new ve(r,t,e)}search(t,e,r={},n="en-US"){const s=this.compile(t,Object.keys(r));return this.run(s,e,n,r)}run(t,e,r,n){return this.formula.search(t,e,n,r)}compile(t,e=[]){return this.debug.length=0,this.formula.compile(t,e)}};class Ee extends Array{}class Oe{}function be(t,e,r,n){const s=e?new class extends Oe{_add(t,e){this[t]=e,n.push(e)}}:new class extends Ee{_add(t,e){this[t]=e,n.push(e)}};return Object.defineProperty(s,"$name",{get:()=>t}),Object.defineProperty(s,"$fields",{get:()=>r}),Object.defineProperty(s,"$value",{get:()=>s.valueOf()}),s}function Ae(t,e,r){const n=[];if(r instanceof Array)t._add(e,be(e,!1,n,[])),r.forEach(((r,s)=>{const i=Ae(t[e],s,r);n.push(...i)}));else if(null!==r&&"object"==typeof r)t._add(e,be(e,!0,n,[])),Object.keys(r).forEach((s=>{const i=Ae(t[e],s,r[s]);n.push(...i)}));else{const s=function(t,e,r=!1,n=!0){const s=new class extends Oe{valueOf(){return e}toString(){return e.toString()}toJSON(){return e}};return Object.defineProperty(s,"$name",{get:()=>t}),Object.defineProperty(s,"$value",{get:()=>e}),Object.defineProperty(s,"$readonly",{get:()=>r}),Object.defineProperty(s,"$required",{get:()=>n}),s}(e,r);t._add(e,s),n.push(s)}return n}function Ne(t){if(!/^\s*(-|\+)?(\d*)(\.\d+)?(e(\+|-)?\d+)?\s*$/i.test(t))throw i(`Failed to convert "${t}" to number`);const e=+t;if(Number.isNaN(e))throw i(`Failed to convert "${t}" to number`);return e}window.addEventListener("load",(()=>{const t=document.getElementById("data"),e=document.getElementById("expression"),r=document.getElementById("result"),n=document.getElementById("debug"),s=[],i=new Te({},Ne,s),a='{\n    "address": {\n      "street": "12 Oak St",\n      "city": "San Jose",\n      "state": "CA",\n      "country": "USA",\n      "phone": "1234561234"\n    },\n    "items": [\n      {\n        "desc": "pens",\n        "quantity": 2,\n        "price": 3.23\n      },\n      {\n        "desc": "pencils",\n        "quantity": 3,\n        "price": 1.34\n      }\n    ],\n    "tax": 1.13\n  }',o=new URLSearchParams(document.location.search);if(o.has("sample")){const r=JSON.parse(atob(o.get("sample")));r.data&&(t.value=JSON.stringify(r.data,null,2)),r.expression&&(e.value=r.expression),r.description&&(document.getElementById("description-row").style.display="table-row",document.getElementById("description").innerText=r.description),Array.from(document.getElementsByClassName("controls")).forEach((t=>t.classList.add("hidden")))}else{const r=window.localStorage.getItem("data");t.value=r||a;const n=window.localStorage.getItem("expression");e.value=n||"sum(items[*].price * items[*].quantity)"}function u(){window.localStorage.setItem("data",t.value),window.localStorage.setItem("expression",e.value);const a=e.value,o=document.getElementById("use-fields").checked;let u;try{u=JSON.parse(t.value),o&&(u=function(t){if(null===t||"object"!=typeof t)return t;const e=[],r=be("",!Array.isArray(t),e,[]);return Object.entries(t).forEach((([t,n])=>{e.push(...Ae(r,t,n))})),r}(u))}catch(t){return void(r.value=t.toString())}try{const t=i.search(a,u,{});n.innerHTML=s.join("\n");let e=t;null!=t&&(e=t.valueOf.call(t)),r.value="object"==typeof e?JSON.stringify(e,null,2):e}catch(t){r.value=t.toString(),n.innerHTML=s.join("\n")}}t.addEventListener("blur",u),e.addEventListener("blur",u),document.getElementById("data-reset").addEventListener("click",(()=>{t.value=a,o.has("sample")&&(e.value="sum(items[*].price * items[*].quantity)",document.getElementById("description-row").style.display="none",Array.from(document.getElementsByClassName("controls")).forEach((t=>t.classList.remove("hidden"))),window.history.pushState({},document.title,"/"),u())})),document.getElementById("canned").addEventListener("change",(t=>{e.value=t.target.value,u()})),u(),fetch("../antlr/JsonFormula.g4").then((t=>{t.text().then((t=>{const e=t.replace(/[\s\S.]*grammar/m,"grammar").replace(/#.*/g,"");document.getElementById("grammar-out").innerHTML=e}))}))}))})(),jsonFormula=e})();
//# sourceMappingURL=tutorial.js.map