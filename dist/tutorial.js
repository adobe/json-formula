var JSONFormula;(()=>{"use strict";var t={};(t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})})(t);const e={TYPE_NUMBER:0,TYPE_ANY:1,TYPE_STRING:2,TYPE_ARRAY:3,TYPE_OBJECT:4,TYPE_BOOLEAN:5,TYPE_EXPREF:6,TYPE_NULL:7,TYPE_ARRAY_NUMBER:8,TYPE_ARRAY_STRING:9,TYPE_CLASS:10,TYPE_ARRAY_ARRAY:11},r={TOK_EOF:"EOF",TOK_UNQUOTEDIDENTIFIER:"UnquotedIdentifier",TOK_QUOTEDIDENTIFIER:"QuotedIdentifier",TOK_RBRACKET:"Rbracket",TOK_RPAREN:"Rparen",TOK_COMMA:"Comma",TOK_COLON:"Colon",TOK_CONCATENATE:"Concatenate",TOK_RBRACE:"Rbrace",TOK_NUMBER:"Number",TOK_CURRENT:"Current",TOK_GLOBAL:"Global",TOK_FIELD:"Field",TOK_EXPREF:"Expref",TOK_PIPE:"Pipe",TOK_OR:"Or",TOK_AND:"And",TOK_ADD:"Add",TOK_SUBTRACT:"Subtract",TOK_UNARY_MINUS:"UnaryMinus",TOK_MULTIPLY:"Multiply",TOK_POWER:"Power",TOK_UNION:"Union",TOK_DIVIDE:"Divide",TOK_EQ:"EQ",TOK_GT:"GT",TOK_LT:"LT",TOK_GTE:"GTE",TOK_LTE:"LTE",TOK_NE:"NE",TOK_FLATTEN:"Flatten",TOK_STAR:"Star",TOK_FILTER:"Filter",TOK_DOT:"Dot",TOK_NOT:"Not",TOK_LBRACE:"Lbrace",TOK_LBRACKET:"Lbracket",TOK_LPAREN:"Lparen",TOK_LITERAL:"Literal"},{TYPE_NUMBER:n,TYPE_ANY:s,TYPE_STRING:i,TYPE_ARRAY:u,TYPE_OBJECT:o,TYPE_BOOLEAN:c,TYPE_EXPREF:a,TYPE_NULL:l,TYPE_ARRAY_NUMBER:h,TYPE_ARRAY_STRING:_,TYPE_CLASS:p,TYPE_ARRAY_ARRAY:d}=e,{TOK_EXPREF:E}=r,T={[n]:"number",[s]:"any",[i]:"string",[u]:"array",[o]:"object",[c]:"boolean",[a]:"expression",[l]:"null",[h]:"Array<number>",[_]:"Array<string>",[p]:"class",[d]:"Array<array>"};function f(t,e=!0){if(null===t)return l;let r=t;if(e){if("function"!=typeof t.valueOf)return o;r=t.valueOf.call(t)}switch(Object.prototype.toString.call(r)){case"[object String]":return i;case"[object Number]":return n;case"[object Array]":return u;case"[object Boolean]":return c;case"[object Null]":return l;case"[object Object]":return r.jmespathType===E?a:o;default:return o}}function y(t){return[f(t),f(t,!1)]}function g(t,e,r,a,E,f){const O=t[0];if(-1!==e.findIndex((t=>t===s||O===t)))return r;let R=!1;if((O===o||1===e.length&&e[0]===p)&&(R=!0),O===u&&1===e.length&&e[0]===o&&(R=!0),e.includes(d)){if(O===u&&(r.forEach((t=>{t instanceof Array||(R=!0)})),!R))return r;R=!0}if(R)throw new Error(`TypeError: ${a} expected argument to be type ${T[e[0]]} but received type ${T[O]} instead.`);let N=-1;if(O===u&&e.includes(_)&&e.includes(h)&&(N=r.length>0&&"string"==typeof r[0]?_:h),-1===N&&[_,h,u].includes(O)&&(N=e.find((t=>[_,h,u].includes(t)))),-1===N&&([N]=e),N===s)return r;if(N===_||N===h||N===u){if(N===u)return O===h||O===_?r:null===r?[]:[r];const e=N===h?n:i;if(O===u){const t=r.slice();for(let r=0;r<t.length;r+=1){const n=y(t[r]);t[r]=g(n,[e],t[r],a,E,f)}return t}if([n,i,l,c].includes(e))return[g(t,[e],r,a,E,f)]}else{if(N===n)return[i,c,l].includes(O)?E(r):0;if(N===i)return O===l||O===o?"":f(r);if(N===c)return!!r;if(N===o&&t[1]===o)return r}throw new Error(`TypeError: ${a} expected argument to be type ${T[e[0]]} but received type ${T[O]} instead.`)}function O(t){return null!==t&&"[object Array]"===Object.prototype.toString.call(t)}function R(t){return null!==t&&"[object Object]"===Object.prototype.toString.call(t)}function N(t){return null==t?t:O(t)?t.map((t=>N(t))):"function"!=typeof t.valueOf?t:t.valueOf()}function m(t,e){const r=N(t),n=N(e);if(r===n)return!0;if(Object.prototype.toString.call(r)!==Object.prototype.toString.call(n))return!1;if(!0===O(r)){if(r.length!==n.length)return!1;for(let t=0;t<r.length;t+=1)if(!1===m(r[t],n[t]))return!1;return!0}if(!0===R(r)){const t={};for(const e in r)if(hasOwnProperty.call(r,e)){if(!1===m(r[e],n[e]))return!1;t[e]=!0}for(const e in n)if(hasOwnProperty.call(n,e)&&!0!==t[e])return!1;return!0}return!1}const{TOK_CURRENT:P,TOK_GLOBAL:v,TOK_EXPREF:Y,TOK_PIPE:A,TOK_EQ:b,TOK_GT:S,TOK_LT:I,TOK_GTE:K,TOK_LTE:x,TOK_NE:U,TOK_FLATTEN:M}=r,{TYPE_STRING:w,TYPE_ARRAY_STRING:L,TYPE_ARRAY:B}=e;function k(t){if(null===t)return!0;const e=N(t);if(""===e||!1===e||null===e)return!0;if(O(e)&&0===e.length)return!0;if(R(e)){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}return!e}class j{constructor(t,e,r,n,s,i){this.runtime=t,this.globals=e,this.toNumber=r,this.toString=n,this.debug=s,this.language=i}search(t,e){return this.visit(t,e)}visit(t,e){const r=t&&{Field:(t,e)=>{if(null!==e&&(R(e)||O(e))){let r=e[t.name];if("function"==typeof r&&(r=void 0),void 0===r){try{this.debug.push(`Failed to find: '${t.name}'`);const r=Object.keys(e).map((t=>`'${t}'`)).toString();r.length&&this.debug.push(`Available fields: ${r}`)}catch(t){}return null}return r}return null},Subexpression:(t,e)=>{let r=this.visit(t.children[0],e);for(let e=1;e<t.children.length;e+=1)if(r=this.visit(t.children[1],r),null===r)return null;return r},IndexExpression:(t,e)=>{const r=this.visit(t.children[0],e);return this.visit(t.children[1],r)},Index:(t,e)=>{if(O(e)){let r=this.toNumber(this.visit(t.value,e));r<0&&(r=e.length+r);const n=e[r];return void 0===n?(this.debug.push(`Index ${r} out of range`),null):n}if(R(e)){const r=this.toString(this.visit(t.value,e)),n=e[r];return void 0===n?(this.debug.push(`Key ${r} does not exist`),null):n}return this.debug.push(`left side of index expression ${e} is not an array or object.`),null},Slice:(t,e)=>{if(!O(e))return null;const r=t.children.slice(0).map((t=>null!=t?this.toNumber(this.visit(t,e)):null)),n=this.computeSliceParams(e.length,r),[s,i,u]=n,o=[];if(u>0)for(let t=s;t<i;t+=u)o.push(e[t]);else for(let t=s;t>i;t+=u)o.push(e[t]);return o},Projection:(t,e)=>{const r=this.visit(t.children[0],e);if(!O(r))return null;const n=[];return r.forEach((e=>{const r=this.visit(t.children[1],e);null!==r&&n.push(r)})),n},ValueProjection:(t,e)=>{const r=this.visit(t.children[0],e);if(!R(N(r)))return null;const n=[];var s;return(s=r,Object.values(s)).forEach((e=>{const r=this.visit(t.children[1],e);null!==r&&n.push(r)})),n},FilterProjection:(t,e)=>{const r=this.visit(t.children[0],e);if(!O(r))return null;const n=r.filter((e=>!k(this.visit(t.children[2],e)))),s=[];return n.forEach((e=>{const r=this.visit(t.children[1],e);null!==r&&s.push(r)})),s},Comparator:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);if(t.name===b)return m(r,n);if(t.name===U)return!m(r,n);if(t.name===S)return r>n;if(t.name===K)return r>=n;if(t.name===I)return r<n;if(t.name===x)return r<=n;throw new Error(`Unknown comparator: ${t.name}`)},[M]:(t,e)=>{const r=this.visit(t.children[0],e);if(!O(r))return null;const n=[];return r.forEach((t=>{O(t)?n.push(...t):n.push(t)})),n},Identity:(t,e)=>e,MultiSelectList:(t,e)=>null===e?null:t.children.map((t=>this.visit(t,e))),MultiSelectHash:(t,e)=>{if(null===e)return null;const r={};return t.children.forEach((t=>{r[t.name]=this.visit(t.value,e)})),r},OrExpression:(t,e)=>{let r=this.visit(t.children[0],e);return k(r)&&(r=this.visit(t.children[1],e)),r},AndExpression:(t,e)=>{const r=this.visit(t.children[0],e);return!0===k(r)?r:this.visit(t.children[1],e)},AddExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return this.applyOperator(r,n,"+")},ConcatenateExpression:(t,e)=>{let r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return r=g(y(r),[w,L],r,"concatenate",this.toNumber,this.toString),n=g(y(n),[w,L],n,"concatenate",this.toNumber,this.toString),this.applyOperator(r,n,"&")},UnionExpression:(t,e)=>{let r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return r=g(y(r),[B],r,"union",this.toNumber,this.toString),n=g(y(n),[B],n,"union",this.toNumber,this.toString),r.concat(n)},SubtractExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return this.applyOperator(r,n,"-")},MultiplyExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return this.applyOperator(r,n,"*")},DivideExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return this.applyOperator(r,n,"/")},PowerExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return this.applyOperator(r,n,"^")},NotExpression:(t,e)=>k(this.visit(t.children[0],e)),UnaryMinusExpression:(t,e)=>-1*this.visit(t.children[0],e),Literal:t=>t.value,Number:t=>t.value,[A]:(t,e)=>{const r=this.visit(t.children[0],e);return this.visit(t.children[1],r)},[P]:(t,e)=>e,[v]:t=>{const e=this.globals[t.name];return void 0===e?null:e},Function:(t,e)=>{if("if"===t.name)return this.runtime.callFunction(t.name,t.children,e,this,!1);const r=t.children.map((t=>this.visit(t,e)));return this.runtime.callFunction(t.name,r,e,this)},ExpressionReference:t=>{const[e]=t.children;return e.jmespathType=Y,e}}[t.type];if(!r)throw new Error(`Unknown/missing node type ${t&&t.type||""}`);return r(t,e)}computeSliceParams(t,e){function r(t,e,r){let n=e;return n<0?(n+=t,n<0&&(n=r<0?-1:0)):n>=t&&(n=r<0?t-1:t),n}let[n,s,i]=e;if(null===i)i=1;else if(0===i){const t=new Error("Invalid slice, step cannot be 0");throw t.name="RuntimeError",t}const u=i<0;return n=null===n?u?t-1:0:r(t,n,i),s=null===s?u?-1:t:r(t,s,i),[n,s,i]}applyOperator(t,e,r){if(O(t)&&O(e)){const n=t.length<e.length?t:e,s=Math.abs(t.length-e.length);n.length+=s,n.fill(null,n.length-s);const i=[];for(let n=0;n<t.length;n+=1)i.push(this.applyOperator(t[n],e[n],r));return i}if(O(t))return t.map((t=>this.applyOperator(t,e,r)));if(O(e))return e.map((e=>this.applyOperator(t,e,r)));if("*"===r)return this.toNumber(t)*this.toNumber(e);if("&"===r)return t+e;if("+"===r)return this.toNumber(t)+this.toNumber(e);if("-"===r)return this.toNumber(t)-this.toNumber(e);if("/"===r){const r=t/e;return Number.isFinite(r)?r:null}if("^"===r)return t**e;throw new Error(`Unknown operator: ${r}`)}}const{TOK_UNQUOTEDIDENTIFIER:C,TOK_QUOTEDIDENTIFIER:$,TOK_RBRACKET:F,TOK_RPAREN:G,TOK_COMMA:D,TOK_COLON:H,TOK_CONCATENATE:J,TOK_RBRACE:Q,TOK_NUMBER:q,TOK_CURRENT:z,TOK_GLOBAL:X,TOK_EXPREF:V,TOK_PIPE:W,TOK_OR:Z,TOK_AND:tt,TOK_ADD:et,TOK_SUBTRACT:rt,TOK_UNARY_MINUS:nt,TOK_MULTIPLY:st,TOK_POWER:it,TOK_DIVIDE:ut,TOK_UNION:ot,TOK_EQ:ct,TOK_GT:at,TOK_LT:lt,TOK_GTE:ht,TOK_LTE:_t,TOK_NE:pt,TOK_FLATTEN:dt,TOK_STAR:Et,TOK_FILTER:Tt,TOK_DOT:ft,TOK_NOT:yt,TOK_LBRACE:gt,TOK_LBRACKET:Ot,TOK_LPAREN:Rt,TOK_LITERAL:Nt}=r,mt={".":ft,",":D,":":H,"{":gt,"}":Q,"]":F,"(":Rt,")":G,"@":z},Pt={"<":!0,">":!0,"=":!0,"!":!0},vt={" ":!0,"\t":!0,"\n":!0};function Yt(t){return t>="0"&&t<="9"||"."===t}function At(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"||t>="0"&&t<="9"||"_"===t}function bt(t,e){const r=t[e];return"$"===r?t.length>e&&At(t[e+1]):r>="a"&&r<="z"||r>="A"&&r<="Z"||"_"===r}class St{constructor(t=[],e=[]){this._allowedGlobalNames=t,this.debug=e}tokenize(t){const e=[];let r,n,s;for(this._current=0;this._current<t.length;){const i=e.length?e.slice(-1)[0].type:null;if(this._isGlobal(i,t,this._current))e.push(this._consumeGlobal(t));else if(bt(t,this._current))r=this._current,n=this._consumeUnquotedIdentifier(t),e.push({type:C,value:n,start:r});else if(void 0!==mt[t[this._current]])e.push({type:mt[t[this._current]],value:t[this._current],start:this._current}),this._current+=1;else if("-"!==t[this._current]||[X,z,q,G,C,$,F].includes(i))if(Yt(t[this._current]))s=this._consumeNumber(t),e.push(s);else if("["===t[this._current])s=this._consumeLBracket(t),e.push(s);else if('"'===t[this._current])r=this._current,n=this._consumeQuotedIdentifier(t),e.push({type:$,value:n,start:r});else if("'"===t[this._current])r=this._current,n=this._consumeRawStringLiteral(t),e.push({type:Nt,value:n,start:r});else if("`"===t[this._current]){r=this._current;const n=this._consumeLiteral(t);e.push({type:Nt,value:n,start:r})}else if(void 0!==Pt[t[this._current]])e.push(this._consumeOperator(t));else if(void 0!==vt[t[this._current]])this._current+=1;else if("&"===t[this._current])r=this._current,this._current+=1,"&"===t[this._current]?(this._current+=1,e.push({type:tt,value:"&&",start:r})):i===D||i===Rt?e.push({type:V,value:"&",start:r}):e.push({type:J,value:"&",start:r});else if("~"===t[this._current])r=this._current,this._current+=1,e.push({type:ot,value:"~",start:r});else if("+"===t[this._current])r=this._current,this._current+=1,e.push({type:et,value:"+",start:r});else if("-"===t[this._current])r=this._current,this._current+=1,e.push({type:rt,value:"-",start:r});else if("*"===t[this._current]){r=this._current,this._current+=1;const t=e.length&&e.slice(-1)[0].type;0===e.length||[Ot,ft,W,tt,Z,D,H].includes(t)?e.push({type:Et,value:"*",start:r}):e.push({type:st,value:"*",start:r})}else if("/"===t[this._current])r=this._current,this._current+=1,e.push({type:ut,value:"/",start:r});else if("^"===t[this._current])r=this._current,this._current+=1,e.push({type:it,value:"^",start:r});else{if("|"!==t[this._current]){const e=new Error(`Unknown character:${t[this._current]}`);throw e.name="LexerError",e}r=this._current,this._current+=1,"|"===t[this._current]?(this._current+=1,e.push({type:Z,value:"||",start:r})):e.push({type:W,value:"|",start:r})}else s=this._consumeUnaryMinus(t),e.push(s)}return e}_consumeUnquotedIdentifier(t){const e=this._current;for(this._current+=1;this._current<t.length&&At(t[this._current]);)this._current+=1;return t.slice(e,this._current)}_consumeQuotedIdentifier(t){const e=this._current;this._current+=1;const r=t.length;let n=!bt(t,e+1);for(;'"'!==t[this._current]&&this._current<r;){let e=this._current;At(t[e])||(n=!0),"\\"!==t[e]||"\\"!==t[e+1]&&'"'!==t[e+1]?e+=1:e+=2,this._current=e}this._current+=1;const s=t.slice(e,this._current);try{n&&!s.includes(" ")||(this.debug.push(`Suspicious quotes: ${s}`),this.debug.push(`Did you intend a literal? '${s.replace(/"/g,"")}'?`))}catch(t){}return JSON.parse(s)}_consumeRawStringLiteral(t){const e=this._current;this._current+=1;const r=t.length;for(;"'"!==t[this._current]&&this._current<r;){let e=this._current;"\\"!==t[e]||"\\"!==t[e+1]&&"'"!==t[e+1]?e+=1:e+=2,this._current=e}return this._current+=1,t.slice(e+1,this._current-1).replaceAll("\\'","'")}_consumeNumber(t){const e=this._current;this._current+=1;const r=t.length;for(;Yt(t[this._current])&&this._current<r;)this._current+=1;const n=t.slice(e,this._current);let s;return s=n.includes(".")?parseFloat(n):parseInt(n,10),{type:q,value:s,start:e}}_consumeUnaryMinus(){const t=this._current;return this._current+=1,{type:nt,value:"-",start:t}}_consumeLBracket(t){const e=this._current;return this._current+=1,"?"===t[this._current]?(this._current+=1,{type:Tt,value:"[?",start:e}):"]"===t[this._current]?(this._current+=1,{type:dt,value:"[]",start:e}):{type:Ot,value:"[",start:e}}_isGlobal(t,e,r){if(null!==t&&t===ft)return!1;if("$"!==e[r])return!1;let n=r+1;for(;n<e.length&&At(e[n]);)n+=1;const s=e.slice(r,n);return this._allowedGlobalNames.includes(s)}_consumeGlobal(t){const e=this._current;for(this._current+=1;this._current<t.length&&At(t[this._current]);)this._current+=1;const r=t.slice(e,this._current);return{type:X,name:r,start:e}}_consumeOperator(t){const e=this._current,r=t[e];return this._current+=1,"!"===r?"="===t[this._current]?(this._current+=1,{type:pt,value:"!=",start:e}):{type:yt,value:"!",start:e}:"<"===r?"="===t[this._current]?(this._current+=1,{type:_t,value:"<=",start:e}):{type:lt,value:"<",start:e}:">"===r?"="===t[this._current]?(this._current+=1,{type:ht,value:">=",start:e}):{type:at,value:">",start:e}:"="===t[this._current]?(this._current+=1,{type:ct,value:"==",start:e}):{type:ct,value:"=",start:e}}_consumeLiteral(t){this._current+=1;const e=this._current,r=t.length;let n,s=!1;for(;(s||"`"!==t[this._current])&&this._current<r;){let e=this._current;s&&"\\"===t[e]&&'"'===t[e+1]?e+=2:('"'===t[e]&&(s=!s),s&&"`"===t[e+1]?e+=2:"\\"!==t[e]||"\\"!==t[e+1]&&"`"!==t[e+1]?e+=1:e+=2),this._current=e}let i=t.slice(e,this._current).trimStart();return i=i.replaceAll("\\`","`"),n=function(t){if(""===t)return!1;if('[{"'.includes(t[0]))return!0;if(["true","false","null"].includes(t))return!0;if(!"-0123456789".includes(t[0]))return!1;try{return JSON.parse(t),!0}catch(t){return!1}}(i)?JSON.parse(i):JSON.parse(`"${i}"`),this._current+=1,n}}const{TOK_LITERAL:It,TOK_COLON:Kt,TOK_EOF:xt,TOK_UNQUOTEDIDENTIFIER:Ut,TOK_QUOTEDIDENTIFIER:Mt,TOK_RBRACKET:wt,TOK_RPAREN:Lt,TOK_COMMA:Bt,TOK_CONCATENATE:kt,TOK_RBRACE:jt,TOK_NUMBER:Ct,TOK_CURRENT:$t,TOK_GLOBAL:Ft,TOK_FIELD:Gt,TOK_EXPREF:Dt,TOK_PIPE:Ht,TOK_OR:Jt,TOK_AND:Qt,TOK_ADD:qt,TOK_SUBTRACT:zt,TOK_UNARY_MINUS:Xt,TOK_MULTIPLY:Vt,TOK_POWER:Wt,TOK_DIVIDE:Zt,TOK_UNION:te,TOK_EQ:ee,TOK_GT:re,TOK_LT:ne,TOK_GTE:se,TOK_LTE:ie,TOK_NE:ue,TOK_FLATTEN:oe,TOK_STAR:ce,TOK_FILTER:ae,TOK_DOT:le,TOK_NOT:he,TOK_LBRACE:_e,TOK_LBRACKET:pe,TOK_LPAREN:de}=r,Ee={[xt]:0,[Ut]:0,[Mt]:0,[wt]:0,[Lt]:0,[Bt]:0,[jt]:0,[Ct]:0,[$t]:0,[Ft]:0,[Gt]:0,[Dt]:0,[Ht]:1,[Jt]:2,[Qt]:3,[kt]:5,[qt]:6,[zt]:6,[Vt]:7,[Zt]:7,[Wt]:7,[te]:7,[ee]:5,[re]:5,[ne]:5,[se]:5,[ie]:5,[ue]:5,[oe]:9,[ce]:20,[ae]:21,[le]:40,[he]:30,[Xt]:30,[_e]:50,[pe]:55,[de]:60};class Te{constructor(t=[]){this._allowedGlobalNames=t}parse(t,e){this._loadTokens(t,e),this.index=0;const r=this.expression(0);if(this._lookahead(0)!==xt){const t=this._lookaheadToken(0),e=new Error(`Unexpected token type: ${t.type}, value: ${t.value}`);throw e.name="ParserError",e}return r}_loadTokens(t,e){const r=new St(this._allowedGlobalNames,e).tokenize(t);r.push({type:xt,value:"",start:t.length}),this.tokens=r}expression(t){const e=this._lookaheadToken(0);this._advance();let r=this.nud(e),n=this._lookahead(0);for(;t<Ee[n];)this._advance(),r=this.led(n,r),n=this._lookahead(0);return r}_lookahead(t){return this.tokens[this.index+t].type}_lookaheadToken(t){return this.tokens[this.index+t]}_advance(){this.index+=1}_getIndex(){return this.index}_setIndex(t){this.index=t}nud(t){let e,r,n,s,i;switch(t.type){case It:return{type:"Literal",value:t.value};case Ct:return{type:"Number",value:t.value};case Ut:return{type:"Field",name:t.value};case Mt:if(s={type:"Field",name:t.value},this._lookahead(0)===de)throw new Error("Quoted identifier not allowed for function names.");return s;case he:return r=this.expression(Ee.Not),{type:"NotExpression",children:[r]};case Xt:return r=this.expression(Ee.UnaryMinus),{type:"UnaryMinusExpression",children:[r]};case ce:return e={type:"Identity"},r=this._lookahead(0)===wt?{type:"Identity"}:this._parseProjectionRHS(Ee.Star),{type:"ValueProjection",children:[e,r]};case ae:return this.led(t.type,{type:"Identity"});case _e:return this._parseMultiselectHash();case oe:return e={type:oe,children:[{type:"Identity"}]},r=this._parseProjectionRHS(Ee.Flatten),{type:"Projection",children:[e,r]};case pe:return this._lookahead(0)===ce&&this._lookahead(1)===wt?(this._advance(),this._advance(),r=this._parseProjectionRHS(Ee.Star),{type:"Projection",children:[{type:"Identity"},r]}):this._parseUnchainedIndexExpression();case $t:return{type:$t};case Ft:return{type:Ft,name:t.name};case Gt:return{type:Gt};case Dt:return n=this.expression(Ee.Expref),{type:"ExpressionReference",children:[n]};case de:for(i=[];this._lookahead(0)!==Lt;)n=this.expression(0),i.push(n);return this._match(Lt),i[0];default:this._errorToken(t)}}led(t,e){let r,n,s,i,u,o,c,a,l;switch(t){case kt:return n=this.expression(Ee.Concatenate),{type:"ConcatenateExpression",children:[e,n]};case le:return c=Ee.Dot,this._lookahead(0)!==ce?(n=this._parseDotRHS(c),{type:"Subexpression",children:[e,n]}):(this._advance(),n=this._parseProjectionRHS(c),{type:"ValueProjection",children:[e,n]});case Ht:return n=this.expression(Ee.Pipe),{type:Ht,children:[e,n]};case Jt:return n=this.expression(Ee.Or),{type:"OrExpression",children:[e,n]};case Qt:return n=this.expression(Ee.And),{type:"AndExpression",children:[e,n]};case qt:return n=this.expression(Ee.Add),{type:"AddExpression",children:[e,n]};case zt:return n=this.expression(Ee.Subtract),{type:"SubtractExpression",children:[e,n]};case Vt:return n=this.expression(Ee.Multiply),{type:"MultiplyExpression",children:[e,n]};case Zt:return n=this.expression(Ee.Divide),{type:"DivideExpression",children:[e,n]};case Wt:return n=this.expression(Ee.Power),{type:"PowerExpression",children:[e,n]};case te:return n=this.expression(Ee.Power),{type:"UnionExpression",children:[e,n]};case de:for(s=e.name,i=[];this._lookahead(0)!==Lt;)u=this.expression(0),this._lookahead(0)===Bt&&this._match(Bt),i.push(u);return this._match(Lt),o={type:"Function",name:s,children:i},o;case ae:return r=this.expression(0),this._match(wt),n=this._lookahead(0)===oe?{type:"Identity"}:this._parseProjectionRHS(Ee.Filter),{type:"FilterProjection",children:[e,n,r]};case oe:return a={type:oe,children:[e]},l=this._parseProjectionRHS(Ee.Flatten),{type:"Projection",children:[a,l]};case ee:case ue:case re:case se:case ne:case ie:return this._parseComparator(e,t);case pe:return this._lookahead(0)===ce&&this._lookahead(1)===wt?(this._advance(),this._advance(),n=this._parseProjectionRHS(Ee.Star),{type:"Projection",children:[e,n]}):(n=this._parseChainedIndexExpression(),this._projectIfSlice(e,n));default:this._errorToken(this._lookaheadToken(0))}}_match(t){if(this._lookahead(0)!==t){const e=this._lookaheadToken(0),r=new Error(`Expected ${t}, got: ${e.type}`);throw r.name="ParserError",r}this._advance()}_errorToken(t){const e=new Error(`Invalid token (${t.type}): "${t.value}"`);throw e.name="ParserError",e}_parseChainedIndexExpression(){const t=this._getIndex();if(this._lookahead(0)===Kt)return this._parseSliceExpression();const e=this.expression(0);return this._lookahead(0)===Kt?(this._setIndex(t),this._parseSliceExpression()):(this._match(wt),{type:"Index",value:e})}_parseUnchainedIndexExpression(){const t=this._getIndex(),e=this._lookahead(0);if(e===Kt){const t=this._parseSliceExpression();return this._projectIfSlice({type:"Identity"},t)}const r=this.expression(0),n=this._lookahead(0);if(n===Bt)return this._setIndex(t),this._parseMultiselectList();if(n===Kt){this._setIndex(t);const e=this._parseSliceExpression();return this._projectIfSlice({type:"Identity"},e)}return e===Ct||e===Xt?(this._match(wt),{type:"Index",value:r}):(this._setIndex(t),this._parseMultiselectList())}_projectIfSlice(t,e){const r={type:"IndexExpression",children:[t,e]};return"Slice"===e.type?{type:"Projection",children:[r,this._parseProjectionRHS(Ee.Star)]}:r}_parseSliceExpression(){const t=[null,null,null];let e=0,r=this._lookahead(0);for(;r!==wt&&e<3;){if(r===Kt&&e<2)e+=1,this._advance();else{t[e]=this.expression(0);const r=this._lookahead(0);if(r!==Kt&&r!==wt){const t=new Error(`Syntax error, unexpected token: ${r.value}(${r.type})`);throw t.name="Parsererror",t}}r=this._lookahead(0)}return this._match(wt),{type:"Slice",children:t}}_parseComparator(t,e){return{type:"Comparator",name:e,children:[t,this.expression(Ee[e])]}}_parseDotRHS(t){const e=this._lookahead(0);return[Ut,Mt,ce].indexOf(e)>=0?this.expression(t):e===pe?(this._match(pe),this._parseMultiselectList()):e===_e?(this._match(_e),this._parseMultiselectHash()):void 0}_parseProjectionRHS(t){let e;if(Ee[this._lookahead(0)]<10)e={type:"Identity"};else if(this._lookahead(0)===pe)e=this.expression(t);else if(this._lookahead(0)===ae)e=this.expression(t);else{if(this._lookahead(0)!==le){const t=this._lookaheadToken(0),e=new Error(`Sytanx error, unexpected token: ${t.value}(${t.type})`);throw e.name="ParserError",e}this._match(le),e=this._parseDotRHS(t)}return e}_parseMultiselectList(){const t=[];for(;this._lookahead(0)!==wt;){const e=this.expression(0);if(t.push(e),this._lookahead(0)===Bt&&(this._match(Bt),this._lookahead(0)===wt))throw new Error("Unexpected token Rbracket")}return this._match(wt),{type:"MultiSelectList",children:t}}_parseMultiselectHash(){const t=[],e=[Ut,Mt];let r,n,s,i;if(this._lookahead(0)===jt)return this._advance(),{type:"MultiSelectHash",children:[]};for(;;){if(r=this._lookaheadToken(0),e.indexOf(r.type)<0)throw new Error(`Expecting an identifier token, got: ${r.type}`);if(n=r.value,this._advance(),this._match(Kt),s=this.expression(0),i={type:"KeyValuePair",name:n,value:s},t.push(i),this._lookahead(0)===Bt)this._match(Bt);else if(this._lookahead(0)===jt){this._match(jt);break}}return{type:"MultiSelectHash",children:t}}}const fe=864e5;function ye(t){return new Date(Math.round(t*fe))}function ge(t){return t/fe}const{TYPE_CLASS:Oe,TYPE_ANY:Re}=e;function Ne(t){return null==t?"":t.toString()}const me=t=>{const e=+t;return Number.isNaN(e)?0:e};class Pe{constructor(t,r,n={}){this.strictDeepEqual=m,this.toNumber=r,this.functionTable=function(t,r,n,s,i,u,o,c){const{TYPE_NUMBER:a,TYPE_ANY:l,TYPE_STRING:h,TYPE_ARRAY:_,TYPE_OBJECT:p,TYPE_BOOLEAN:d,TYPE_EXPREF:E,TYPE_NULL:T,TYPE_ARRAY_NUMBER:f,TYPE_ARRAY_STRING:y}=e,g={abs:{_func:t=>Math.abs(t[0]),_signature:[{types:[a]}]},avg:{_func:t=>{let e=0;const r=t[0];return r.forEach((t=>{e+=t})),e/r.length},_signature:[{types:[f]}]},ceil:{_func:t=>Math.ceil(t[0]),_signature:[{types:[a]}]},contains:{_func:t=>u(t[0]).indexOf(u(t[1]))>=0,_signature:[{types:[h,_]},{types:[l]}]},endsWith:{_func:t=>{const e=u(t[0]),r=u(t[1]);return-1!==e.indexOf(r,e.length-r.length)},_signature:[{types:[h]},{types:[h]}]},floor:{_func:t=>Math.floor(t[0]),_signature:[{types:[a]}]},join:{_func:t=>{const e=t[0];return t[1].join(e)},_signature:[{types:[h]},{types:[y]}]},keys:{_func:t=>null===t[0]?[]:Object.keys(t[0]),_signature:[{types:[l]}]},length:{_func:t=>{const e=u(t[0]);return r(e)?Object.keys(e).length:n(e)?e.length:o(e).length},_signature:[{types:[h,_,p]}]},map:{_func:e=>{const r=e[0];return e[1].map((e=>t.interpreter.visit(r,e)))},_signature:[{types:[E]},{types:[_]}]},max:{_func:t=>{const e=t.reduce(((t,e)=>(Array.isArray(e)?t.push(...e):t.push(e),t)),[]),r=e.find((t=>null!==t));if(0===e.length||void 0===r)return null;const n=i(r,!0)===a,u=n?(t,e)=>{const r=s(e);return t<=r?r:t}:(t,e)=>{const r=o(e);return 1===t.localeCompare(r)?t:r};return e.reduce(u,n?s(r):o(r))},_signature:[{types:[_,f,y],variadic:!0}]},merge:{_func:t=>{const e={};return t.forEach((t=>{Object.entries(t||{}).forEach((([t,r])=>{e[t]=r}))})),e},_signature:[{types:[p],variadic:!0}]},min:{_func:t=>{const e=t.reduce(((t,e)=>(Array.isArray(e)?t.push(...e):t.push(e),t)),[]),r=e.find((t=>null!==t));if(0===e.length||void 0===r)return null;const n=i(r,!0)===a,u=n?(t,e)=>{const r=s(e);return t<=r?t:r}:(t,e)=>{const r=o(e);return 1===t.localeCompare(r)?r:t};return e.reduce(u,n?s(r):o(r))},_signature:[{types:[_,f,y],variadic:!0}]},notNull:{_func:t=>t.find((t=>i(t)!==T))||null,_signature:[{types:[l],variadic:!0}]},reduce:{_func:e=>{const r=e[0];return e[1].reduce(((e,n,s,i)=>t.interpreter.visit(r,{accumulated:e,current:n,index:s,array:i})),3===e.length?e[2]:null)},_signature:[{types:[E]},{types:[_]},{types:[l],optional:!0}]},register:{_func:e=>{const r=e[0],n=e[1];return g[r]&&!g[r].custom?(c.push(`Cannot override function: '${r}'`),{}):(g[r]={_func:e=>t.interpreter.visit(n,...e),_signature:[{types:[l],optional:!0}],_custom:!0},{})},_signature:[{types:[h]},{types:[E]}]},reverse:{_func:t=>{const e=u(t[0]);if(i(e)===h){let t="";for(let r=e.length-1;r>=0;r-=1)t+=e[r];return t}const r=t[0].slice(0);return r.reverse(),r},_signature:[{types:[h,_]}]},sort:{_func:t=>{const e=t[0].slice(0);if(e.length>0){const r=i(t[0][0])===a?s:o;e.sort(((t,e)=>{const n=r(t),s=r(e);return n<s?-1:n>s?1:0}))}return e},_signature:[{types:[_,y,f]}]},sortBy:{_func:e=>{const r=e[0].slice(0);if(0===r.length)return r;const n=e[1],s=i(t.interpreter.visit(n,r[0]));if([a,h].indexOf(s)<0)throw new Error("TypeError");const u=[];for(let t=0;t<r.length;t+=1)u.push([t,r[t]]);u.sort(((e,r)=>{const u=t.interpreter.visit(n,e[1]),o=t.interpreter.visit(n,r[1]);if(i(u)!==s)throw new Error(`TypeError: expected ${s}, received ${i(u)}`);if(i(o)!==s)throw new Error(`TypeError: expected ${s}, received ${i(o)}`);return u>o?1:u<o?-1:e[0]-r[0]}));for(let t=0;t<u.length;t+=1)[,r[t]]=u[t];return r},_signature:[{types:[_]},{types:[E]}]},startsWith:{_func:t=>u(t[0]).startsWith(u(t[1])),_signature:[{types:[h]},{types:[h]}]},sum:{_func:t=>{let e=0;return t[0].forEach((t=>{e+=1*t})),e},_signature:[{types:[f]}]},toArray:{_func:t=>i(t[0])===_?t[0]:[t[0]],_signature:[{types:[l]}]},toNumber:{_func:t=>{const e=i(t[0]);return e===a?t[0]:e===h?s(t[0]):null},_signature:[{types:[l]}]},toString:{_func:t=>i(t[0])===h?t[0]:JSON.stringify(t[0]),_signature:[{types:[l]}]},type:{_func:t=>({[a]:"number",[h]:"string",[_]:"array",[p]:"object",[d]:"boolean",[E]:"expref",[T]:"null"}[i(t[0])]),_signature:[{types:[l]}]},values:{_func:t=>{const e=u(t[0]);return null===e?[]:Object.values(e)},_signature:[{types:[l]}]},zip:{_func:t=>{const e=t.reduce(((t,e)=>Math.min(t,e.length)),t[0].length),r=new Array(e);for(let n=0;n<e;n+=1)r[n]=[],t.forEach((t=>{r[n].push(t[n])}));return r},_signature:[{types:[_],variadic:!0}]}};return g}(this,R,O,r,f,N,Ne,t),Object.entries(function(t,r,n,s=[]){return{and:{_func:e=>{let r=!!t(e[0]);return e.slice(1).forEach((e=>{r=r&&!!t(e)})),r},_signature:[{types:[e.TYPE_ANY],variadic:!0}]},casefold:{_func:(t,e,n)=>r(t[0]).toLocaleUpperCase(n.language).toLocaleLowerCase(n.language),_signature:[{types:[e.TYPE_STRING]}]},datedif:{_func:t=>{const e=r(t[2]).toLowerCase(),n=ye(t[0]),s=ye(t[1]);if(s===n)return 0;if(s<n)return null;if("d"===e)return Math.floor(ge(s-n));const i=s.getFullYear()-n.getFullYear();let u=s.getMonth()-n.getMonth();const o=s.getDate()-n.getDate();if("y"===e){let t=i;return u<0&&(t-=1),0===u&&o<0&&(t-=1),t}if("m"===e)return 12*i+u+(o<0?-1:0);if("ym"===e)return o<0&&(u-=1),u<=0&&i>0?12+u:u;if("yd"===e)return o<0&&(u-=1),u<0?s.setFullYear(n.getFullYear()+1):s.setFullYear(n.getFullYear()),Math.floor(ge(s-n));throw new TypeError(`Unrecognized unit parameter "${e}" for datedif()`)},_signature:[{types:[e.TYPE_NUMBER]},{types:[e.TYPE_NUMBER]},{types:[e.TYPE_STRING]}]},datetime:{_func:t=>{const e=t[0],r=t[1]-1,n=t[2],s=t.length>3?t[3]:0,i=t.length>4?t[4]:0,u=t.length>5?t[5]:0,o=t.length>6?t[6]:0;return ge(new Date(e,r,n,s,i,u,o))},_signature:[{types:[e.TYPE_NUMBER]},{types:[e.TYPE_NUMBER]},{types:[e.TYPE_NUMBER]},{types:[e.TYPE_NUMBER],optional:!0},{types:[e.TYPE_NUMBER],optional:!0},{types:[e.TYPE_NUMBER],optional:!0},{types:[e.TYPE_NUMBER],optional:!0}]},day:{_func:t=>ye(t[0]).getDate(),_signature:[{types:[e.TYPE_NUMBER]}]},deepScan:{_func:t=>{const[e,n]=t,s=r(n),i=[];return null===e||function t(e){Object.entries(e).forEach((([e,r])=>{e===s&&i.push(r),"object"==typeof r&&t(r)}))}(e),i},_signature:[{types:[e.TYPE_OBJECT,e.TYPE_ARRAY,e.TYPE_NULL]},{types:[e.TYPE_STRING,e.TYPE_NUMBER]}]},entries:{_func:e=>{const r=t(e[0]);return Object.entries(r)},_signature:[{types:[e.TYPE_NUMBER,e.TYPE_STRING,e.TYPE_ARRAY,e.TYPE_OBJECT,e.TYPE_BOOLEAN]}]},eomonth:{_func:t=>{const e=ye(t[0]),r=t[1];return ge(new Date(e.getFullYear(),e.getMonth()+r+1,0))},_signature:[{types:[e.TYPE_NUMBER]},{types:[e.TYPE_NUMBER]}]},exp:{_func:t=>Math.exp(t[0]),_signature:[{types:[e.TYPE_NUMBER]}]},false:{_func:()=>!1,_signature:[]},find:{_func:t=>{const e=t[0],n=r(t[1]),s=t.length>2?t[2]:0,i=n.indexOf(e,s);return-1===i?null:i},_signature:[{types:[e.TYPE_STRING]},{types:[e.TYPE_STRING]},{types:[e.TYPE_NUMBER],optional:!0}]},fromEntries:{_func:t=>{const e=t[0];return Object.fromEntries(e)},_signature:[{types:[e.TYPE_ARRAY_ARRAY]}]},hour:{_func:t=>t[0]<0?null:ye(t[0]).getHours(),_signature:[{types:[e.TYPE_NUMBER]}]},if:{_func:(e,r,n)=>{const s=e[0],i=e[1],u=e[2],o=n.visit(s,r);return t(o)?n.visit(i,r):n.visit(u,r)},_signature:[{types:[e.TYPE_ANY]},{types:[e.TYPE_ANY]},{types:[e.TYPE_ANY]}]},left:{_func:t=>{const e=t.length>1?t[1]:1;return e<0?null:t[0]instanceof Array?t[0].slice(0,e):r(t[0]).substr(0,e)},_signature:[{types:[e.TYPE_STRING,e.TYPE_ARRAY]},{types:[e.TYPE_NUMBER],optional:!0}]},lower:{_func:t=>r(t[0]).toLowerCase(),_signature:[{types:[e.TYPE_STRING]}]},mid:{_func:t=>{const e=t[1],n=t[2];return e<0?null:t[0]instanceof Array?t[0].slice(e,e+n):r(t[0]).substr(e,n)},_signature:[{types:[e.TYPE_STRING,e.TYPE_ARRAY]},{types:[e.TYPE_NUMBER]},{types:[e.TYPE_NUMBER]}]},minute:{_func:t=>t[0]<0?null:ye(t[0]).getMinutes(),_signature:[{types:[e.TYPE_NUMBER]}]},mod:{_func:t=>t[0]%t[1],_signature:[{types:[e.TYPE_NUMBER]},{types:[e.TYPE_NUMBER]}]},month:{_func:t=>ye(t[0]).getMonth()+1,_signature:[{types:[e.TYPE_NUMBER]}]},not:{_func:e=>!t(e[0]),_signature:[{types:[e.TYPE_ANY]}]},now:{_func:()=>ge(Date.now()),_signature:[]},null:{_func:()=>null,_signature:[]},or:{_func:e=>{let r=!!t(e[0]);return e.slice(1).forEach((e=>{r=r||!!t(e)})),r},_signature:[{types:[e.TYPE_ANY],variadic:!0}]},power:{_func:t=>t[0]**t[1],_signature:[{types:[e.TYPE_NUMBER]},{types:[e.TYPE_NUMBER]}]},proper:{_func:t=>r(t[0]).split(" ").map((t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase())).join(" "),_signature:[{types:[e.TYPE_STRING]}]},replace:{_func:t=>{const e=r(t[0]),n=t[1],s=t[2],i=r(t[3]);return n<0?null:e.substr(0,n)+i+e.substr(n+s)},_signature:[{types:[e.TYPE_STRING]},{types:[e.TYPE_NUMBER]},{types:[e.TYPE_NUMBER]},{types:[e.TYPE_STRING]}]},rept:{_func:t=>{const e=r(t[0]),n=t[1];return n<0?null:e.repeat(n)},_signature:[{types:[e.TYPE_STRING]},{types:[e.TYPE_NUMBER]}]},right:{_func:t=>{const e=t.length>1?t[1]:1;if(e<0)return null;if(t[0]instanceof Array)return 0===e?[]:t[0].slice(-1*e);const n=r(t[0]),s=n.length-e;return n.substr(s,e)},_signature:[{types:[e.TYPE_STRING,e.TYPE_ARRAY]},{types:[e.TYPE_NUMBER],optional:!0}]},round:{_func:t=>function(t,e){const r=10**e;return Math.round(t*r)/r}(t[0],t[1]),_signature:[{types:[e.TYPE_NUMBER]},{types:[e.TYPE_NUMBER]}]},search:{_func:t=>{const e=r(t[0]),n=r(t[1]),s=t.length>2?t[2]:0;if(null===e||null===n||0===n.length)return[];const i=e.replace(/([[.\\^$()+{])/g,"\\$1").replace(/~?\?/g,(t=>"~?"===t?"\\?":".")).replace(/~?\*/g,(t=>"~*"===t?"\\*":".*?")).replace(/~~/g,"~"),u=new RegExp(i),o=n.substring(s).match(u);return null===o?[]:[o.index+s,o[0]]},_signature:[{types:[e.TYPE_STRING]},{types:[e.TYPE_STRING]},{types:[e.TYPE_NUMBER],optional:!0}]},second:{_func:t=>t[0]<0?null:ye(t[0]).getSeconds(),_signature:[{types:[e.TYPE_NUMBER]}]},split:{_func:t=>{const e=r(t[0]),n=r(t[1]);return e.split(n)},_signature:[{types:[e.TYPE_STRING]},{types:[e.TYPE_STRING]}]},sqrt:{_func:t=>{const e=Math.sqrt(t[0]);return Number.isNaN(e)?null:e},_signature:[{types:[e.TYPE_NUMBER]}]},stdev:{_func:t=>{const e=t[0];if(e.length<=1)return null;const r=e.map((t=>n(t))),s=r.reduce(((t,e)=>t+e),0)/e.length,i=r.reduce(((t,e)=>t+e*e),0),u=Math.sqrt((i-e.length*s*s)/(e.length-1));return Number.isNaN(u)?null:u},_signature:[{types:[e.TYPE_ARRAY_NUMBER]}]},stdevp:{_func:t=>{const e=t[0];if(0===e.length)return null;const r=e.map((t=>n(t))),s=r.reduce(((t,e)=>t+e),0)/e.length,i=r.reduce(((t,e)=>t+e*e),0)/e.length,u=Math.sqrt(i-s*s);return Number.isNaN(u)?null:u},_signature:[{types:[e.TYPE_ARRAY_NUMBER]}]},substitute:{_func:t=>{const e=r(t[0]),n=t[1],s=t[2];if(t.length<=3)return e.replaceAll(n,s);const i=t[3];if(i<1)return e;let u=-1;for(let t=0;t<i;t+=1){u+=1;const t=e.slice(u).indexOf(n);if(-1===t)return e;u+=t}return e.slice(0,u)+e.slice(u).replace(n,s)},_signature:[{types:[e.TYPE_STRING]},{types:[e.TYPE_STRING]},{types:[e.TYPE_STRING]},{types:[e.TYPE_NUMBER],optional:!0}]},time:{_func:t=>{const e=t[0],r=t.length>1?t[1]:0,n=t.length>2?t[2]:0;return e<0||r<0||n<0?null:ge(new Date(1970,0,1,e,r,n))},_signature:[{types:[e.TYPE_NUMBER]},{types:[e.TYPE_NUMBER],optional:!0},{types:[e.TYPE_NUMBER],optional:!0}]},today:{_func:()=>{const t=new Date(Date.now());return ge(new Date(t.getFullYear(),t.getMonth(),t.getDate()))},_signature:[]},trim:{_func:t=>r(t[0]).split(" ").filter((t=>t)).join(" "),_signature:[{types:[e.TYPE_STRING]}]},true:{_func:()=>!0,_signature:[]},trunc:{_func:t=>{const e=t[0],r=t.length>1?t[1]:0;return(e>=0?Math.floor:Math.ceil)(e*10**r)/10**r},_signature:[{types:[e.TYPE_NUMBER]},{types:[e.TYPE_NUMBER],optional:!0}]},unique:{_func:e=>{const r=e[0].map((e=>t(e)));return e[0].filter(((e,n)=>r.indexOf(t(e))===n))},_signature:[{types:[e.TYPE_ARRAY]}]},upper:{_func:t=>r(t[0]).toUpperCase(),_signature:[{types:[e.TYPE_STRING]}]},value:{_func:t=>{const e=t[0]||{},r=t[1],n=e[r];if(void 0===n){s.push(`Failed to find: '${r}'`);const t=Object.keys(e).map((t=>`'${t}'`)).toString();return t.length&&s.push(`Available fields: ${t}`),null}return n},_signature:[{types:[e.TYPE_OBJECT,e.TYPE_ARRAY,e.TYPE_NULL]},{types:[e.TYPE_STRING,e.TYPE_NUMBER]}]},weekday:{_func:t=>{const e=t[0],r=t.length>1?t[1]:1,n=ye(e).getDay();switch(r){case 1:return n+1;case 2:return(n+6)%7+1;case 3:return(n+6)%7;default:return null}},_signature:[{types:[e.TYPE_NUMBER]},{types:[e.TYPE_NUMBER],optional:!0}]},year:{_func:t=>ye(t[0]).getFullYear(),_signature:[{types:[e.TYPE_NUMBER]}]},charCode:{_func:t=>{const e=t[0];return Number.isInteger(e)?String.fromCharCode(e):null},_signature:[{types:[e.TYPE_NUMBER]}]},codePoint:{_func:t=>{const e=r(t[0]);return 0===e.length?null:e.codePointAt(0)},_signature:[{types:[e.TYPE_STRING]}]},encodeUrlComponent:{_func:t=>encodeURIComponent(t[0]),_signature:[{types:[e.TYPE_STRING]}]},encodeUrl:{_func:t=>encodeURI(t[0]),_signature:[{types:[e.TYPE_STRING]}]},decodeUrlComponent:{_func:t=>decodeURIComponent(t[0]),_signature:[{types:[e.TYPE_STRING]}]},decodeUrl:{_func:t=>decodeURI(t[0]),_signature:[{types:[e.TYPE_STRING]}]}}}(N,Ne,r,t)).forEach((([t,e])=>{this.functionTable[t]=e})),Object.entries(n).forEach((([t,e])=>{e._runtime=this,this.functionTable[t]=e}))}_validateArgs(t,e,r,n){if(0===r.length)return;let s;const i=r.filter((t=>!t.optional)).length;if(r[r.length-1].variadic){if(e.length<r.length)throw s=1===r.length?" argument":" arguments",new Error(`ArgumentError: ${t}() takes at least${r.length}${s} but received ${e.length}`)}else if(e.length<i||e.length>r.length)throw s=1===r.length?" argument":" arguments",new Error(`ArgumentError: ${t}() takes ${r.length}${s} but received ${e.length}`);if(!n)return;let u,o;const c=Math.min(r.length,e.length);for(let n=0;n<c;n+=1)u=r[n].types,a=e[n],l=void 0,u.includes(Oe)&&null!==(l=a)&&!Array.isArray(l)&&"Object"!==l.constructor.name||u.includes(Re)||(o=y(e[n]),e[n]=g(o,u,e[n],t,this.toNumber,Ne));var a,l}callFunction(t,e,r,n,s=!0){if(!Object.prototype.hasOwnProperty.call(this.functionTable,t))throw new Error(`Unknown function: ${t}()`);const i=this.functionTable[t];return this._validateArgs(t,e,i._signature,s),i._func.call(this,e,r,n)}}class ve{constructor(t,e,r){this.debug=t,this.toNumber=function(t,e=[]){return r=>{const n=N(r);if(null===n)return null;if(n instanceof Array)return e.push("Converted array to zero"),0;const s=typeof n;return"number"===s?n:"string"===s?t(n,e):"boolean"===s?n?1:0:(e.push("Converted object to zero"),0)}}(r||me,t),this.runtime=new Pe(t,this.toNumber,e)}compile(t,e=[]){let r;try{r=new Te(e).parse(t,this.debug)}catch(t){throw this.debug.push(t.toString()),t}return r}search(t,e,r={},n="en-US"){this.runtime.interpreter=new j(this.runtime,r,this.toNumber,Ne,this.debug,n);try{return this.runtime.interpreter.search(t,e)}catch(t){throw this.debug.push(t.message||t.toString()),t}}}class Ye{constructor(t={},e=null,r=[]){this.customFunctions={...t},this.stringToNumber=e,this.debug=r,this.formula=new ve(r,t,e)}search(t,e,r={},n="en-US"){const s=this.compile(t,Object.keys(r));return this.run(s,e,n,r)}run(t,e,r,n){return this.formula.search(t,e,n,r)}compile(t,e=[]){return this.debug.length=0,this.formula.compile(t,e)}}function Ae(t,e,r){return e?new class{get $name(){return t}get $fields(){return r}_add(t,e){this[t]=e}}:new class extends Array{get $name(){return t}get $fields(){return r}_add(t,e){this[t]=e}}}function be(t,e,r){const n=[];if(r instanceof Array)t._add(e,Ae(e,!1,n)),r.forEach(((r,s)=>{const i=be(t[e],s,r);n.push(...i)}));else if(null!==r&&"object"==typeof r)t._add(e,Ae(e,!0,n)),Object.keys(r).forEach((s=>{const i=be(t[e],s,r[s]);n.push(...i)}));else{const s=function(t,e,r=!1,n=!0){return new class{valueOf(){return e}toString(){return e.toString()}toJSON(){return e}get $value(){return e}get $name(){return t}get $readonly(){return r}get $required(){return n}}}(e,r);t[e]=s,n.push(s)}return n}function Se(t){if(null===t||"object"!=typeof t)return t;const e=[],r=Ae("",!Array.isArray(t),e);return Object.entries(t).forEach((([t,n])=>{e.push(...be(r,t,n))})),r}function Ie(t,e){const r=+t.replace(/\$/,"");return Number.isNaN(r)?(e&&e.push(`Failed to convert ${t} to number`),0):r}window.addEventListener("load",(()=>{const t=document.getElementById("data"),e=document.getElementById("expression"),r=document.getElementById("result"),n=document.getElementById("debug"),s=[],i=new Ye({},Ie,s),u=window.localStorage.getItem("data");u&&(t.value=u);const o=window.localStorage.getItem("expression");function c(){window.localStorage.setItem("data",t.value),window.localStorage.setItem("expression",e.value);const u=e.value,o=document.getElementById("use-fields").checked;let c;try{c=JSON.parse(t.value),o&&(c=Se(c))}catch(t){return void(r.value=t.toString())}try{const t=i.search(u,c,{});n.innerHTML=s.join("\n");let e=t;null!=t&&(e=t.valueOf.call(t)),r.value="object"==typeof e?JSON.stringify(e,null,2):e}catch(t){r.value=t.toString(),n.innerHTML=s.join("\n")}}o&&(e.value=o),t.addEventListener("blur",c),e.addEventListener("blur",c),document.getElementById("canned").addEventListener("change",(t=>{e.value=t.target.value,c()})),c(),fetch("../antlr/JSONFormula.g4").then((t=>{t.text().then((t=>{document.getElementById("grammar-out").innerHTML=t}))}))})),JSONFormula=t})();
//# sourceMappingURL=tutorial.js.map