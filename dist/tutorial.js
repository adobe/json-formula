var JSONFormula;(()=>{"use strict";var e={};(e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})})(e);const t={TYPE_NUMBER:0,TYPE_ANY:1,TYPE_STRING:2,TYPE_ARRAY:3,TYPE_OBJECT:4,TYPE_BOOLEAN:5,TYPE_EXPREF:6,TYPE_NULL:7,TYPE_ARRAY_NUMBER:8,TYPE_ARRAY_STRING:9,TYPE_CLASS:10,TYPE_ARRAY_ARRAY:11},r={TOK_EOF:"EOF",TOK_UNQUOTEDIDENTIFIER:"UnquotedIdentifier",TOK_QUOTEDIDENTIFIER:"QuotedIdentifier",TOK_RBRACKET:"Rbracket",TOK_RPAREN:"Rparen",TOK_COMMA:"Comma",TOK_COLON:"Colon",TOK_CONCATENATE:"Concatenate",TOK_RBRACE:"Rbrace",TOK_NUMBER:"Number",TOK_CURRENT:"Current",TOK_GLOBAL:"Global",TOK_FIELD:"Field",TOK_EXPREF:"Expref",TOK_PIPE:"Pipe",TOK_OR:"Or",TOK_AND:"And",TOK_ADD:"Add",TOK_SUBTRACT:"Subtract",TOK_UNARY_MINUS:"UnaryMinus",TOK_MULTIPLY:"Multiply",TOK_POWER:"Power",TOK_UNION:"Union",TOK_DIVIDE:"Divide",TOK_EQ:"EQ",TOK_GT:"GT",TOK_LT:"LT",TOK_GTE:"GTE",TOK_LTE:"LTE",TOK_NE:"NE",TOK_FLATTEN:"Flatten",TOK_STAR:"Star",TOK_FILTER:"Filter",TOK_DOT:"Dot",TOK_NOT:"Not",TOK_LBRACE:"Lbrace",TOK_LBRACKET:"Lbracket",TOK_LPAREN:"Lparen",TOK_LITERAL:"Literal"},{TYPE_NUMBER:n,TYPE_ANY:s,TYPE_STRING:i,TYPE_ARRAY:u,TYPE_OBJECT:o,TYPE_BOOLEAN:c,TYPE_EXPREF:a,TYPE_NULL:l,TYPE_ARRAY_NUMBER:h,TYPE_ARRAY_STRING:_,TYPE_CLASS:p,TYPE_ARRAY_ARRAY:d}=t,{TOK_EXPREF:T}=r,f={[n]:"number",[s]:"any",[i]:"string",[u]:"array",[o]:"object",[c]:"boolean",[a]:"expression",[l]:"null",[h]:"Array<number>",[_]:"Array<string>",[p]:"class",[d]:"Array<array>"};function E(e,t=!0){if(null===e)return l;let r=e;if(t){if("function"!=typeof e.valueOf)return o;r=e.valueOf.call(e)}switch(Object.prototype.toString.call(r)){case"[object String]":return i;case"[object Number]":return n;case"[object Array]":return u;case"[object Boolean]":return c;case"[object Null]":return l;case"[object Object]":return r.jmespathType===T?a:o;default:return o}}function y(e){return[E(e),E(e,!1)]}function g(e,t,r,a,T,E){const O=e[0];if(-1!==t.findIndex((e=>e===s||O===e)))return r;let R=!1;if((O===o||1===t.length&&t[0]===p)&&(R=!0),O===u&&1===t.length&&t[0]===o&&(R=!0),t.includes(d)){if(O===u&&(r.forEach((e=>{e instanceof Array||(R=!0)})),!R))return r;R=!0}if(R)throw new Error(`TypeError: ${a} expected argument to be type ${f[t[0]]} but received type ${f[O]} instead.`);let N=-1;if(O===u&&t.includes(_)&&t.includes(h)&&(N=r.length>0&&"string"==typeof r[0]?_:h),-1===N&&[_,h,u].includes(O)&&(N=t.find((e=>[_,h,u].includes(e)))),-1===N&&([N]=t),N===s)return r;if(N===_||N===h||N===u){if(N===u)return O===h||O===_?r:null===r?[]:[r];const t=N===h?n:i;if(O===u){const e=r.slice();for(let r=0;r<e.length;r+=1){const n=y(e[r]);e[r]=g(n,[t],e[r],a,T,E)}return e}if([n,i,l,c].includes(t))return[g(e,[t],r,a,T,E)]}else{if(N===n)return[i,c,l].includes(O)?T(r):0;if(N===i)return O===l||O===o?"":E(r);if(N===c)return!!r;if(N===o&&e[1]===o)return r}throw new Error(`TypeError: ${a} expected argument to be type ${f[t[0]]} but received type ${f[O]} instead.`)}function O(e){return null!==e&&"[object Array]"===Object.prototype.toString.call(e)}function R(e){return null!==e&&"[object Object]"===Object.prototype.toString.call(e)}function N(e){return null==e?e:O(e)?e.map((e=>N(e))):"function"!=typeof e.valueOf?e:e.valueOf()}function m(e,t){const r=N(e),n=N(t);if(r===n)return!0;if(Object.prototype.toString.call(r)!==Object.prototype.toString.call(n))return!1;if(!0===O(r)){if(r.length!==n.length)return!1;for(let e=0;e<r.length;e+=1)if(!1===m(r[e],n[e]))return!1;return!0}if(!0===R(r)){const e={};for(const t in r)if(hasOwnProperty.call(r,t)){if(!1===m(r[t],n[t]))return!1;e[t]=!0}for(const t in n)if(hasOwnProperty.call(n,t)&&!0!==e[t])return!1;return!0}return!1}const{TOK_CURRENT:P,TOK_GLOBAL:v,TOK_EXPREF:Y,TOK_PIPE:A,TOK_EQ:b,TOK_GT:S,TOK_LT:I,TOK_GTE:K,TOK_LTE:x,TOK_NE:U,TOK_FLATTEN:M}=r,{TYPE_STRING:w,TYPE_ARRAY_STRING:L,TYPE_ARRAY:B}=t;function k(e){if(null===e)return!0;const t=N(e);if(""===t||!1===t||null===t)return!0;if(O(t)&&0===t.length)return!0;if(R(t)){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}return!t}class j{constructor(e,t,r,n,s,i){this.runtime=e,this.globals=t,this.toNumber=r,this.toString=n,this.debug=s,this.language=i}search(e,t){return this.visit(e,t)}visit(e,t){const r=e&&{Field:(e,t)=>{if(null!==t&&(R(t)||O(t))){let r=t[e.name];if("function"==typeof r&&(r=void 0),void 0===r){try{this.debug.push(`Failed to find: '${e.name}'`);const r=Object.keys(t).map((e=>`'${e}'`)).toString();r.length&&this.debug.push(`Available fields: ${r}`)}catch(e){}return null}return r}return null},Subexpression:(e,t)=>{let r=this.visit(e.children[0],t);for(let t=1;t<e.children.length;t+=1)if(r=this.visit(e.children[1],r),null===r)return null;return r},IndexExpression:(e,t)=>{const r=this.visit(e.children[0],t);return this.visit(e.children[1],r)},Index:(e,t)=>{if(O(t)){let r=this.toNumber(this.visit(e.value,t));r<0&&(r=t.length+r);const n=t[r];return void 0===n?(this.debug.push(`Index ${r} out of range`),null):n}if(R(t)){const r=this.toString(this.visit(e.value,t)),n=t[r];return void 0===n?(this.debug.push(`Key ${r} does not exist`),null):n}return this.debug.push(`left side of index expression ${t} is not an array or object.`),null},Slice:(e,t)=>{if(!O(t))return null;const r=e.children.slice(0).map((e=>null!=e?this.toNumber(this.visit(e,t)):null)),n=this.computeSliceParams(t.length,r),[s,i,u]=n,o=[];if(u>0)for(let e=s;e<i;e+=u)o.push(t[e]);else for(let e=s;e>i;e+=u)o.push(t[e]);return o},Projection:(e,t)=>{const r=this.visit(e.children[0],t);if(!O(r))return null;const n=[];return r.forEach((t=>{const r=this.visit(e.children[1],t);null!==r&&n.push(r)})),n},ValueProjection:(e,t)=>{const r=this.visit(e.children[0],t);if(!R(N(r)))return null;const n=[];var s;return(s=r,Object.values(s)).forEach((t=>{const r=this.visit(e.children[1],t);null!==r&&n.push(r)})),n},FilterProjection:(e,t)=>{const r=this.visit(e.children[0],t);if(!O(r))return null;const n=r.filter((t=>!k(this.visit(e.children[2],t)))),s=[];return n.forEach((t=>{const r=this.visit(e.children[1],t);null!==r&&s.push(r)})),s},Comparator:(e,t)=>{const r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);if(e.name===b)return m(r,n);if(e.name===U)return!m(r,n);if(e.name===S)return r>n;if(e.name===K)return r>=n;if(e.name===I)return r<n;if(e.name===x)return r<=n;throw new Error(`Unknown comparator: ${e.name}`)},[M]:(e,t)=>{const r=this.visit(e.children[0],t);if(!O(r))return null;const n=[];return r.forEach((e=>{O(e)?n.push(...e):n.push(e)})),n},Identity:(e,t)=>t,MultiSelectList:(e,t)=>null===t?null:e.children.map((e=>this.visit(e,t))),MultiSelectHash:(e,t)=>{if(null===t)return null;const r={};return e.children.forEach((e=>{r[e.name]=this.visit(e.value,t)})),r},OrExpression:(e,t)=>{let r=this.visit(e.children[0],t);return k(r)&&(r=this.visit(e.children[1],t)),r},AndExpression:(e,t)=>{const r=this.visit(e.children[0],t);return!0===k(r)?r:this.visit(e.children[1],t)},AddExpression:(e,t)=>{const r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return this.applyOperator(r,n,"+")},ConcatenateExpression:(e,t)=>{let r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return r=g(y(r),[w,L],r,"concatenate",this.toNumber,this.toString),n=g(y(n),[w,L],n,"concatenate",this.toNumber,this.toString),this.applyOperator(r,n,"&")},UnionExpression:(e,t)=>{let r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return r=g(y(r),[B],r,"union",this.toNumber,this.toString),n=g(y(n),[B],n,"union",this.toNumber,this.toString),r.concat(n)},SubtractExpression:(e,t)=>{const r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return this.applyOperator(r,n,"-")},MultiplyExpression:(e,t)=>{const r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return this.applyOperator(r,n,"*")},DivideExpression:(e,t)=>{const r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return this.applyOperator(r,n,"/")},PowerExpression:(e,t)=>{const r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return this.applyOperator(r,n,"^")},NotExpression:(e,t)=>k(this.visit(e.children[0],t)),UnaryMinusExpression:(e,t)=>-1*this.visit(e.children[0],t),Literal:e=>e.value,Number:e=>e.value,[A]:(e,t)=>{const r=this.visit(e.children[0],t);return this.visit(e.children[1],r)},[P]:(e,t)=>t,[v]:e=>{const t=this.globals[e.name];return void 0===t?null:t},Function:(e,t)=>{if("if"===e.name)return this.runtime.callFunction(e.name,e.children,t,this,!1);const r=e.children.map((e=>this.visit(e,t)));return this.runtime.callFunction(e.name,r,t,this)},ExpressionReference:e=>{const[t]=e.children;return t.jmespathType=Y,t}}[e.type];if(!r)throw new Error(`Unknown/missing node type ${e&&e.type||""}`);return r(e,t)}computeSliceParams(e,t){function r(e,t,r){let n=t;return n<0?(n+=e,n<0&&(n=r<0?-1:0)):n>=e&&(n=r<0?e-1:e),n}let[n,s,i]=t;if(null===i)i=1;else if(0===i){const e=new Error("Invalid slice, step cannot be 0");throw e.name="RuntimeError",e}const u=i<0;return n=null===n?u?e-1:0:r(e,n,i),s=null===s?u?-1:e:r(e,s,i),[n,s,i]}applyOperator(e,t,r){if(O(e)&&O(t)){const n=e.length<t.length?e:t,s=Math.abs(e.length-t.length);n.length+=s,n.fill(null,n.length-s);const i=[];for(let n=0;n<e.length;n+=1)i.push(this.applyOperator(e[n],t[n],r));return i}if(O(e))return e.map((e=>this.applyOperator(e,t,r)));if(O(t))return t.map((t=>this.applyOperator(e,t,r)));if("*"===r)return this.toNumber(e)*this.toNumber(t);if("&"===r)return e+t;if("+"===r)return this.toNumber(e)+this.toNumber(t);if("-"===r)return this.toNumber(e)-this.toNumber(t);if("/"===r){const r=e/t;return Number.isFinite(r)?r:null}if("^"===r)return e**t;throw new Error(`Unknown operator: ${r}`)}}const{TOK_UNQUOTEDIDENTIFIER:C,TOK_QUOTEDIDENTIFIER:$,TOK_RBRACKET:D,TOK_RPAREN:G,TOK_COMMA:F,TOK_COLON:H,TOK_CONCATENATE:J,TOK_RBRACE:Q,TOK_NUMBER:q,TOK_CURRENT:z,TOK_GLOBAL:X,TOK_EXPREF:V,TOK_PIPE:W,TOK_OR:Z,TOK_AND:ee,TOK_ADD:te,TOK_SUBTRACT:re,TOK_UNARY_MINUS:ne,TOK_MULTIPLY:se,TOK_POWER:ie,TOK_DIVIDE:ue,TOK_UNION:oe,TOK_EQ:ce,TOK_GT:ae,TOK_LT:le,TOK_GTE:he,TOK_LTE:_e,TOK_NE:pe,TOK_FLATTEN:de,TOK_STAR:Te,TOK_FILTER:fe,TOK_DOT:Ee,TOK_NOT:ye,TOK_LBRACE:ge,TOK_LBRACKET:Oe,TOK_LPAREN:Re,TOK_LITERAL:Ne}=r,me={".":Ee,",":F,":":H,"{":ge,"}":Q,"]":D,"(":Re,")":G,"@":z},Pe={"<":!0,">":!0,"=":!0,"!":!0},ve={" ":!0,"\t":!0,"\n":!0};function Ye(e){return e>="0"&&e<="9"||"."===e}function Ae(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e>="0"&&e<="9"||"_"===e}function be(e,t){const r=e[t];return"$"===r?e.length>t&&Ae(e[t+1]):r>="a"&&r<="z"||r>="A"&&r<="Z"||"_"===r}class Se{constructor(e=[],t=[]){this._allowedGlobalNames=e,this.debug=t}tokenize(e){const t=[];let r,n,s;for(this._current=0;this._current<e.length;){const i=t.length?t.slice(-1)[0].type:null;if(this._isGlobal(i,e,this._current))t.push(this._consumeGlobal(e));else if(be(e,this._current))r=this._current,n=this._consumeUnquotedIdentifier(e),t.push({type:C,value:n,start:r});else if(void 0!==me[e[this._current]])t.push({type:me[e[this._current]],value:e[this._current],start:this._current}),this._current+=1;else if("-"!==e[this._current]||[X,z,q,G,C,$,D].includes(i))if(Ye(e[this._current]))s=this._consumeNumber(e),t.push(s);else if("["===e[this._current])s=this._consumeLBracket(e),t.push(s);else if('"'===e[this._current])r=this._current,n=this._consumeQuotedIdentifier(e),t.push({type:$,value:n,start:r});else if("'"===e[this._current])r=this._current,n=this._consumeRawStringLiteral(e),t.push({type:Ne,value:n,start:r});else if("`"===e[this._current]){r=this._current;const n=this._consumeLiteral(e);t.push({type:Ne,value:n,start:r})}else if(void 0!==Pe[e[this._current]])t.push(this._consumeOperator(e));else if(void 0!==ve[e[this._current]])this._current+=1;else if("&"===e[this._current])r=this._current,this._current+=1,"&"===e[this._current]?(this._current+=1,t.push({type:ee,value:"&&",start:r})):i===F||i===Re?t.push({type:V,value:"&",start:r}):t.push({type:J,value:"&",start:r});else if("~"===e[this._current])r=this._current,this._current+=1,t.push({type:oe,value:"~",start:r});else if("+"===e[this._current])r=this._current,this._current+=1,t.push({type:te,value:"+",start:r});else if("-"===e[this._current])r=this._current,this._current+=1,t.push({type:re,value:"-",start:r});else if("*"===e[this._current]){r=this._current,this._current+=1;const e=t.length&&t.slice(-1)[0].type;0===t.length||[Oe,Ee,W,ee,Z,F,H].includes(e)?t.push({type:Te,value:"*",start:r}):t.push({type:se,value:"*",start:r})}else if("/"===e[this._current])r=this._current,this._current+=1,t.push({type:ue,value:"/",start:r});else if("^"===e[this._current])r=this._current,this._current+=1,t.push({type:ie,value:"^",start:r});else{if("|"!==e[this._current]){const t=new Error(`Unknown character:${e[this._current]}`);throw t.name="LexerError",t}r=this._current,this._current+=1,"|"===e[this._current]?(this._current+=1,t.push({type:Z,value:"||",start:r})):t.push({type:W,value:"|",start:r})}else s=this._consumeUnaryMinus(e),t.push(s)}return t}_consumeUnquotedIdentifier(e){const t=this._current;for(this._current+=1;this._current<e.length&&Ae(e[this._current]);)this._current+=1;return e.slice(t,this._current)}_consumeQuotedIdentifier(e){const t=this._current;this._current+=1;const r=e.length;let n=!be(e,t+1);for(;'"'!==e[this._current]&&this._current<r;){let t=this._current;Ae(e[t])||(n=!0),"\\"!==e[t]||"\\"!==e[t+1]&&'"'!==e[t+1]?t+=1:t+=2,this._current=t}this._current+=1;const s=e.slice(t,this._current);try{n&&!s.includes(" ")||(this.debug.push(`Suspicious quotes: ${s}`),this.debug.push(`Did you intend a literal? '${s.replace(/"/g,"")}'?`))}catch(e){}return JSON.parse(s)}_consumeRawStringLiteral(e){const t=this._current;this._current+=1;const r=e.length;for(;"'"!==e[this._current]&&this._current<r;){let t=this._current;"\\"!==e[t]||"\\"!==e[t+1]&&"'"!==e[t+1]?t+=1:t+=2,this._current=t}return this._current+=1,e.slice(t+1,this._current-1).replaceAll("\\'","'")}_consumeNumber(e){const t=this._current;this._current+=1;const r=e.length;for(;Ye(e[this._current])&&this._current<r;)this._current+=1;const n=e.slice(t,this._current);let s;return s=n.includes(".")?parseFloat(n):parseInt(n,10),{type:q,value:s,start:t}}_consumeUnaryMinus(){const e=this._current;return this._current+=1,{type:ne,value:"-",start:e}}_consumeLBracket(e){const t=this._current;return this._current+=1,"?"===e[this._current]?(this._current+=1,{type:fe,value:"[?",start:t}):"]"===e[this._current]?(this._current+=1,{type:de,value:"[]",start:t}):{type:Oe,value:"[",start:t}}_isGlobal(e,t,r){if(null!==e&&e===Ee)return!1;if("$"!==t[r])return!1;let n=r+1;for(;n<t.length&&Ae(t[n]);)n+=1;const s=t.slice(r,n);return this._allowedGlobalNames.includes(s)}_consumeGlobal(e){const t=this._current;for(this._current+=1;this._current<e.length&&Ae(e[this._current]);)this._current+=1;const r=e.slice(t,this._current);return{type:X,name:r,start:t}}_consumeOperator(e){const t=this._current,r=e[t];return this._current+=1,"!"===r?"="===e[this._current]?(this._current+=1,{type:pe,value:"!=",start:t}):{type:ye,value:"!",start:t}:"<"===r?"="===e[this._current]?(this._current+=1,{type:_e,value:"<=",start:t}):{type:le,value:"<",start:t}:">"===r?"="===e[this._current]?(this._current+=1,{type:he,value:">=",start:t}):{type:ae,value:">",start:t}:"="===e[this._current]?(this._current+=1,{type:ce,value:"==",start:t}):{type:ce,value:"=",start:t}}_consumeLiteral(e){this._current+=1;const t=this._current,r=e.length;let n,s=!1;for(;(s||"`"!==e[this._current])&&this._current<r;){let t=this._current;s&&"\\"===e[t]&&'"'===e[t+1]?t+=2:('"'===e[t]&&(s=!s),s&&"`"===e[t+1]?t+=2:"\\"!==e[t]||"\\"!==e[t+1]&&"`"!==e[t+1]?t+=1:t+=2),this._current=t}let i=e.slice(t,this._current).trimStart();return i=i.replaceAll("\\`","`"),n=function(e){if(""===e)return!1;if('[{"'.includes(e[0]))return!0;if(["true","false","null"].includes(e))return!0;if(!"-0123456789".includes(e[0]))return!1;try{return JSON.parse(e),!0}catch(e){return!1}}(i)?JSON.parse(i):JSON.parse(`"${i}"`),this._current+=1,n}}const{TOK_LITERAL:Ie,TOK_COLON:Ke,TOK_EOF:xe,TOK_UNQUOTEDIDENTIFIER:Ue,TOK_QUOTEDIDENTIFIER:Me,TOK_RBRACKET:we,TOK_RPAREN:Le,TOK_COMMA:Be,TOK_CONCATENATE:ke,TOK_RBRACE:je,TOK_NUMBER:Ce,TOK_CURRENT:$e,TOK_GLOBAL:De,TOK_FIELD:Ge,TOK_EXPREF:Fe,TOK_PIPE:He,TOK_OR:Je,TOK_AND:Qe,TOK_ADD:qe,TOK_SUBTRACT:ze,TOK_UNARY_MINUS:Xe,TOK_MULTIPLY:Ve,TOK_POWER:We,TOK_DIVIDE:Ze,TOK_UNION:et,TOK_EQ:tt,TOK_GT:rt,TOK_LT:nt,TOK_GTE:st,TOK_LTE:it,TOK_NE:ut,TOK_FLATTEN:ot,TOK_STAR:ct,TOK_FILTER:at,TOK_DOT:lt,TOK_NOT:ht,TOK_LBRACE:_t,TOK_LBRACKET:pt,TOK_LPAREN:dt}=r,Tt={[xe]:0,[Ue]:0,[Me]:0,[we]:0,[Le]:0,[Be]:0,[je]:0,[Ce]:0,[$e]:0,[De]:0,[Ge]:0,[Fe]:0,[He]:1,[Je]:2,[Qe]:3,[ke]:5,[qe]:6,[ze]:6,[Ve]:7,[Ze]:7,[We]:7,[et]:7,[tt]:5,[rt]:5,[nt]:5,[st]:5,[it]:5,[ut]:5,[ot]:9,[ct]:20,[at]:21,[lt]:40,[ht]:30,[Xe]:30,[_t]:50,[pt]:55,[dt]:60};class ft{constructor(e=[]){this._allowedGlobalNames=e}parse(e,t){this._loadTokens(e,t),this.index=0;const r=this.expression(0);if(this._lookahead(0)!==xe){const e=this._lookaheadToken(0),t=new Error(`Unexpected token type: ${e.type}, value: ${e.value}`);throw t.name="ParserError",t}return r}_loadTokens(e,t){const r=new Se(this._allowedGlobalNames,t).tokenize(e);r.push({type:xe,value:"",start:e.length}),this.tokens=r}expression(e){const t=this._lookaheadToken(0);this._advance();let r=this.nud(t),n=this._lookahead(0);for(;e<Tt[n];)this._advance(),r=this.led(n,r),n=this._lookahead(0);return r}_lookahead(e){return this.tokens[this.index+e].type}_lookaheadToken(e){return this.tokens[this.index+e]}_advance(){this.index+=1}_getIndex(){return this.index}_setIndex(e){this.index=e}nud(e){let t,r,n,s,i;switch(e.type){case Ie:return{type:"Literal",value:e.value};case Ce:return{type:"Number",value:e.value};case Ue:return{type:"Field",name:e.value};case Me:if(s={type:"Field",name:e.value},this._lookahead(0)===dt)throw new Error("Quoted identifier not allowed for function names.");return s;case ht:return r=this.expression(Tt.Not),{type:"NotExpression",children:[r]};case Xe:return r=this.expression(Tt.UnaryMinus),{type:"UnaryMinusExpression",children:[r]};case ct:return t={type:"Identity"},r=this._lookahead(0)===we?{type:"Identity"}:this._parseProjectionRHS(Tt.Star),{type:"ValueProjection",children:[t,r]};case at:return this.led(e.type,{type:"Identity"});case _t:return this._parseMultiselectHash();case ot:return t={type:ot,children:[{type:"Identity"}]},r=this._parseProjectionRHS(Tt.Flatten),{type:"Projection",children:[t,r]};case pt:return this._lookahead(0)===ct&&this._lookahead(1)===we?(this._advance(),this._advance(),r=this._parseProjectionRHS(Tt.Star),{type:"Projection",children:[{type:"Identity"},r]}):this._parseUnchainedIndexExpression();case $e:return{type:$e};case De:return{type:De,name:e.name};case Ge:return{type:Ge};case Fe:return n=this.expression(Tt.Expref),{type:"ExpressionReference",children:[n]};case dt:for(i=[];this._lookahead(0)!==Le;)n=this.expression(0),i.push(n);return this._match(Le),i[0];default:this._errorToken(e)}}led(e,t){let r,n,s,i,u,o,c,a,l;switch(e){case ke:return n=this.expression(Tt.Concatenate),{type:"ConcatenateExpression",children:[t,n]};case lt:return c=Tt.Dot,this._lookahead(0)!==ct?(n=this._parseDotRHS(c),{type:"Subexpression",children:[t,n]}):(this._advance(),n=this._parseProjectionRHS(c),{type:"ValueProjection",children:[t,n]});case He:return n=this.expression(Tt.Pipe),{type:He,children:[t,n]};case Je:return n=this.expression(Tt.Or),{type:"OrExpression",children:[t,n]};case Qe:return n=this.expression(Tt.And),{type:"AndExpression",children:[t,n]};case qe:return n=this.expression(Tt.Add),{type:"AddExpression",children:[t,n]};case ze:return n=this.expression(Tt.Subtract),{type:"SubtractExpression",children:[t,n]};case Ve:return n=this.expression(Tt.Multiply),{type:"MultiplyExpression",children:[t,n]};case Ze:return n=this.expression(Tt.Divide),{type:"DivideExpression",children:[t,n]};case We:return n=this.expression(Tt.Power),{type:"PowerExpression",children:[t,n]};case et:return n=this.expression(Tt.Power),{type:"UnionExpression",children:[t,n]};case dt:for(s=t.name,i=[];this._lookahead(0)!==Le;)u=this.expression(0),this._lookahead(0)===Be&&this._match(Be),i.push(u);return this._match(Le),o={type:"Function",name:s,children:i},o;case at:return r=this.expression(0),this._match(we),n=this._lookahead(0)===ot?{type:"Identity"}:this._parseProjectionRHS(Tt.Filter),{type:"FilterProjection",children:[t,n,r]};case ot:return a={type:ot,children:[t]},l=this._parseProjectionRHS(Tt.Flatten),{type:"Projection",children:[a,l]};case tt:case ut:case rt:case st:case nt:case it:return this._parseComparator(t,e);case pt:return this._lookahead(0)===ct&&this._lookahead(1)===we?(this._advance(),this._advance(),n=this._parseProjectionRHS(Tt.Star),{type:"Projection",children:[t,n]}):(n=this._parseChainedIndexExpression(),this._projectIfSlice(t,n));default:this._errorToken(this._lookaheadToken(0))}}_match(e){if(this._lookahead(0)!==e){const t=this._lookaheadToken(0),r=new Error(`Expected ${e}, got: ${t.type}`);throw r.name="ParserError",r}this._advance()}_errorToken(e){const t=new Error(`Invalid token (${e.type}): "${e.value}"`);throw t.name="ParserError",t}_parseChainedIndexExpression(){const e=this._getIndex();if(this._lookahead(0)===Ke)return this._parseSliceExpression();const t=this.expression(0);return this._lookahead(0)===Ke?(this._setIndex(e),this._parseSliceExpression()):(this._match(we),{type:"Index",value:t})}_parseUnchainedIndexExpression(){const e=this._getIndex(),t=this._lookahead(0);if(t===Ke){const e=this._parseSliceExpression();return this._projectIfSlice({type:"Identity"},e)}const r=this.expression(0),n=this._lookahead(0);if(n===Be)return this._setIndex(e),this._parseMultiselectList();if(n===Ke){this._setIndex(e);const t=this._parseSliceExpression();return this._projectIfSlice({type:"Identity"},t)}return t===Ce||t===Xe?(this._match(we),{type:"Index",value:r}):(this._setIndex(e),this._parseMultiselectList())}_projectIfSlice(e,t){const r={type:"IndexExpression",children:[e,t]};return"Slice"===t.type?{type:"Projection",children:[r,this._parseProjectionRHS(Tt.Star)]}:r}_parseSliceExpression(){const e=[null,null,null];let t=0,r=this._lookahead(0);for(;r!==we&&t<3;){if(r===Ke&&t<2)t+=1,this._advance();else{e[t]=this.expression(0);const r=this._lookahead(0);if(r!==Ke&&r!==we){const e=new Error(`Syntax error, unexpected token: ${r.value}(${r.type})`);throw e.name="Parsererror",e}}r=this._lookahead(0)}return this._match(we),{type:"Slice",children:e}}_parseComparator(e,t){return{type:"Comparator",name:t,children:[e,this.expression(Tt[t])]}}_parseDotRHS(e){const t=this._lookahead(0);return[Ue,Me,ct].indexOf(t)>=0?this.expression(e):t===pt?(this._match(pt),this._parseMultiselectList()):t===_t?(this._match(_t),this._parseMultiselectHash()):void 0}_parseProjectionRHS(e){let t;if(Tt[this._lookahead(0)]<10)t={type:"Identity"};else if(this._lookahead(0)===pt)t=this.expression(e);else if(this._lookahead(0)===at)t=this.expression(e);else{if(this._lookahead(0)!==lt){const e=this._lookaheadToken(0),t=new Error(`Sytanx error, unexpected token: ${e.value}(${e.type})`);throw t.name="ParserError",t}this._match(lt),t=this._parseDotRHS(e)}return t}_parseMultiselectList(){const e=[];for(;this._lookahead(0)!==we;){const t=this.expression(0);if(e.push(t),this._lookahead(0)===Be&&(this._match(Be),this._lookahead(0)===we))throw new Error("Unexpected token Rbracket")}return this._match(we),{type:"MultiSelectList",children:e}}_parseMultiselectHash(){const e=[],t=[Ue,Me];let r,n,s,i;if(this._lookahead(0)===je)return this._advance(),{type:"MultiSelectHash",children:[]};for(;;){if(r=this._lookaheadToken(0),t.indexOf(r.type)<0)throw new Error(`Expecting an identifier token, got: ${r.type}`);if(n=r.value,this._advance(),this._match(Ke),s=this.expression(0),i={type:"KeyValuePair",name:n,value:s},e.push(i),this._lookahead(0)===Be)this._match(Be);else if(this._lookahead(0)===je){this._match(je);break}}return{type:"MultiSelectHash",children:e}}}function Et(e,t){const r=10**t;return Math.round(e*r)/r}const yt=864e5;const{TYPE_CLASS:gt,TYPE_ANY:Ot}=t;function Rt(e){return null==e?"":e.toString()}const Nt=e=>{const t=+e;return Number.isNaN(t)?0:t};class mt{constructor(e,r,n={}){this.strictDeepEqual=m,this.toNumber=r,this.functionTable=function(e,r,n,s,i,u,o,c){const{TYPE_NUMBER:a,TYPE_ANY:l,TYPE_STRING:h,TYPE_ARRAY:_,TYPE_OBJECT:p,TYPE_BOOLEAN:d,TYPE_EXPREF:T,TYPE_NULL:f,TYPE_ARRAY_NUMBER:E,TYPE_ARRAY_STRING:y}=t;function g(t,r){return n=>{const s=e.interpreter.visit(t,n);if(r.indexOf(i(s))<0){const e=`TypeError: expected one of ${r}, received ${i(s)}`;throw new Error(e)}return s}}const O={abs:{_func:e=>Math.abs(e[0]),_signature:[{types:[a]}]},avg:{_func:e=>{let t=0;const r=e[0];return r.forEach((e=>{t+=e})),t/r.length},_signature:[{types:[E]}]},ceil:{_func:e=>Math.ceil(e[0]),_signature:[{types:[a]}]},contains:{_func:e=>u(e[0]).indexOf(u(e[1]))>=0,_signature:[{types:[h,_]},{types:[l]}]},endsWith:{_func:e=>{const t=u(e[0]),r=u(e[1]);return-1!==t.indexOf(r,t.length-r.length)},_signature:[{types:[h]},{types:[h]}]},floor:{_func:e=>Math.floor(e[0]),_signature:[{types:[a]}]},join:{_func:e=>{const t=e[0];return e[1].join(t)},_signature:[{types:[h]},{types:[y]}]},keys:{_func:e=>null===e[0]?[]:Object.keys(e[0]),_signature:[{types:[l]}]},length:{_func:e=>{const t=u(e[0]);return r(t)?Object.keys(t).length:n(t)?t.length:o(t).length},_signature:[{types:[h,_,p]}]},map:{_func:t=>{const r=t[0];return t[1].map((t=>e.interpreter.visit(r,t)))},_signature:[{types:[T]},{types:[_]}]},max:{_func:e=>{let t=e.reduce(((e,t)=>null!==e?e:Array.isArray(t)?t.length>0?t[0]:e:t),null);if(null===t)return null;const r=i(t),n=(e,t)=>r===a?s(e)<=s(t)?t:e:1===o(e).localeCompare(o(t))?e:t;return e.forEach((e=>{t=Array.isArray(e)?e.reduce(n,t):n(t,e)})),t},_signature:[{types:[_,E,y],variadic:!0}]},maxBy:{_func:e=>{const t=e[1],r=e[0],n=g(t,[a,h]);let s,i,u=-1/0;return r.forEach((e=>{i=n(e),i>u&&(u=i,s=e)})),s},_signature:[{types:[_]},{types:[T]}]},merge:{_func:e=>{const t={};return e.forEach((e=>{Object.entries(e||{}).forEach((([e,r])=>{t[e]=r}))})),t},_signature:[{types:[p],variadic:!0}]},min:{_func:e=>{let t=e.reduce(((e,t)=>null!==e?e:Array.isArray(t)?t.length>0?t[0]:e:t),null);if(null===t)return null;const r=i(t),n=(e,t)=>r===a?s(e)<=s(t)?e:t:1===o(e).localeCompare(o(t))?t:e;return e.forEach((e=>{t=Array.isArray(e)?e.reduce(n,t):n(t,e)})),t},_signature:[{types:[_,E,y],variadic:!0}]},minBy:{_func:e=>{const t=e[1],r=e[0],n=g(t,[a,h]);let s,i,u=1/0;return r.forEach((e=>{i=n(e),i<u&&(u=i,s=e)})),s},_signature:[{types:[_]},{types:[T]}]},notNull:{_func:e=>e.find((e=>i(e)!==f))||null,_signature:[{types:[l],variadic:!0}]},reduce:{_func:t=>{const r=t[0];return t[1].reduce(((t,n,s,i)=>e.interpreter.visit(r,{accumulated:t,current:n,index:s,array:i})),3===t.length?t[2]:null)},_signature:[{types:[T]},{types:[_]},{types:[l],optional:!0}]},register:{_func:t=>{const r=t[0],n=t[1];return O[r]?(c.push(`Cannot re-register '${r}'`),{}):(O[r]={_func:t=>e.interpreter.visit(n,...t),_signature:[{types:[l],optional:!0}]},{})},_signature:[{types:[h]},{types:[T]}]},reverse:{_func:e=>{const t=u(e[0]);if(i(t)===h){let e="";for(let r=t.length-1;r>=0;r-=1)e+=t[r];return e}const r=e[0].slice(0);return r.reverse(),r},_signature:[{types:[h,_]}]},sort:{_func:e=>{const t=e[0].slice(0);if(t.length>0){const r=i(e[0][0])===a?s:o;t.sort(((e,t)=>{const n=r(e),s=r(t);return n<s?-1:n>s?1:0}))}return t},_signature:[{types:[_,y,E]}]},sortBy:{_func:t=>{const r=t[0].slice(0);if(0===r.length)return r;const n=t[1],s=i(e.interpreter.visit(n,r[0]));if([a,h].indexOf(s)<0)throw new Error("TypeError");const u=[];for(let e=0;e<r.length;e+=1)u.push([e,r[e]]);u.sort(((t,r)=>{const u=e.interpreter.visit(n,t[1]),o=e.interpreter.visit(n,r[1]);if(i(u)!==s)throw new Error(`TypeError: expected ${s}, received ${i(u)}`);if(i(o)!==s)throw new Error(`TypeError: expected ${s}, received ${i(o)}`);return u>o?1:u<o?-1:t[0]-r[0]}));for(let e=0;e<u.length;e+=1)[,r[e]]=u[e];return r},_signature:[{types:[_]},{types:[T]}]},startsWith:{_func:e=>u(e[0]).startsWith(u(e[1])),_signature:[{types:[h]},{types:[h]}]},sum:{_func:e=>{let t=0;return e[0].forEach((e=>{t+=1*e})),t},_signature:[{types:[E]}]},toArray:{_func:e=>i(e[0])===_?e[0]:[e[0]],_signature:[{types:[l]}]},toNumber:{_func:e=>{const t=i(e[0]);return t===a?e[0]:t===h?s(e[0]):null},_signature:[{types:[l]}]},toString:{_func:e=>i(e[0])===h?e[0]:JSON.stringify(e[0]),_signature:[{types:[l]}]},type:{_func:e=>({[a]:"number",[h]:"string",[_]:"array",[p]:"object",[d]:"boolean",[T]:"expref",[f]:"null"}[i(e[0])]),_signature:[{types:[l]}]},values:{_func:e=>{const t=u(e[0]);return null===t?[]:Object.values(t)},_signature:[{types:[l]}]},zip:{_func:e=>{const t=e.reduce(((e,t)=>Math.min(e,t.length)),e[0].length),r=new Array(t);for(let n=0;n<t;n+=1)r[n]=[],e.forEach((e=>{r[n].push(e[n])}));return r},_signature:[{types:[_],variadic:!0}]}};return O}(this,R,O,r,E,N,Rt,e),Object.entries(function(e,r,n,s=[]){return{and:{_func:t=>{let r=!!e(t[0]);return t.slice(1).forEach((t=>{r=r&&!!e(t)})),r},_signature:[{types:[t.TYPE_ANY],variadic:!0}]},casefold:{_func:(e,t,n)=>r(e[0]).toLocaleUpperCase(n.language).toLocaleLowerCase(n.language),_signature:[{types:[t.TYPE_STRING]}]},datedif:{_func:e=>{const t=n(e[0]),s=n(e[1]),i=r(e[2]).toLowerCase();if(s===t)return 0;if(s<t)return null;if("d"===i)return Math.floor(s-t);const u=new Date(t*yt),o=new Date(s*yt),c=o.getFullYear()-u.getFullYear();let a=o.getMonth()-u.getMonth();const l=o.getDate()-u.getDate();if("y"===i){let e=c;return a<0&&(e-=1),0===a&&l<0&&(e-=1),e}if("m"===i)return 12*c+a+(l<0?-1:0);if("ym"===i)return l<0&&(a-=1),a<=0&&c>0?12+a:a;if("yd"===i)return l<0&&(a-=1),a<0?o.setFullYear(u.getFullYear()+1):o.setFullYear(u.getFullYear()),Math.floor((o.getTime()-u.getTime())/yt);throw new TypeError(`Unrecognized unit parameter "${i}" for datedif()`)},_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_STRING]}]},datetime:{_func:e=>{const t=n(e[0]),s=n(e[1]),i=n(e[2]),u=e.length>3?n(e[3]):0,o=e.length>4?n(e[4]):0,c=e.length>5?n(e[5]):0,a=e.length>6?n(e[6]):0,l=e.length>7?r(e[7]):null;let h=new Date(t,s-1,i,u,o,c,a);return l&&(h=function(e,t){if(null===e)return null;let r=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),e.getMilliseconds());return r+=function(e,t){const r=new Intl.DateTimeFormat("en-US",{timeZone:t,timeZoneName:"longOffset"}).format(e),n=/GMT([+\-âˆ’])?(\d{1,2}):?(\d{0,2})?/.exec(r);if(!n)return 0;const[s,i,u]=n.slice(1),o=60*(60*(i||0)+1*(u||0))*1e3;return"-"===s?-1*o:o}(e,t),new Date(r)}(h,l)),h.getTime()/yt},_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER],optional:!0},{types:[t.TYPE_NUMBER],optional:!0},{types:[t.TYPE_NUMBER],optional:!0},{types:[t.TYPE_NUMBER],optional:!0},{types:[t.TYPE_STRING],optional:!0}]},day:{_func:e=>{const t=n(e[0]);return new Date(t*yt).getDate()},_signature:[{types:[t.TYPE_NUMBER]}]},deepScan:{_func:e=>{const[t,r]=e,n=r.toString(),s=[];return null===t||function e(t){Object.entries(t).forEach((([t,r])=>{t===n&&s.push(r),"object"==typeof r&&e(r)}))}(t),s},_signature:[{types:[t.TYPE_OBJECT,t.TYPE_ARRAY,t.TYPE_NULL]},{types:[t.TYPE_STRING,t.TYPE_NUMBER]}]},entries:{_func:t=>{const r=e(t[0]);return Object.entries(r)},_signature:[{types:[t.TYPE_NUMBER,t.TYPE_STRING,t.TYPE_ARRAY,t.TYPE_OBJECT,t.TYPE_BOOLEAN]}]},eomonth:{_func:e=>{const t=n(e[0]),r=n(e[1]),s=new Date(t*yt);return new Date(s.getFullYear(),s.getMonth()+r+1,0).getTime()/yt},_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]}]},exp:{_func:e=>{const t=n(e[0]);return Math.exp(t)},_signature:[{types:[t.TYPE_NUMBER]}]},false:{_func:()=>!1,_signature:[]},find:{_func:e=>{const t=r(e[0]),s=r(e[1]),i=e.length>2?n(e[2]):0,u=s.indexOf(t,i);return-1===u?null:u},_signature:[{types:[t.TYPE_STRING]},{types:[t.TYPE_STRING]},{types:[t.TYPE_NUMBER],optional:!0}]},fromEntries:{_func:e=>{const t=e[0];return Object.fromEntries(t)},_signature:[{types:[t.TYPE_ARRAY_ARRAY]}]},hour:{_func:e=>{const t=n(e[0])%1;if(t<0)return null;const r=Et(24*t,14);return Math.floor(r%24)},_signature:[{types:[t.TYPE_NUMBER]}]},if:{_func:(t,r,n)=>{const s=t[0],i=t[1],u=t[2],o=n.visit(s,r);return e(o)?n.visit(i,r):n.visit(u,r)},_signature:[{types:[t.TYPE_ANY]},{types:[t.TYPE_ANY]},{types:[t.TYPE_ANY]}]},left:{_func:e=>{const t=e.length>1?n(e[1]):1;return t<0?null:e[0]instanceof Array?e[0].slice(0,t):r(e[0]).substr(0,t)},_signature:[{types:[t.TYPE_STRING,t.TYPE_ARRAY]},{types:[t.TYPE_NUMBER],optional:!0}]},lower:{_func:e=>r(e[0]).toLowerCase(),_signature:[{types:[t.TYPE_STRING]}]},mid:{_func:e=>{const t=n(e[1]),s=n(e[2]);return t<0?null:e[0]instanceof Array?e[0].slice(t,t+s):r(e[0]).substr(t,s)},_signature:[{types:[t.TYPE_STRING,t.TYPE_ARRAY]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]}]},minute:{_func:e=>{const t=n(e[0])%1;if(t<0)return null;const r=Math.round(1440*t,10);return Math.floor(r%60)},_signature:[{types:[t.TYPE_NUMBER]}]},mod:{_func:e=>n(e[0])%n(e[1]),_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]}]},month:{_func:e=>{const t=n(e[0]);return new Date(t*yt).getMonth()+1},_signature:[{types:[t.TYPE_NUMBER]}]},not:{_func:t=>!e(t[0]),_signature:[{types:[t.TYPE_ANY]}]},now:{_func:()=>Date.now()/yt,_signature:[]},null:{_func:()=>null,_signature:[]},or:{_func:t=>{let r=!!e(t[0]);return t.slice(1).forEach((t=>{r=r||!!e(t)})),r},_signature:[{types:[t.TYPE_ANY],variadic:!0}]},power:{_func:e=>n(e[0])**n(e[1]),_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]}]},proper:{_func:e=>r(e[0]).split(" ").map((e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase())).join(" "),_signature:[{types:[t.TYPE_STRING]}]},replace:{_func:e=>{const t=r(e[0]),s=n(e[1]),i=n(e[2]),u=r(e[3]);return s<0?null:t.substr(0,s)+u+t.substr(s+i)},_signature:[{types:[t.TYPE_STRING]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_STRING]}]},rept:{_func:e=>{const t=r(e[0]),s=n(e[1]);return s<0?null:t.repeat(s)},_signature:[{types:[t.TYPE_STRING]},{types:[t.TYPE_NUMBER]}]},right:{_func:e=>{const t=e.length>1?n(e[1]):1;if(t<0)return null;if(e[0]instanceof Array)return 0===t?[]:e[0].slice(-1*t);const s=r(e[0]),i=s.length-t;return s.substr(i,t)},_signature:[{types:[t.TYPE_STRING,t.TYPE_ARRAY]},{types:[t.TYPE_NUMBER],optional:!0}]},round:{_func:e=>Et(n(e[0]),n(e[1])),_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]}]},search:{_func:e=>{const t=r(e[0]),s=r(e[1]),i=n(e[2]);if(null===t||null===s||0===s.length)return[];const u=t.replace(/([[.\\^$()+{])/g,"\\$1").replace(/~?\?/g,(e=>"~?"===e?"\\?":".")).replace(/~?\*/g,(e=>"~*"===e?"\\*":".*?")).replace(/~~/g,"~"),o=new RegExp(u),c=s.substring(i).match(o);return null===c?[]:[c.index+i,c[0]]},_signature:[{types:[t.TYPE_STRING]},{types:[t.TYPE_STRING]},{types:[t.TYPE_NUMBER],optional:!0}]},second:{_func:e=>{const t=n(e[0])%1;if(t<0)return null;const r=Et(86400*t,10);return Math.floor(r%60)},_signature:[{types:[t.TYPE_NUMBER]}]},split:{_func:e=>{const t=r(e[0]),n=r(e[1]);return t.split(n)},_signature:[{types:[t.TYPE_STRING]},{types:[t.TYPE_STRING]}]},sqrt:{_func:e=>{const t=Math.sqrt(n(e[0]));return Number.isNaN(t)?null:t},_signature:[{types:[t.TYPE_NUMBER]}]},stdev:{_func:e=>{const t=e[0]||[];if(t.length<=1)return null;const r=t.map((e=>n(e))),s=r.reduce(((e,t)=>e+t),0)/t.length,i=r.reduce(((e,t)=>e+t*t),0),u=Math.sqrt((i-t.length*s*s)/(t.length-1));return Number.isNaN(u)?null:u},_signature:[{types:[t.TYPE_ARRAY_NUMBER]}]},stdevp:{_func:e=>{const t=e[0]||[];if(0===t.length)return null;const r=t.map((e=>n(e))),s=r.reduce(((e,t)=>e+t),0)/t.length,i=r.reduce(((e,t)=>e+t*t),0)/t.length,u=Math.sqrt(i-s*s);return Number.isNaN(u)?null:u},_signature:[{types:[t.TYPE_ARRAY_NUMBER]}]},substitute:{_func:e=>{const t=r(e[0]),s=r(e[1]),i=r(e[2]);if(e.length<=3)return t.replaceAll(s,i);const u=n(e[3]);if(u<1)return t;let o=-1;for(let e=0;e<u;e+=1){o+=1;const e=t.slice(o).indexOf(s);if(-1===e)return t;o+=e}return t.slice(0,o)+t.slice(o).replace(s,i)},_signature:[{types:[t.TYPE_STRING]},{types:[t.TYPE_STRING]},{types:[t.TYPE_STRING]},{types:[t.TYPE_NUMBER],optional:!0}]},time:{_func:e=>{const t=(3600*n(e[0])+60*n(e[1])+n(e[2]))/86400;return t<0?null:t-Math.floor(t)},_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER]}]},today:{_func:()=>Math.floor(Date.now()/yt),_signature:[]},trim:{_func:e=>r(e[0]).split(" ").filter((e=>e)).join(" "),_signature:[{types:[t.TYPE_STRING]}]},true:{_func:()=>!0,_signature:[]},trunc:{_func:e=>{const t=n(e[0]),r=e.length>1?n(e[1]):0;return(t>=0?Math.floor:Math.ceil)(t*10**r)/10**r},_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER],optional:!0}]},unique:{_func:t=>{const r=t[0].map((t=>e(t)));return t[0].filter(((t,n)=>r.indexOf(e(t))===n))},_signature:[{types:[t.TYPE_ARRAY]}]},upper:{_func:e=>r(e[0]).toUpperCase(),_signature:[{types:[t.TYPE_STRING]}]},value:{_func:e=>{const t=e[0]||{},r=e[1],n=t[r];if(void 0===n){s.push(`Failed to find: '${r}'`);const e=Object.keys(t).map((e=>`'${e}'`)).toString();return e.length&&s.push(`Available fields: ${e}`),null}return n},_signature:[{types:[t.TYPE_OBJECT,t.TYPE_ARRAY,t.TYPE_NULL]},{types:[t.TYPE_STRING,t.TYPE_NUMBER]}]},weekday:{_func:e=>{const t=n(e[0]),r=e.length>1?n(e[1]):1,s=new Date(t*yt).getDay();switch(r){case 1:return s+1;case 2:return(s+6)%7+1;case 3:return(s+6)%7;default:return null}},_signature:[{types:[t.TYPE_NUMBER]},{types:[t.TYPE_NUMBER],optional:!0}]},year:{_func:e=>{const t=n(e[0]);return new Date(t*yt).getFullYear()},_signature:[{types:[t.TYPE_NUMBER]}]},charCode:{_func:e=>{const t=n(e[0]);return Number.isInteger(t)?String.fromCharCode(t):null},_signature:[{types:[t.TYPE_NUMBER]}]},codePoint:{_func:e=>{const t=r(e[0]);return 0===t.length?null:t.codePointAt(0)},_signature:[{types:[t.TYPE_STRING]}]},encodeUrlComponent:{_func:e=>encodeURIComponent(e[0]),_signature:[{types:[t.TYPE_STRING]}]},encodeUrl:{_func:e=>encodeURI(e[0]),_signature:[{types:[t.TYPE_STRING]}]},decodeUrlComponent:{_func:e=>decodeURIComponent(e[0]),_signature:[{types:[t.TYPE_STRING]}]},decodeUrl:{_func:e=>decodeURI(e[0]),_signature:[{types:[t.TYPE_STRING]}]}}}(N,Rt,r,e)).forEach((([e,t])=>{this.functionTable[e]=t})),Object.entries(n).forEach((([e,t])=>{this.functionTable[e]=t}))}_validateArgs(e,t,r,n){if(0===r.length)return;let s;const i=r.filter((e=>!e.optional)).length;if(r[r.length-1].variadic){if(t.length<r.length)throw s=1===r.length?" argument":" arguments",new Error(`ArgumentError: ${e}() takes at least${r.length}${s} but received ${t.length}`)}else if(t.length<i||t.length>r.length)throw s=1===r.length?" argument":" arguments",new Error(`ArgumentError: ${e}() takes ${r.length}${s} but received ${t.length}`);if(!n)return;let u,o;const c=Math.min(r.length,t.length);for(let n=0;n<c;n+=1)u=r[n].types,a=t[n],l=void 0,u.includes(gt)&&null!==(l=a)&&!Array.isArray(l)&&"Object"!==l.constructor.name||u.includes(Ot)||(o=y(t[n]),t[n]=g(o,u,t[n],e,this.toNumber,Rt));var a,l}callFunction(e,t,r,n,s=!0){if(!Object.prototype.hasOwnProperty.call(this.functionTable,e))throw new Error(`Unknown function: ${e}()`);const i=this.functionTable[e];return this._validateArgs(e,t,i._signature,s),i._func.call(this,t,r,n)}}class Pt{constructor(e,t,r){this.debug=e,this.toNumber=function(e,t=[]){return r=>{const n=N(r);if(null===n)return null;if(n instanceof Array)return t.push("Converted array to zero"),0;const s=typeof n;return"number"===s?n:"string"===s?e(n,t):"boolean"===s?n?1:0:(t.push("Converted object to zero"),0)}}(r||Nt,e),this.runtime=new mt(e,this.toNumber,t)}compile(e,t=[]){let r;try{r=new ft(t).parse(e,this.debug)}catch(e){throw this.debug.push(e.toString()),e}return r}search(e,t,r={},n="en-US"){this.runtime.interpreter=new j(this.runtime,r,this.toNumber,Rt,this.debug,n);try{return this.runtime.interpreter.search(e,t)}catch(e){throw this.debug.push(e.message||e.toString()),e}}}class vt{constructor(e={},t=null,r=[]){this.customFunctions={...e},this.stringToNumber=t,this.debug=r,this.formula=new Pt(r,e,t)}search(e,t,r={},n="en-US"){const s=this.compile(e,Object.keys(r));return this.run(s,t,n,r)}run(e,t,r,n){return this.formula.search(e,t,n,r)}compile(e,t=[]){return this.debug.length=0,this.formula.compile(e,t)}}function Yt(e,t,r){return t?new class{get $name(){return e}get $fields(){return r}_add(e,t){this[e]=t}}:new class extends Array{get $name(){return e}get $fields(){return r}_add(e,t){this[e]=t}}}function At(e,t,r){const n=[];if(r instanceof Array)e._add(t,Yt(t,!1,n)),r.forEach(((r,s)=>{const i=At(e[t],s,r);n.push(...i)}));else if(null!==r&&"object"==typeof r)e._add(t,Yt(t,!0,n)),Object.keys(r).forEach((s=>{const i=At(e[t],s,r[s]);n.push(...i)}));else{const s=function(e,t,r=!1,n=!0){return new class{valueOf(){return t}toString(){return t.toString()}toJSON(){return t}get $value(){return t}get $name(){return e}get $readonly(){return r}get $required(){return n}}}(t,r);e[t]=s,n.push(s)}return n}function bt(e){if(null===e||"object"!=typeof e)return e;const t=[],r=Yt("",!Array.isArray(e),t);return Object.entries(e).forEach((([e,n])=>{t.push(...At(r,e,n))})),r}function St(e,t){const r=+e.replace(/\$/,"");return Number.isNaN(r)?(t&&t.push(`Failed to convert ${e} to number`),0):r}window.addEventListener("load",(()=>{const e=document.getElementById("data"),t=document.getElementById("expression"),r=document.getElementById("result"),n=document.getElementById("debug"),s=[],i=new vt({},St,s),u=window.localStorage.getItem("data");u&&(e.value=u);const o=window.localStorage.getItem("expression");function c(){window.localStorage.setItem("data",e.value),window.localStorage.setItem("expression",t.value);const u=t.value,o=document.getElementById("use-fields").checked;let c;try{c=JSON.parse(e.value),o&&(c=bt(c))}catch(e){return void(r.value=e.toString())}try{const e=i.search(u,c,{});n.innerHTML=s.join("\n");let t=e;null!=e&&(t=e.valueOf.call(e)),r.value="object"==typeof t?JSON.stringify(t,null,2):t}catch(e){r.value=e.toString(),n.innerHTML=s.join("\n")}}o&&(t.value=o),e.addEventListener("blur",c),t.addEventListener("blur",c),document.getElementById("canned").addEventListener("change",(e=>{t.value=e.target.value,c()})),c(),fetch("../antlr/JSONFormula.g4").then((e=>{e.text().then((e=>{document.getElementById("grammar-out").innerHTML=e}))}))})),JSONFormula=e})();
//# sourceMappingURL=tutorial.js.map