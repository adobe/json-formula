var jsonFormula;(()=>{"use strict";var t=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e={};(()=>{t(e);const r={TYPE_NUMBER:0,TYPE_ANY:1,TYPE_STRING:2,TYPE_ARRAY:3,TYPE_OBJECT:4,TYPE_BOOLEAN:5,TYPE_EXPREF:6,TYPE_NULL:7,TYPE_ARRAY_NUMBER:8,TYPE_ARRAY_STRING:9,TYPE_CLASS:10,TYPE_ARRAY_ARRAY:11},n={TOK_EOF:"EOF",TOK_IDENTIFIER:"Identifier",TOK_QUOTEDIDENTIFIER:"QuotedIdentifier",TOK_RBRACKET:"Rbracket",TOK_RPAREN:"Rparen",TOK_COMMA:"Comma",TOK_COLON:"Colon",TOK_CONCATENATE:"Concatenate",TOK_RBRACE:"Rbrace",TOK_NUMBER:"Number",TOK_CURRENT:"Current",TOK_GLOBAL:"Global",TOK_EXPREF:"Expref",TOK_PIPE:"Pipe",TOK_OR:"Or",TOK_AND:"And",TOK_ADD:"Add",TOK_SUBTRACT:"Subtract",TOK_UNARY_MINUS:"UnaryMinus",TOK_MULTIPLY:"Multiply",TOK_UNION:"Union",TOK_DIVIDE:"Divide",TOK_EQ:"EQ",TOK_GT:"GT",TOK_LT:"LT",TOK_GTE:"GTE",TOK_LTE:"LTE",TOK_NE:"NE",TOK_FLATTEN:"Flatten",TOK_STAR:"Star",TOK_FILTER:"Filter",TOK_DOT:"Dot",TOK_NOT:"Not",TOK_LBRACE:"Lbrace",TOK_LBRACKET:"Lbracket",TOK_LPAREN:"Lparen",TOK_JSON:"Literal",TOK_STRING:"String",TOK_INT:"Integer"};function s(t){return new TypeError(t)}function i(t){const e=new Error(t);return e.name="SyntaxError",e}function u(t){const e=new Error(t);return e.name="FunctionError",e}function a(t){const e=new Error(t);return e.name="EvaluationError",e}const{TYPE_NUMBER:o,TYPE_ANY:c,TYPE_STRING:l,TYPE_ARRAY:h,TYPE_OBJECT:_,TYPE_BOOLEAN:p,TYPE_EXPREF:d,TYPE_NULL:f,TYPE_ARRAY_NUMBER:y,TYPE_ARRAY_STRING:T,TYPE_CLASS:E,TYPE_ARRAY_ARRAY:g}=r,{TOK_EXPREF:O}=n,m={[o]:"number",[c]:"any",[l]:"string",[h]:"array",[_]:"object",[p]:"boolean",[d]:"expression",[f]:"null",[y]:"Array<number>",[T]:"Array<string>",[E]:"class",[g]:"Array<array>"};function N(t,e=!0){if(null===t)return f;let r=t;if(e){if("function"!=typeof t.valueOf)return _;r=t.valueOf.call(t)}switch(Object.prototype.toString.call(r)){case"[object String]":return l;case"[object Number]":return o;case"[object Array]":return h;case"[object Boolean]":return p;case"[object Null]":return f;case"[object Object]":return r.jmespathType===O?d:_;default:return _}}function R(t){return m[N(t)]}function v(t){return[N(t),N(t,!1)]}function P(t,e,r,n,i,u){const a=t[0];if(-1!==e.findIndex((t=>t===c||a===t)))return r;let d=!1;if((a===_||1===e.length&&e[0]===E)&&(d=!0),a===h&&1===e.length&&e[0]===_&&(d=!0),e.includes(g)){if(a===h&&(r.forEach((t=>{t instanceof Array||(d=!0)})),!d))return r;d=!0}if(d)throw s(`${n} expected argument to be type ${m[e[0]]} but received type ${m[a]} instead.`);let O=-1;if(a===h&&e.includes(T)&&e.includes(y)&&(O=r.length>0&&"string"==typeof r[0]?T:y),-1===O&&[T,y,h].includes(a)&&(O=e.find((t=>[T,y,h].includes(t)))),-1===O&&([O]=e),O===c)return r;if(O===T||O===y||O===h){if(O===h)return a===y||a===T?r:null===r?[]:[r];const e=O===y?o:l;if(a===h){const t=r.slice();for(let r=0;r<t.length;r+=1){const s=v(t[r]);t[r]=P(s,[e],t[r],n,i,u)}return t}if([o,l,f,p].includes(e))return[P(t,[e],r,n,i,u)]}else{if(O===o)return[l,p,f].includes(a)?i(r):0;if(O===l)return a===f||a===_?"":u(r);if(O===p)return!!r;if(O===_&&t[1]===_)return r}throw s(`${n} expected argument to be type ${m[e[0]]} but received type ${m[a]} instead.`)}function b(t){return Array.isArray(t)}function Y(t){return null!==t&&"[object Object]"===Object.prototype.toString.call(t)}function A(t){return null==t?t:b(t)?t.map((t=>A(t))):"function"!=typeof t.valueOf?t:t.valueOf()}function S(t){if(null===t)return!1;const e=A(t);return Array.isArray(e)?e.length>0:Y(e)?Object.keys(e).length>0:!!e}function I(t,e){const r=A(t),n=A(e);if(r===n)return!0;if(Object.prototype.toString.call(r)!==Object.prototype.toString.call(n))return!1;if(!0===b(r)){if(r.length!==n.length)return!1;for(let t=0;t<r.length;t+=1)if(!1===I(r[t],n[t]))return!1;return!0}if(!0===Y(r)){const t={};for(const e in r)if(hasOwnProperty.call(r,e)){if(!1===I(r[e],n[e]))return!1;t[e]=!0}for(const e in n)if(hasOwnProperty.call(n,e)&&!0!==t[e])return!1;return!0}return!1}function K(t,e){const r=Object.getOwnPropertyDescriptor(t,e);if(r?.enumerable||r?.get)return t[e]?.[Symbol.for("track")]?.(t,e),t[e]}function x(t,e,r){try{t.push(`Failed to find: '${r}'`);let n=[];b(e)&&e.length>0&&n.push("0.."+(e.length-1)),null!==e&&(n=[...n,...Object.entries(Object.getOwnPropertyDescriptors(e,r)).filter((([t,e])=>(e?.enumerable||!!e?.get)&&!/^[0-9]+$/.test(t)&&(!t.startsWith("$")||r.startsWith("$")))).map((([t])=>`'${t}'`))]),n.length&&t.push(`Available fields: ${n}`)}catch(t){}}const{TOK_CURRENT:M,TOK_GLOBAL:U,TOK_EXPREF:B,TOK_PIPE:w,TOK_EQ:k,TOK_GT:j,TOK_LT:L,TOK_GTE:$,TOK_NE:C,TOK_FLATTEN:F}=n,{TYPE_STRING:G,TYPE_ARRAY_STRING:D,TYPE_ARRAY:J}=r;function q(t,e){if(b(t)&&b(e)){const r=t.length<e.length?t:e,n=Math.abs(t.length-e.length);r.length+=n,r.fill(null,r.length-n)}}class H{constructor(t,e,r,n,s,i){this.runtime=t,this.globals=e,this.toNumber=r,this.toString=n,this.debug=s,this.language=i}search(t,e){return this.visit(t,e)}field(t,e){if(null!==e&&(Y(e)||b(e))){const r=K(e,t.name);return void 0===r?(x(this.debug,e,t.name),null):r}return x(this.debug,e,t.name),null}visit(t,e){const r={Identifier:this.field.bind(this),QuotedIdentifier:this.field.bind(this),ChainedExpression:(t,e)=>{let r=this.visit(t.children[0],e);for(let e=1;e<t.children.length;e+=1)if(r=this.visit(t.children[1],r),null===r)return null;return r},BracketExpression:(t,e)=>{const r=this.visit(t.children[0],e);return this.visit(t.children[1],r)},Index:(t,e)=>{if(b(e)){let r=t.value.value;r<0&&(r=e.length+r);const n=e[r];return void 0===n?(this.debug.push(`Index: ${r} out of range for array size: ${e.length}`),null):n}return this.debug.push("Left side of index expression must be an array"),this.debug.push(`Did you intend a single-element array? if so, use a JSON literal: \`[${t.value.value}]\``),null},Slice:(t,e)=>{if(!b(e))return this.debug.push("Slices apply to arrays only"),null;const r=t.children.map((t=>null===t?null:t.value)),[n,s,i]=this.computeSliceParams(e.length,r),u=[];if(i>0)for(let t=n;t<s;t+=i)u.push(e[t]);else for(let t=n;t>s;t+=i)u.push(e[t]);return u},Projection:(t,e)=>{const r=this.visit(t.children[0],e);if(!b(r))return"Wildcard"===t.debug&&this.debug.push("Bracketed wildcards apply to arrays only"),null;const n=[];return r.forEach((e=>{const r=this.visit(t.children[1],e);n.push(r)})),n},ValueProjection:(t,e)=>{const r=this.visit(t.children[0],e);if(!Y(A(r)))return this.debug.push("Chained wildcards apply to objects only"),null;const n=[];var s;return(s=r,Object.values(s)).forEach((e=>{const r=this.visit(t.children[1],e);n.push(r)})),n},FilterProjection:(t,e)=>{const r=this.visit(t.children[0],e);if(!b(r))return this.debug.push("Filter expressions apply to arrays only"),null;const n=r.filter((e=>S(this.visit(t.children[2],e)))),s=[];return n.forEach((e=>{const r=this.visit(t.children[1],e);s.push(r)})),s},Comparator:(t,e)=>{const r=A(this.visit(t.children[0],e)),n=A(this.visit(t.children[1],e));return t.name===k?I(r,n):t.name===C?!I(r,n):Y(r)||b(r)?(this.debug.push(`Cannot use comparators with ${R(r)}`),!1):Y(n)||b(n)?(this.debug.push(`Cannot use comparators with ${R(n)}`),!1):t.name===j?r>n:t.name===$?r>=n:t.name===L?r<n:r<=n},[F]:(t,e)=>{const r=this.visit(t.children[0],e);if(!b(r))return this.debug.push("Flatten expressions apply to arrays only. If you want an empty array, use a JSON literal: `[]`"),null;const n=[];return r.forEach((t=>{b(t)?n.push(...t):n.push(t)})),n},Identity:(t,e)=>e,ArrayExpression:(t,e)=>t.children.map((t=>this.visit(t,e))),ObjectExpression:(t,e)=>{const r={};return t.children.forEach((t=>{r[t.name]=this.visit(t.value,e)})),r},OrExpression:(t,e)=>{let r=this.visit(t.children[0],e);return S(r)||(r=this.visit(t.children[1],e)),r},AndExpression:(t,e)=>{const r=this.visit(t.children[0],e);return S(r)?this.visit(t.children[1],e):r},AddExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return q(r,n),this.applyOperator(r,n,"+")},ConcatenateExpression:(t,e)=>{let r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return q(r,n),r=P(v(r),[G,D],r,"concatenate",this.toNumber,this.toString),n=P(v(n),[G,D],n,"concatenate",this.toNumber,this.toString),this.applyOperator(r,n,"&")},UnionExpression:(t,e)=>{let r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return r=P(v(r),[J],r,"union",this.toNumber,this.toString),n=P(v(n),[J],n,"union",this.toNumber,this.toString),r.concat(n)},SubtractExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return q(r,n),this.applyOperator(r,n,"-")},MultiplyExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return q(r,n),this.applyOperator(r,n,"*")},DivideExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=this.visit(t.children[1],e);return q(r,n),this.applyOperator(r,n,"/")},NotExpression:(t,e)=>!S(this.visit(t.children[0],e)),UnaryMinusExpression:(t,e)=>{const r=this.visit(t.children[0],e),n=-1*r;return Number.isNaN(n)?(this.debug.push(`Failed to convert "${r}" to number`),0):n},String:t=>t.value,Literal:t=>t.value,Number:t=>t.value,Integer:t=>t.value,[w]:(t,e)=>{const r=this.visit(t.children[0],e);return this.visit(t.children[1],r)},[M]:(t,e)=>e,[U]:t=>{const e=this.globals[t.name];return void 0===e?null:e},Function:(t,e)=>{if("if"===t.name)return this.runtime.callFunction(t.name,t.children,e,this,!1);const r=t.children.map((t=>this.visit(t,e)));return this.runtime.callFunction(t.name,r,e,this)},ExpressionReference:t=>{const[e]=t.children;return e.jmespathType=B,e}};return(t&&r[t.type])(t,e)}computeSliceParams(t,e){function r(t,e,r){let n=e;return n<0?(n+=t,n<0&&(n=r<0?-1:0)):n>=t&&(n=r<0?t-1:t),n}let[n,s,i]=e;if(null===i)i=1;else if(0===i)throw a("Invalid slice, step cannot be 0");const u=i<0;return n=null===n?u?t-1:0:r(t,n,i),s=null===s?u?-1:t:r(t,s,i),[n,s,i]}applyOperator(t,e,r){if(b(t)&&b(e)){const n=[];for(let s=0;s<t.length;s+=1)n.push(this.applyOperator(t[s],e[s],r));return n}if(b(t))return t.map((t=>this.applyOperator(t,e,r)));if(b(e))return e.map((e=>this.applyOperator(t,e,r)));if("&"===r)return t+e;if("*"===r)return this.toNumber(t)*this.toNumber(e);const n=this.toNumber(t),s=this.toNumber(e);if("+"===r)return n+s;if("-"===r)return n-s;const i=n/s;if(!Number.isFinite(i))throw a(`Division by zero ${t}/${e}`);return i}}const{TOK_IDENTIFIER:Q,TOK_QUOTEDIDENTIFIER:z,TOK_RBRACKET:W,TOK_RPAREN:X,TOK_COMMA:V,TOK_COLON:Z,TOK_CONCATENATE:tt,TOK_RBRACE:et,TOK_NUMBER:rt,TOK_CURRENT:nt,TOK_GLOBAL:st,TOK_EXPREF:it,TOK_PIPE:ut,TOK_OR:at,TOK_AND:ot,TOK_ADD:ct,TOK_SUBTRACT:lt,TOK_UNARY_MINUS:ht,TOK_DIVIDE:_t,TOK_UNION:pt,TOK_EQ:dt,TOK_GT:ft,TOK_LT:yt,TOK_GTE:Tt,TOK_LTE:Et,TOK_NE:gt,TOK_FLATTEN:Ot,TOK_STAR:mt,TOK_FILTER:Nt,TOK_DOT:Rt,TOK_NOT:vt,TOK_LBRACE:Pt,TOK_LBRACKET:bt,TOK_LPAREN:Yt,TOK_JSON:At,TOK_STRING:St,TOK_INT:It}=n,Kt={".":Rt,",":V,":":Z,"{":Pt,"}":et,"]":W,"(":Yt,")":X,"@":nt},xt={"<":!0,">":!0,"=":!0,"!":!0},Mt={" ":!0,"\t":!0,"\n":!0};function Ut(t){return t>="0"&&t<="9"||"."===t}function Bt(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"||t>="0"&&t<="9"||"_"===t}function wt(t,e){const r=t[e];return"$"===r||r>="a"&&r<="z"||r>="A"&&r<="Z"||"_"===r}class kt{constructor(t=[],e=[]){this._allowedGlobalNames=t,this.debug=e}tokenize(t){const e=[];let r,n,s;for(this._current=0;this._current<t.length;){const u=e.length?e.slice(-1)[0].type:null;if(this._isGlobal(u,t,this._current))e.push(this._consumeGlobal(t));else if(wt(t,this._current))r=this._current,n=this._consumeUnquotedIdentifier(t),e.push({type:Q,value:n,start:r});else if(this._isNumber(t))s=this._consumeNumber(t),e.push(s);else if(void 0!==Kt[t[this._current]])e.push({type:Kt[t[this._current]],value:t[this._current],start:this._current}),this._current+=1;else if("-"!==t[this._current]||[st,nt,rt,It,X,Q,z,W,At,St].includes(u))if("["===t[this._current])s=this._consumeLBracket(t),e.push(s);else if("'"===t[this._current])r=this._current,n=this._consumeQuotedIdentifier(t),e.push({type:z,value:n,start:r});else if('"'===t[this._current])r=this._current,n=this._consumeRawStringLiteral(t),e.push({type:St,value:n,start:r});else if("`"===t[this._current]){r=this._current;const n=this._consumeJson(t);e.push({type:At,value:n,start:r})}else if(void 0!==xt[t[this._current]])e.push(this._consumeOperator(t));else if(void 0!==Mt[t[this._current]])this._current+=1;else if("&"===t[this._current])r=this._current,this._current+=1,"&"===t[this._current]?(this._current+=1,e.push({type:ot,value:"&&",start:r})):u===V||u===Yt?e.push({type:it,value:"&",start:r}):e.push({type:tt,value:"&",start:r});else if("~"===t[this._current])r=this._current,this._current+=1,e.push({type:pt,value:"~",start:r});else if("+"===t[this._current])r=this._current,this._current+=1,e.push({type:ct,value:"+",start:r});else if("-"===t[this._current])r=this._current,this._current+=1,e.push({type:lt,value:"-",start:r});else if("*"===t[this._current])r=this._current,this._current+=1,e.push({type:mt,value:"*",start:r});else if("/"===t[this._current])r=this._current,this._current+=1,e.push({type:_t,value:"/",start:r});else{if("|"!==t[this._current])throw i(`Unknown character:${t[this._current]}`);r=this._current,this._current+=1,"|"===t[this._current]?(this._current+=1,e.push({type:at,value:"||",start:r})):e.push({type:ut,value:"|",start:r})}else s=this._consumeUnaryMinus(t),e.push(s)}return e}_consumeUnquotedIdentifier(t){const e=this._current;for(this._current+=1;this._current<t.length&&("$"===t[this._current]||Bt(t[this._current]));)this._current+=1;return t.slice(e,this._current)}_consumeQuotedIdentifier(t){const e=this._current;this._current+=1;const r=t.length;let n=!wt(t,e+1);for(;"'"!==t[this._current]&&this._current<r;){let e=this._current;Bt(t[e])||(n=!0),"\\"!==t[e]||"\\"!==t[e+1]&&"'"!==t[e+1]?e+=1:e+=2,this._current=e}this._current+=1;const s=t.slice(e,this._current);try{n||(this.debug.push(`Suspicious quotes: ${s}`),this.debug.push(`Did you intend a literal? "${s.replace(/'/g,"")}"?`))}catch(t){}return JSON.parse(`"${s.substring(1,s.length-1).replace(/\\'/g,"'")}"`)}_consumeRawStringLiteral(t){const e=this._current;this._current+=1;const r=t.length;for(;'"'!==t[this._current]&&this._current<r;){let e=this._current;"\\"!==t[e]||"\\"!==t[e+1]&&'"'!==t[e+1]?e+=1:e+=2,this._current=e}this._current+=1;const n=t.slice(e+1,this._current-1);if(this._current>r)throw i(`Unterminated string literal at ${e}, "${n}`);try{return JSON.parse(`"${n}"`)}catch(t){throw i(`Invalid string literal: ${n}`)}}_isNumber(t){let e=t[this._current];return e>="0"&&e<="9"||"."===e&&this._current!==t.length&&(e=t[this._current+1],e>="0"&&e<="9")}_consumeNumber(t){const e=this._current;this._current+=1;const r=t.length;for(;Ut(t[this._current])&&this._current<r;)this._current+=1;if("e"===t[this._current]||"E"===t[this._current])for(this._current+=1,"-"!==t[this._current]&&"+"!==t[this._current]||(this._current+=1);Ut(t[this._current])&&this._current<r;)this._current+=1;const n=t.slice(e,this._current);let s;return n.includes(".")||n.toLowerCase().includes("e")?(s=parseFloat(n),{type:rt,value:s,start:e}):(s=parseInt(n,10),{type:It,value:s,start:e})}_consumeUnaryMinus(){const t=this._current;return this._current+=1,{type:ht,value:"-",start:t}}_consumeLBracket(t){const e=this._current;return this._current+=1,"?"===t[this._current]?(this._current+=1,{type:Nt,value:"[?",start:e}):"]"===t[this._current]?(this._current+=1,{type:Ot,value:"[]",start:e}):{type:bt,value:"[",start:e}}_isGlobal(t,e,r){if(null!==t&&t===Rt)return!1;if("$"!==e[r])return!1;let n=r+1;for(;n<e.length&&("$"===e[n]||Bt(e[n]));)n+=1;const s=e.slice(r,n);return this._allowedGlobalNames.includes(s)}_consumeGlobal(t){const e=this._current;for(this._current+=1;this._current<t.length&&("$"===t[this._current]||Bt(t[this._current]));)this._current+=1;const r=t.slice(e,this._current);return{type:st,name:r,start:e}}_consumeOperator(t){const e=this._current,r=t[e];return this._current+=1,"!"===r?"="===t[this._current]?(this._current+=1,{type:gt,value:"!=",start:e}):{type:vt,value:"!",start:e}:"<"===r?"="===t[this._current]?(this._current+=1,{type:Et,value:"<=",start:e}):">"===t[this._current]?(this._current+=1,{type:gt,value:"<>",start:e}):{type:yt,value:"<",start:e}:">"===r?"="===t[this._current]?(this._current+=1,{type:Tt,value:">=",start:e}):{type:ft,value:">",start:e}:"="===t[this._current]?(this._current+=1,{type:dt,value:"==",start:e}):{type:dt,value:"=",start:e}}_consumeJson(t){this._current+=1;const e=this._current,r=t.length;let n=!1;for(;(n||"`"!==t[this._current])&&this._current<r;){let e=this._current;n&&"\\"===t[e]&&'"'===t[e+1]?e+=2:('"'===t[e]&&(n=!n),n&&"`"===t[e+1]?e+=2:"\\"!==t[e]||"\\"!==t[e+1]&&"`"!==t[e+1]?e+=1:e+=2),this._current=e}let s=t.slice(e,this._current).trimStart();return s=s.replaceAll("\\`","`"),this._current+=1,JSON.parse(s)}}const{TOK_JSON:jt,TOK_COLON:Lt,TOK_EOF:$t,TOK_IDENTIFIER:Ct,TOK_QUOTEDIDENTIFIER:Ft,TOK_RBRACKET:Gt,TOK_RPAREN:Dt,TOK_COMMA:Jt,TOK_CONCATENATE:qt,TOK_RBRACE:Ht,TOK_NUMBER:Qt,TOK_CURRENT:zt,TOK_GLOBAL:Wt,TOK_EXPREF:Xt,TOK_PIPE:Vt,TOK_OR:Zt,TOK_AND:te,TOK_ADD:ee,TOK_SUBTRACT:re,TOK_UNARY_MINUS:ne,TOK_MULTIPLY:se,TOK_DIVIDE:ie,TOK_UNION:ue,TOK_EQ:ae,TOK_GT:oe,TOK_LT:ce,TOK_GTE:le,TOK_LTE:he,TOK_NE:_e,TOK_FLATTEN:pe,TOK_STAR:de,TOK_FILTER:fe,TOK_DOT:ye,TOK_NOT:Te,TOK_LBRACE:Ee,TOK_LBRACKET:ge,TOK_LPAREN:Oe,TOK_STRING:me,TOK_INT:Ne}=n,Re={[$t]:0,[Ct]:0,[Ft]:0,[Gt]:0,[Dt]:0,[Jt]:0,[Ht]:0,[Qt]:0,[Ne]:0,[zt]:0,[Wt]:0,[Xt]:0,[Vt]:1,[Zt]:2,[te]:3,[qt]:5,[ee]:6,[re]:6,[se]:7,[ie]:7,[ue]:7,[ae]:5,[oe]:5,[ce]:5,[le]:5,[he]:5,[_e]:5,[pe]:9,[de]:20,[fe]:21,[Te]:30,[ne]:30,[ye]:40,[Ee]:50,[ge]:55,[Oe]:60};class ve{constructor(t=[]){this._allowedGlobalNames=t}parse(t,e){this.debug=e,this._loadTokens(t),this.index=0;const r=this.expression(0);if(this._lookahead(0)!==$t){const t=this._lookaheadToken(0);throw i(`Unexpected token type: ${t.type}, value: ${t.value}`)}return r}_loadTokens(t){const e=new kt(this._allowedGlobalNames,this.debug).tokenize(t);e.push({type:$t,value:"",start:t.length}),this.tokens=e}expression(t){const e=this._lookaheadToken(0);this._advance();let r=this.nud(e),n=this._lookahead(0,r.type);for(;t<Re[n];)this._advance(),r=this.led(n,r),n=this._lookahead(0,r.type);return r}_lookahead(t,e){const r=this.tokens[this.index+t].type;return r===de?[void 0,ge,ye,Vt,te,Zt,Jt,Te,se,ee,re,ie,Oe,qt,ue,oe,le,ce,he,ae,_e].includes(e)?de:se:r}_lookaheadToken(t){return this.tokens[this.index+t]}_advance(){this.index+=1}_lookAheadIndex(){let t=0;return this._lookahead(t)===ne&&(t+=1),this._lookahead(t)===Ne&&(t+=1),this._lookahead(t)===Gt||this._lookahead(t)===Lt}_getIndex(){return this.index}_setIndex(t){this.index=t}nud(t){let e,r,n,s,i;switch(t.type){case me:return{type:"String",value:t.value};case jt:return{type:"Literal",value:t.value};case Qt:return{type:"Number",value:t.value};case Ne:return{type:"Integer",value:t.value};case Ct:return{type:"Identifier",name:t.value};case Ft:return s={type:"QuotedIdentifier",name:t.value},s;case Te:return r=this.expression(Re.Not),{type:"NotExpression",children:[r]};case ne:return r=this.expression(Re.UnaryMinus),{type:"UnaryMinusExpression",children:[r]};case de:return e={type:"Identity"},r=this._lookahead(0)===Gt?{type:"Identity"}:this._parseProjectionRHS(Re.Star),{type:"ValueProjection",children:[e,r]};case fe:return this.led(t.type,{type:"Identity"});case Ee:return this._parseObjectExpression();case pe:return e={type:pe,children:[{type:"Identity"}]},r=this._parseProjectionRHS(Re.Flatten),{type:"Projection",children:[e,r]};case ge:return this._lookAheadIndex()?(r=this._parseIndexExpression(),this._projectIfSlice({type:"Identity"},r)):this._lookahead(0)===de&&this._lookahead(1)===Gt?(this._advance(),this._advance(),r=this._parseProjectionRHS(Re.Star),{type:"Projection",children:[{type:"Identity"},r]}):this._parseArrayExpression();case zt:return{type:zt};case Wt:return{type:Wt,name:t.name};case Xt:return n=this.expression(Re.Expref),{type:"ExpressionReference",children:[n]};case Oe:for(i=[];this._lookahead(0)!==Dt;)n=this.expression(0),i.push(n);return this._match(Dt),i[0];default:this._errorToken(t)}}led(t,e){let r,n,s,u,a,o,c,l;switch(t){case qt:return n=this.expression(Re.Concatenate),{type:"ConcatenateExpression",children:[e,n]};case ye:return o=Re.Dot,this._lookahead(0)!==de?(n=this._parseDotRHS(o),{type:"ChainedExpression",children:[e,n]}):(this._advance(),n=this._parseProjectionRHS(o),{type:"ValueProjection",children:[e,n]});case Vt:return n=this.expression(Re.Pipe),{type:Vt,children:[e,n]};case Zt:return n=this.expression(Re.Or),{type:"OrExpression",children:[e,n]};case te:return n=this.expression(Re.And),{type:"AndExpression",children:[e,n]};case ee:return n=this.expression(Re.Add),{type:"AddExpression",children:[e,n]};case re:return n=this.expression(Re.Subtract),{type:"SubtractExpression",children:[e,n]};case se:return n=this.expression(Re.Multiply),{type:"MultiplyExpression",children:[e,n]};case ie:return n=this.expression(Re.Divide),{type:"DivideExpression",children:[e,n]};case ue:return n=this.expression(Re.Union),{type:"UnionExpression",children:[e,n]};case Oe:if(e.type!==Ct)throw i("Bad function syntax. Parenthesis must be preceded by an unquoted identifier");return s=e.name,u=this._parseFunctionArgs(),a={type:"Function",name:s,children:u},a;case fe:return r=this.expression(0),this._match(Gt),n=this._lookahead(0)===pe?{type:"Identity"}:this._parseProjectionRHS(Re.Filter),{type:"FilterProjection",children:[e,n,r]};case pe:return c={type:pe,children:[e]},l=this._parseProjectionRHS(Re.Flatten),{type:"Projection",children:[c,l]};case ae:case _e:case oe:case le:case ce:case he:return this._parseComparator(e,t);case ge:return this._lookahead(0)===de&&this._lookahead(1)===Gt?(this._advance(),this._advance(),n=this._parseProjectionRHS(Re.Star),{type:"Projection",children:[e,n],debug:"Wildcard"}):(n=this._parseIndexExpression(),this._projectIfSlice(e,n));default:this._errorToken(this._lookaheadToken(0))}}_match(t){const e=this._lookaheadToken(0);if(e.type===t)return this._advance(),e;throw i(`Expected ${t}, got: ${e.type}`)}_errorToken(t){throw i(`Unexpected token (${t.type}): "${t.value}"`)}_parseFunctionArgs(){let t=!0;const e=[];for(;this._lookahead(0)!==Dt;)t||this._match(Jt),e.push(this.expression(0)),t=!1;return this._match(Dt),e}_parseSignedInt(){const t=this._lookaheadToken(0);return t.type===ne?(this._advance(),{type:"SignedInt",value:-this._match(Ne).value}):(t.type!==Ne&&this._errorToken(t),this._advance(),{type:"SignedInt",value:t.value})}_parseIndexExpression(){const t=this._getIndex();if(this._lookahead(0)===Lt)return this._parseSliceExpression();const e=this._parseSignedInt();return this._lookahead(0)===Lt?(this._setIndex(t),this._parseSliceExpression()):(this._match(Gt),{type:"Index",value:e})}_projectIfSlice(t,e){const r={type:"BracketExpression",children:[t,e]};return"Slice"===e.type?{type:"Projection",children:[r,this._parseProjectionRHS(Re.Star)]}:r}_parseSliceExpression(){const t=[null,null,null];let e=0,r=this._lookahead(0);for(;r!==Gt&&e<3;){if(r===Lt&&e<2)e+=1,this._advance();else{t[e]=this._parseSignedInt();const r=this._lookahead(0);if(r!==Lt&&r!==Gt)throw i(`Unexpected token: ${r.value}(${r.type})`)}r=this._lookahead(0)}return this._match(Gt),{type:"Slice",children:t}}_parseComparator(t,e){return{type:"Comparator",name:e,children:[t,this.expression(Re[e])]}}_parseDotRHS(t){const e=this._lookahead(0);if([Ct,Ft,de].indexOf(e)>=0)return this.expression(t);if(e===ge)return this._match(ge),this._parseArrayExpression();if(e===Ee)return this._match(Ee),this._parseObjectExpression();throw i('Expecting one of: "*", "[", "{", name or quoted name after a dot')}_parseProjectionRHS(t){let e;if(Re[this._lookahead(0)]<10)e={type:"Identity"};else if(this._lookahead(0)===ge)e=this.expression(t);else if(this._lookahead(0)===fe)e=this.expression(t);else{if(this._lookahead(0)!==ye){const t=this._lookaheadToken(0);throw i(`Unexpected token: ${t.value}(${t.type})`)}this._match(ye),e=this._parseDotRHS(t)}return e}_parseArrayExpression(){const t=[];for(;this._lookahead(0)!==Gt;){const e=this.expression(0);if(t.push(e),this._lookahead(0)===Jt&&(this._match(Jt),this._lookahead(0)===Gt))throw i("Unexpected token Rbracket")}return this._match(Gt),{type:"ArrayExpression",children:t}}_parseObjectExpression(){const t=[],e=[Ct,Ft];let r,n,s,u;if(this._lookahead(0)===Ht)throw this.debug.push("To create an empty object, use a JSON literal: `{}`"),i("An empty object expression is not allowed");for(;;){if(r=this._lookaheadToken(0),e.indexOf(r.type)<0)throw i(`Expecting an identifier token, got: ${r.type}`);if(n=r.value,this._advance(),this._match(Lt),s=this.expression(0),u={type:"KeyValuePair",name:n,value:s},t.push(u),this._lookahead(0)===Jt)this._match(Jt);else if(this._lookahead(0)===Ht){this._match(Ht);break}}return{type:"ObjectExpression",children:t}}}const Pe=864e5;function be(t){return new Date(Math.round(t*Pe))}function Ye(t){return t/Pe}function Ae(t){return Number.isNaN(t)?null:Number.isFinite(t)?t:null}const{TYPE_CLASS:Se,TYPE_ANY:Ie}=r;function Ke(t){return null==t?"":t.toString()}const xe=t=>{const e=+t;return Number.isNaN(e)?0:e};class Me{constructor(t,e,n={}){this.strictDeepEqual=I,this.toNumber=e,this.functionTable=function(t,e,n,i,u,a,o,c){const{TYPE_NUMBER:l,TYPE_ANY:h,TYPE_STRING:_,TYPE_ARRAY:p,TYPE_OBJECT:d,TYPE_BOOLEAN:f,TYPE_EXPREF:y,TYPE_NULL:T,TYPE_ARRAY_NUMBER:E,TYPE_ARRAY_STRING:g}=r,O={abs:{_func:t=>Math.abs(t[0]),_signature:[{types:[l]}]},acos:{_func:t=>Ae(Math.acos(t[0])),_signature:[{types:[l]}]},and:{_func:t=>{let e=S(a(t[0]));return t.slice(1).forEach((t=>{e=e&&S(a(t))})),e},_signature:[{types:[r.TYPE_ANY],variadic:!0}]},asin:{_func:t=>Ae(Math.asin(t[0])),_signature:[{types:[l]}]},atan2:{_func:t=>Ae(Math.atan2(t[0],t[1])),_signature:[{types:[l]},{types:[l]}]},avg:{_func:t=>{let e=0;const r=t[0];return 0===r.length?null:(r.forEach((t=>{e+=t})),e/r.length)},_signature:[{types:[E]}]},casefold:{_func:(t,e,r)=>o(t[0]).toLocaleUpperCase(r.language).toLocaleLowerCase(r.language),_signature:[{types:[r.TYPE_STRING]}]},ceil:{_func:t=>Math.ceil(t[0]),_signature:[{types:[l]}]},codePoint:{_func:t=>{const e=o(t[0]);return 0===e.length?null:e.codePointAt(0)},_signature:[{types:[r.TYPE_STRING]}]},contains:{_func:t=>a(t[0]).indexOf(a(t[1]))>=0,_signature:[{types:[_,p]},{types:[h]}]},cos:{_func:t=>Ae(Math.cos(t[0])),_signature:[{types:[l]}]},datedif:{_func:t=>{const e=o(t[2]).toLowerCase(),r=be(t[0]),n=be(t[1]);if(n===r)return 0;if(n<r)return null;if("d"===e)return Math.floor(Ye(n-r));const i=n.getFullYear()-r.getFullYear();let u=n.getMonth()-r.getMonth();const a=n.getDate()-r.getDate();if("y"===e){let t=i;return u<0&&(t-=1),0===u&&a<0&&(t-=1),t}if("m"===e)return 12*i+u+(a<0?-1:0);if("ym"===e)return a<0&&(u-=1),u<=0&&i>0?12+u:u;if("yd"===e)return a<0&&(u-=1),u<0?n.setFullYear(r.getFullYear()+1):n.setFullYear(r.getFullYear()),Math.floor(Ye(n-r));throw s(`Unrecognized unit parameter "${e}" for datedif()`)},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]},{types:[r.TYPE_STRING]}]},datetime:{_func:t=>{const e=t[0],r=t[1]-1,n=t[2],s=t.length>3?t[3]:0,i=t.length>4?t[4]:0,u=t.length>5?t[5]:0,a=t.length>6?t[6]:0;return Ye(new Date(e,r,n,s,i,u,a))},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER],optional:!0},{types:[r.TYPE_NUMBER],optional:!0},{types:[r.TYPE_NUMBER],optional:!0},{types:[r.TYPE_NUMBER],optional:!0}]},day:{_func:t=>be(t[0]).getDate(),_signature:[{types:[r.TYPE_NUMBER]}]},deepScan:{_func:t=>{const[e,r]=t,n=o(r),s=[];return null===e||function t(e){Object.entries(e).forEach((([e,r])=>{e===n&&s.push(r),"object"==typeof r&&t(r)}))}(e),s},_signature:[{types:[r.TYPE_OBJECT,r.TYPE_ARRAY,r.TYPE_NULL]},{types:[r.TYPE_STRING,r.TYPE_NUMBER]}]},endsWith:{_func:t=>{const e=a(t[0]),r=a(t[1]);return-1!==e.indexOf(r,e.length-r.length)},_signature:[{types:[_]},{types:[_]}]},entries:{_func:t=>{const e=a(t[0]);return Object.entries(e)},_signature:[{types:[r.TYPE_ARRAY,r.TYPE_OBJECT]}]},eomonth:{_func:t=>{const e=be(t[0]),r=t[1];return Ye(new Date(e.getFullYear(),e.getMonth()+r+1,0))},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]}]},exp:{_func:t=>Math.exp(t[0]),_signature:[{types:[r.TYPE_NUMBER]}]},false:{_func:()=>!1,_signature:[]},find:{_func:t=>{const e=t[0],r=o(t[1]),n=t.length>2?t[2]:0,s=r.indexOf(e,n);return-1===s?null:s},_signature:[{types:[r.TYPE_STRING]},{types:[r.TYPE_STRING]},{types:[r.TYPE_NUMBER],optional:!0}]},floor:{_func:t=>Math.floor(t[0]),_signature:[{types:[l]}]},fromCodePoint:{_func:t=>{const e=t[0];if(!Number.isInteger(e))throw s(`fromCodePoint() requires an integer parameter.  Received: "${e}"`);return String.fromCodePoint(e)},_signature:[{types:[r.TYPE_NUMBER]}]},fromEntries:{_func:t=>{const e=t[0];return Object.fromEntries(e)},_signature:[{types:[r.TYPE_ARRAY_ARRAY]}]},fround:{_func:t=>Math.fround(t[0]),_signature:[{types:[l]}]},hour:{_func:t=>t[0]<0?null:be(t[0]).getHours(),_signature:[{types:[r.TYPE_NUMBER]}]},if:{_func:(t,e,r)=>{const n=t[0],s=t[1],i=t[2],u=r.visit(n,e);return S(a(u))?r.visit(s,e):r.visit(i,e)},_signature:[{types:[r.TYPE_ANY]},{types:[r.TYPE_ANY]},{types:[r.TYPE_ANY]}]},join:{_func:t=>{const e=t[0];return t[1].join(e)},_signature:[{types:[_]},{types:[g]}]},keys:{_func:t=>null===t[0]?[]:Object.keys(t[0]),_signature:[{types:[h]}]},left:{_func:t=>{const e=t.length>1?t[1]:1;return e<0?null:t[0]instanceof Array?t[0].slice(0,e):o(t[0]).substr(0,e)},_signature:[{types:[r.TYPE_STRING,r.TYPE_ARRAY]},{types:[r.TYPE_NUMBER],optional:!0}]},length:{_func:t=>{const r=a(t[0]);return e(r)?Object.keys(r).length:n(r)?r.length:o(r).length},_signature:[{types:[_,p,d]}]},log:{_func:t=>Ae(Math.log(t[0])),_signature:[{types:[l]}]},log10:{_func:t=>Ae(Math.log10(t[0])),_signature:[{types:[l]}]},lower:{_func:t=>o(t[0]).toLowerCase(),_signature:[{types:[r.TYPE_STRING]}]},map:{_func:e=>{const r=e[0];return e[1].map((e=>t.interpreter.visit(r,e)))},_signature:[{types:[y]},{types:[p]}]},max:{_func:t=>{const e=t.reduce(((t,e)=>(Array.isArray(e)?t.push(...e):t.push(e),t)),[]),r=e.find((t=>null!==t));if(0===e.length||void 0===r)return null;const n=u(r,!0)===l,s=n?(t,e)=>{const r=i(e);return t<=r?r:t}:(t,e)=>{const r=o(e);return 1===t.localeCompare(r)?t:r};return e.reduce(s,n?i(r):o(r))},_signature:[{types:[p,E,g],variadic:!0}]},merge:{_func:t=>{const e={};return t.forEach((t=>{null!==t&&Object.entries(t||{}).forEach((([t,r])=>{e[t]=r}))})),e},_signature:[{types:[d,T],variadic:!0}]},mid:{_func:t=>{const e=t[1],r=t[2];return e<0?null:t[0]instanceof Array?t[0].slice(e,e+r):o(t[0]).substr(e,r)},_signature:[{types:[r.TYPE_STRING,r.TYPE_ARRAY]},{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]}]},min:{_func:t=>{const e=t.reduce(((t,e)=>(Array.isArray(e)?t.push(...e):t.push(e),t)),[]),r=e.find((t=>null!==t));if(0===e.length||void 0===r)return null;const n=u(r,!0)===l,s=n?(t,e)=>{const r=i(e);return t<=r?t:r}:(t,e)=>{const r=o(e);return 1===t.localeCompare(r)?r:t};return e.reduce(s,n?i(r):o(r))},_signature:[{types:[p,E,g],variadic:!0}]},minute:{_func:t=>t[0]<0?null:be(t[0]).getMinutes(),_signature:[{types:[r.TYPE_NUMBER]}]},mod:{_func:t=>t[0]%t[1],_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]}]},month:{_func:t=>be(t[0]).getMonth()+1,_signature:[{types:[r.TYPE_NUMBER]}]},not:{_func:t=>!a(t[0]),_signature:[{types:[r.TYPE_ANY]}]},notNull:{_func:t=>t.find((t=>u(t)!==T))||null,_signature:[{types:[h],variadic:!0}]},now:{_func:()=>Ye(Date.now()),_signature:[]},null:{_func:()=>null,_signature:[]},or:{_func:t=>{let e=S(a(t[0]));return t.slice(1).forEach((t=>{e=e||S(a(t))})),e},_signature:[{types:[r.TYPE_ANY],variadic:!0}]},power:{_func:t=>{const e=u(t[0]);return e===r.TYPE_ARRAY||e===r.TYPE_ARRAY_STRING||e===r.TYPE_ARRAY_NUMBER?t[0].map((e=>i(e)**t[1])):t[0]**t[1]},_signature:[{types:[r.TYPE_NUMBER,r.TYPE_ARRAY_NUMBER,r.TYPE_ARRAY_STRING]},{types:[r.TYPE_NUMBER]}]},proper:{_func:t=>{const e=t=>/\w/.test(t)?`${t.charAt(0).toUpperCase()}${t.slice(1).toLowerCase()}`:t,r=o(t[0]),n=r.match(/\W+|\w+/g);return null===n?r:n.map((t=>{const r=t.match(/\d+|[^\d]+/g);return null===r?e(t):r.map((t=>e(t))).join("")})).join("")},_signature:[{types:[r.TYPE_STRING]}]},random:{_func:()=>Math.random(),_signature:[]},reduce:{_func:e=>{const r=e[0];return e[1].reduce(((e,n,s,i)=>t.interpreter.visit(r,{accumulated:e,current:n,index:s,array:i})),3===e.length?e[2]:null)},_signature:[{types:[y]},{types:[p]},{types:[h],optional:!0}]},register:{_func:e=>{const r=e[0],n=e[1];return O[r]&&!O[r].custom?(c.push(`Cannot override function: "${r}"`),{}):(O[r]={_func:e=>t.interpreter.visit(n,...e),_signature:[{types:[h],optional:!0}],_custom:!0},{})},_signature:[{types:[_]},{types:[y]}]},replace:{_func:t=>{const e=o(t[0]),r=t[1],n=t[2],s=o(t[3]);return r<0?null:e.substr(0,r)+s+e.substr(r+n)},_signature:[{types:[r.TYPE_STRING]},{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]},{types:[r.TYPE_STRING]}]},rept:{_func:t=>{const e=o(t[0]),r=t[1];return r<0?null:e.repeat(r)},_signature:[{types:[r.TYPE_STRING]},{types:[r.TYPE_NUMBER]}]},reverse:{_func:t=>{const e=a(t[0]);if(u(e)===_){let t="";for(let r=e.length-1;r>=0;r-=1)t+=e[r];return t}const r=t[0].slice(0);return r.reverse(),r},_signature:[{types:[_,p]}]},right:{_func:t=>{const e=t.length>1?t[1]:1;if(e<0)return null;if(t[0]instanceof Array)return 0===e?[]:t[0].slice(-1*e);const r=o(t[0]),n=r.length-e;return r.substr(n,e)},_signature:[{types:[r.TYPE_STRING,r.TYPE_ARRAY]},{types:[r.TYPE_NUMBER],optional:!0}]},round:{_func:t=>function(t,e){const r=10**e;return Math.round(t*r)/r}(t[0],t[1]),_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]}]},search:{_func:t=>{const e=o(t[0]),r=o(t[1]),n=t.length>2?t[2]:0;if(null===e||null===r||0===r.length)return[];const s=e.replace(/([[.\\^$()+{])/g,"\\$1").replace(/~?\?/g,(t=>"~?"===t?"\\?":".")).replace(/~?\*/g,(t=>"~*"===t?"\\*":".*?")).replace(/~~/g,"~"),i=new RegExp(s),u=r.substring(n).match(i);return null===u?[]:[u.index+n,u[0]]},_signature:[{types:[r.TYPE_STRING]},{types:[r.TYPE_STRING]},{types:[r.TYPE_NUMBER],optional:!0}]},second:{_func:t=>t[0]<0?null:be(t[0]).getSeconds(),_signature:[{types:[r.TYPE_NUMBER]}]},sign:{_func:t=>Math.sign(t[0]),_signature:[{types:[l]}]},sin:{_func:t=>Ae(Math.sin(t[0])),_signature:[{types:[l]}]},sort:{_func:t=>{const e=t[0].slice(0);if(e.length>0){const r=u(t[0][0])===l?i:o;e.sort(((t,e)=>{const n=r(t),s=r(e);return n<s?-1:n>s?1:0}))}return e},_signature:[{types:[p,g,E]}]},sortBy:{_func:e=>{const r=e[0].slice(0);if(0===r.length)return r;const n=e[1],i=u(t.interpreter.visit(n,r[0]));if([l,_].indexOf(i)<0)throw s("Bad data type for sortBy()");const a=[];for(let t=0;t<r.length;t+=1)a.push([t,r[t]]);a.sort(((e,r)=>{const a=t.interpreter.visit(n,e[1]),o=t.interpreter.visit(n,r[1]);if(u(a)!==i)throw s(`sortBy expected ${i}, received ${u(a)}`);if(u(o)!==i)throw s(`sortyBy expected ${i}, received ${u(o)}`);return a>o?1:a<o?-1:e[0]-r[0]}));for(let t=0;t<a.length;t+=1)[,r[t]]=a[t];return r},_signature:[{types:[p]},{types:[y]}]},split:{_func:t=>{const e=o(t[0]),r=o(t[1]);return e.split(r)},_signature:[{types:[r.TYPE_STRING]},{types:[r.TYPE_STRING]}]},sqrt:{_func:t=>{const e=Math.sqrt(t[0]);return Number.isNaN(e)?null:e},_signature:[{types:[r.TYPE_NUMBER]}]},startsWith:{_func:t=>a(t[0]).startsWith(a(t[1])),_signature:[{types:[_]},{types:[_]}]},stdev:{_func:t=>{const e=t[0];if(e.length<=1)return null;const r=e.map((t=>i(t))),n=r.reduce(((t,e)=>t+e),0)/e.length,s=r.reduce(((t,e)=>t+e*e),0),u=Math.sqrt((s-e.length*n*n)/(e.length-1));return Number.isNaN(u)?null:u},_signature:[{types:[r.TYPE_ARRAY_NUMBER]}]},stdevp:{_func:t=>{const e=t[0];if(0===e.length)return null;const r=e.map((t=>i(t))),n=r.reduce(((t,e)=>t+e),0)/e.length,s=r.reduce(((t,e)=>t+e*e),0)/e.length,u=Math.sqrt(s-n*n);return Number.isNaN(u)?null:u},_signature:[{types:[r.TYPE_ARRAY_NUMBER]}]},substitute:{_func:t=>{const e=o(t[0]),r=t[1],n=t[2];if(t.length<=3)return e.replaceAll(r,n);const s=t[3];if(s<1)return e;let i=-1;for(let t=0;t<s;t+=1){i+=1;const t=e.slice(i).indexOf(r);if(-1===t)return e;i+=t}return e.slice(0,i)+e.slice(i).replace(r,n)},_signature:[{types:[r.TYPE_STRING]},{types:[r.TYPE_STRING]},{types:[r.TYPE_STRING]},{types:[r.TYPE_NUMBER],optional:!0}]},sum:{_func:t=>{let e=0;return t[0].forEach((t=>{e+=1*t})),e},_signature:[{types:[E]}]},tan:{_func:t=>Ae(Math.tan(t[0])),_signature:[{types:[l]}]},time:{_func:t=>{const e=t[0],r=t.length>1?t[1]:0,n=t.length>2?t[2]:0;return e<0||r<0||n<0?null:Ye(new Date(1970,0,1,e,r,n))},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER],optional:!0},{types:[r.TYPE_NUMBER],optional:!0}]},toArray:{_func:t=>u(t[0])===p?t[0]:[t[0]],_signature:[{types:[h]}]},today:{_func:()=>{const t=new Date(Date.now());return Ye(new Date(t.getFullYear(),t.getMonth(),t.getDate()))},_signature:[]},toNumber:{_func:t=>{const e=t[0],r=t.length>1?t[1]:10;if(10!==r){if(![2,8,16].includes(r))return c.push(`Invalid base: "${r}" for toNumber(), using "10"`),i(e);const t=parseInt(e,r);return Number.isNaN(t)?(c.push(`Failed to convert "${e}" base "${r}" to number`),0):t}return i(e)},_signature:[{types:[_,l,f,T]},{types:[r.TYPE_NUMBER],optional:!0}]},toString:{_func:t=>{if(u(t[0])===_)return t[0];const e=t.length>1?t[1]:0;return JSON.stringify(t[0],null,e)},_signature:[{types:[h]},{types:[l],optional:!0}]},trim:{_func:t=>o(t[0]).split(" ").filter((t=>t)).join(" "),_signature:[{types:[r.TYPE_STRING]}]},true:{_func:()=>!0,_signature:[]},trunc:{_func:t=>{const e=t[0],r=t.length>1?t[1]:0;return(e>=0?Math.floor:Math.ceil)(e*10**r)/10**r},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER],optional:!0}]},type:{_func:t=>({[l]:"number",[_]:"string",[p]:"array",[d]:"object",[f]:"boolean",[y]:"expref",[T]:"null"}[u(t[0])]),_signature:[{types:[h]}]},unique:{_func:t=>{const e=t[0].map((t=>a(t)));return t[0].filter(((t,r)=>e.indexOf(a(t))===r))},_signature:[{types:[r.TYPE_ARRAY]}]},upper:{_func:t=>o(t[0]).toUpperCase(),_signature:[{types:[r.TYPE_STRING]}]},value:{_func:t=>{const e=t[0]||{},r=t[1],s=K(e,r);return void 0===s?(n(e)?c.push(`Index: ${r} out of range for array size: ${e.length}`):x(c,e,r),null):s},_signature:[{types:[r.TYPE_OBJECT,r.TYPE_ARRAY,r.TYPE_NULL]},{types:[r.TYPE_STRING,r.TYPE_NUMBER]}]},values:{_func:t=>{const e=a(t[0]);return null===e?[]:Object.values(e)},_signature:[{types:[h]}]},weekday:{_func:t=>{const e=t[0],r=t.length>1?t[1]:1,n=be(e).getDay();switch(r){case 1:return n+1;case 2:return(n+6)%7+1;case 3:return(n+6)%7;default:return null}},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER],optional:!0}]},year:{_func:t=>be(t[0]).getFullYear(),_signature:[{types:[r.TYPE_NUMBER]}]},zip:{_func:t=>{const e=t.reduce(((t,e)=>Math.min(t,e.length)),t[0].length),r=new Array(e);for(let n=0;n<e;n+=1)r[n]=[],t.forEach((t=>{r[n].push(t[n])}));return r},_signature:[{types:[p],variadic:!0}]}};return O}(this,Y,b,e,N,A,Ke,t),Object.entries(n).forEach((([t,e])=>{e._runtime=this,this.functionTable[t]=e}))}_validateArgs(t,e,r,n){if(0===r.length&&e.length>0)throw u(`${t}() does not accept parameters`);if(0===r.length)return;let s;const i=r.filter((t=>!t.optional)).length;if(r[r.length-1].variadic){if(e.length<r.length)throw s=1===r.length?" argument":" arguments",u(`${t}() takes at least ${r.length}${s} but received ${e.length}`)}else if(e.length<i||e.length>r.length)throw s=1===r.length?" argument":" arguments",u(`${t}() takes ${r.length}${s} but received ${e.length}`);if(!n)return;let a,o;const c=r[r.length-1].variadic?e.length:Math.min(r.length,e.length);for(let n=0;n<c;n+=1)a=n>r.length-1?r[r.length-1].types:r[n].types,l=e[n],h=void 0,a.includes(Se)&&null!==(h=l)&&!Array.isArray(h)&&"Object"!==h.constructor.name||a.includes(Ie)||(o=v(e[n]),e[n]=P(o,a,e[n],t,this.toNumber,Ke));var l,h}callFunction(t,e,r,n,s=!0){if(!Object.prototype.hasOwnProperty.call(this.functionTable,t))throw u(`No such function: ${t}()`);const i=this.functionTable[t];return this._validateArgs(t,e,i._signature,s),i._func.call(this,e,r,n)}}class Ue{constructor(t,e,r){this.debug=t,this.toNumber=function(t,e=[]){return r=>{const n=A(r);if(null===n)return 0;if(n instanceof Array)throw s("Failed to convert array to number");const i=typeof n;if("number"===i)return n;if("string"===i)return t(n,e);if("boolean"===i)return n?1:0;throw s("Failed to convert object to number")}}(r||xe,t),this.runtime=new Me(t,this.toNumber,e)}compile(t,e=[]){return new ve(e).parse(t,this.debug)}search(t,e,r={},n="en-US"){this.runtime.interpreter=new H(this.runtime,r,this.toNumber,Ke,this.debug,n);try{return this.runtime.interpreter.search(t,e)}catch(t){if(this.debug.push(t.message||t.toString()),"Error"===t.name)throw a(t.message||t.toString());throw t}}}const Be=class{constructor(t={},e=null,r=[]){this.customFunctions={...t},this.stringToNumber=e,this.debug=r,this.formula=new Ue(r,t,e)}search(t,e,r={},n="en-US"){const s=this.compile(t,Object.keys(r));return this.run(s,e,n,r)}run(t,e,r,n){return this.formula.search(t,e,n,r)}compile(t,e=[]){return this.debug.length=0,this.formula.compile(t,e)}};function we(t,e,r){const n=e?new class{_add(t,e){this[t]=e}}:new class extends Array{_add(t,e){this[t]=e}};return Object.defineProperty(n,"$name",{get:()=>t}),Object.defineProperty(n,"$fields",{get:()=>r}),n}function ke(t,e,r){const n=[];if(r instanceof Array)t._add(e,we(e,!1,n)),r.forEach(((r,s)=>{const i=ke(t[e],s,r);n.push(...i)}));else if(null!==r&&"object"==typeof r)t._add(e,we(e,!0,n)),Object.keys(r).forEach((s=>{const i=ke(t[e],s,r[s]);n.push(...i)}));else{const s=function(t,e,r=!1,n=!0){const s=new class{valueOf(){return e}toString(){return e.toString()}toJSON(){return e}};return Object.defineProperty(s,"$name",{get:()=>t}),Object.defineProperty(s,"$value",{get:()=>e}),Object.defineProperty(s,"$readonly",{get:()=>r}),Object.defineProperty(s,"$required",{get:()=>n}),s}(e,r);t[e]=s,n.push(s)}return n}function je(t,e){const r=+t;return Number.isNaN(r)?(e&&e.push(`Failed to convert "${t}" to number`),null):r}window.addEventListener("load",(()=>{const t=document.getElementById("data"),e=document.getElementById("expression"),r=document.getElementById("result"),n=document.getElementById("debug"),s=[],i=new Be({},je,s),u='{\n    "address": {\n      "street": "12 Oak St",\n      "city": "San Jose",\n      "state": "CA",\n      "country": "USA",\n      "phone": "1234561234"\n    },\n    "items": [\n      {\n        "desc": "pens",\n        "quantity": 2,\n        "price": 3.23\n      },\n      {\n        "desc": "pencils",\n        "quantity": 3,\n        "price": 1.34\n      }\n    ],\n    "tax": 1.13\n  }',a=window.localStorage.getItem("data");t.value=a||u;const o=window.localStorage.getItem("expression");function c(){window.localStorage.setItem("data",t.value),window.localStorage.setItem("expression",e.value);const u=e.value,a=document.getElementById("use-fields").checked;let o;try{o=JSON.parse(t.value),a&&(o=function(t){if(null===t||"object"!=typeof t)return t;const e=[],r=we("",!Array.isArray(t),e);return Object.entries(t).forEach((([t,n])=>{e.push(...ke(r,t,n))})),r}(o))}catch(t){return void(r.value=t.toString())}try{const t=i.search(u,o,{});n.innerHTML=s.join("\n");let e=t;null!=t&&(e=t.valueOf.call(t)),r.value="object"==typeof e?JSON.stringify(e,null,2):e}catch(t){r.value=t.toString(),n.innerHTML=s.join("\n")}}e.value=o||"sum(items[*].price * items[*].quantity)",t.addEventListener("blur",c),e.addEventListener("blur",c),document.getElementById("data-reset").addEventListener("click",(()=>{t.value=u})),document.getElementById("canned").addEventListener("change",(t=>{e.value=t.target.value,c()})),c(),fetch("../antlr/JsonFormula.g4").then((t=>{t.text().then((t=>{const e=t.replace(/[\s\S.]*grammar/m,"grammar").replace(/#.*/g,"");document.getElementById("grammar-out").innerHTML=e}))}))}))})(),jsonFormula=e})();
//# sourceMappingURL=tutorial.js.map