<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>json-formula Specification</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>json-formula Specification</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This document is the specification for json-formula. In the specification, examples are shown through the use of a <code>search</code> function.  The syntax for this function is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>search(&lt;json-formula expr&gt;, &lt;JSON document&gt;) -&gt; &lt;return value&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For simplicity, the json-formula expression and the JSON document are not quoted.  For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    search(foo, {"foo": "bar"}) -&gt; "bar"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of applying a json-formula expression against a JSON document will result in valid JSON, provided there are no errors during the evaluation process.  Structured data in, structured data out.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_types">Data Types</h2>
<div class="sectionbody">
<div class="paragraph">
<p>json-formula supports the same types supported by JSON:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>number (integers and double-precision floating-point format in JSON)</p>
</li>
<li>
<p>string</p>
</li>
<li>
<p>boolean (<code>true</code> or <code>false</code>)</p>
</li>
<li>
<p>array (an ordered, sequence of values)</p>
</li>
<li>
<p>object (an unordered collection of key value pairs)</p>
</li>
<li>
<p>null</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is an additional type that is not a JSON type that&#8217;s used in
json-formula functions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>expression (denoted by <code>&amp;expression</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Implementations can map the corresponding JSON types to their language
equivalent.  For example, a JSON <code>null</code> could map to <code>None</code> in python,
and <code>nil</code> in ruby and go.</p>
</div>
<div class="sect2">
<h3 id="_type_coercion">Type Coercion</h3>
<div class="paragraph">
<p>If the supplied data is not correct for the execution context, json-formula will attempt to coerce the data to the correct type. Coercion will occur in these contexts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>operands of the concatenation operator (<code>&amp;</code>) shall be coerced to a string, except when an operand is an array. Arrays shall be coerced to an array of strings.</p>
</li>
<li>
<p>operands of numeric operators (<code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>) shall be coerced to numbers except when the operand is an array. Arrays shall be coerced to an array of numbers.</p>
</li>
<li>
<p>operands of the union operator (<code>~</code>) shall be coerced to an array</p>
</li>
<li>
<p>The left-hand operand of ordering comparison operators (<code>&gt;</code>, <code>&gt;=</code>, <code>&lt;</code>, <code>&lt;=</code>) must be a string or number.  Any other type shall be coerced to a number.</p>
</li>
<li>
<p>If the operands of an ordering comparison are different, they shall both be coerced to a number</p>
</li>
<li>
<p>parameters to functions shall be coerced to the expected type as defined by the function signature</p>
</li>
<li>
<p>slice and flatten operations shall coerce operands to a number</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The equality and inequality operators (<code>=</code>, <code>==</code>, <code>!=</code>, <code>&lt;&gt;</code>) do <strong>not</strong> perform type coercion.  If operands are different types, the values are considered not equal.</p>
</div>
<div class="paragraph">
<p>Coercion is not always possible, and if so, an error shall be emitted&#8201;&#8212;&#8201;most often an <code>invalid-type</code> error.</p>
</div>
<div class="sect3">
<h4 id="_examples">Examples</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    search("abc" &amp; 123, {}) -&gt; "abc123"
    search("123" * 2, {}) -&gt; 246
    search([1,2,3] ~ 4, {}) -&gt; [1,2,3,4]
    search(123 &lt; "124", {}) -&gt; true
    search("23" &gt; 111, {}) -&gt; false
    search(abs("-2"), {}) -&gt; 2
    search([1,2,3,4]["1"], {}) -&gt; 2
    search(1 == "1", {}) -&gt; false</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_type_coercion_rules">Type Coercion Rules</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Provided Type</th>
<th class="tableblock halign-left valign-top">Expected Type</th>
<th class="tableblock halign-left valign-top">Result</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">number converted to a string. Similar to JavaScript <code>toString()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"true" or "false"</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"" (empty string)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Parse string to a number.  If the string is not a well-formed number, will return 0.  Allow for locale-specific currency symbols to be ignored.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true &#8658; 1 false &#8658; 0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">create a single-element array with the number</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">create a single-element array with the string.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">create a single-element array with the boolean.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty array</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not supported</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An object where the keys are the array index positions and the values are the array values.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty object</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">zero is false.  All other numbers are true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty string is false, populated strings are true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty array is false, populated arrays are true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty object is false, populated objects are true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_examples_2">Examples</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    search("\"$123.00\" + 1", {}) -&gt; 124.00"
    search("truth is " &amp; `true`, {}) -&gt; "truth is true"
    search(2 + `true`, {}) -&gt; 3
    search(avg("20"), {}) -&gt; 20
    search(merge({a: 3}, 4), {}) -&gt; {a:3}
    search(merge({a: 3}, ["x", "y"]), {}) -&gt; {"0": "x", "1": "y", "a": 3}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_date_and_time_values">Date and Time Values</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to support date and time functions, json-formula needs to represent date and time values.  Date/time values are represented as a number where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The integer portion of the number represents the number of days since the epoch: January 1, 1970, <a href="https://en.wikipedia.org/wiki/Coordinated_Universal_Time">UTC</a>.</p>
</li>
<li>
<p>The fractional portion of the number represents the fractional portion of the day</p>
</li>
<li>
<p>As implied, the date/time value is offset from the current time zone to UTC.</p>
</li>
<li>
<p>The current time zone is determined by the host operating system.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The preferred ways to create a date/time value are by using one of these functions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>datetime()</code></p>
</li>
<li>
<p><code>now()</code></p>
</li>
<li>
<p><code>today()</code></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_examples_3">Examples</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    search(datetime(1970,1,2,0,0,0) - datetime(1970,1,1,0,0,0), {}) -&gt; 1
    search(datetime(2010,1,21,12,0,0) | {month: month(@), day: day(@), hour: hour(@)}, {}) -&gt;
      {"month": 1, "day": 21, "hour": 12}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_floating_point_precision">Floating Point Precision</h2>
<div class="sectionbody">
<div class="paragraph">
<p>json-formula implementations are expected to use <a href="https://en.wikipedia.org/wiki/Double-precision_floating-point_format">Double-precision floating-point format</a> to represent numbers.  As with any system that uses this level of precision, results of expressions may be off by a tiny fraction. e.g.
<code>10 * 1.44 &#8594; 14.399999999999999</code></p>
</div>
<div class="paragraph">
<p>Authors should mitigate this behavior:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When comparing fractional results, do not compare for exact equality.  Instead, compare within a range. e.g.: instead of: <code>a == b</code>, use: <code>abs(a-b) &lt; 0.000001</code></p>
</li>
<li>
<p>leverage the built-in functions that manipulate fractional values:</p>
<div class="ulist">
<ul>
<li>
<p>ceil()</p>
</li>
<li>
<p>floor()</p>
</li>
<li>
<p>round()</p>
</li>
<li>
<p>trunc()</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_grammar">Grammar</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The grammar is specified using Antlr, as described <a href="https://www.antlr.org/">here</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>/*
Copyright 2014 James Saryerwinnie

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
/*
Copyright 2021 Adobe. All rights reserved.
This file is licensed to you under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License. You may obtain a copy
of the License at http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under
the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS
OF ANY KIND, either express or implied. See the License for the specific language
governing permissions and limitations under the License.
*/

grammar JsonFormula;

formula : expression EOF ;

expression
  : expression '.' chainedExpression # chainExpression
  | expression indexExpression # bracketedExpression
  | indexExpression # indexedExpression
  | expression ('*' | '/' | '&amp;' | '~') expression	# multDivExpression
  | expression ('+' | '-') expression	# addSubtractExpression
  | expression COMPARATOR expression # comparisonExpression
  | expression '&amp;&amp;' expression # andExpression
  | expression '||' expression # orExpression
  | identifier # identifierExpression
  | '!' expression # notExpression
  | '-' expression # unaryMinusExpression
  | '(' expression ')' # parenExpression
  | wildcard # wildcardExpression
  | multiSelectList # multiSelectListExpression
  | multiSelectHash # multiSelectHashExpression
  | JSON_FRAGMENT # literalExpression
  | functionExpression # functionCallExpression
  | expression '|' expression # pipeExpression
  | STRING # rawStringExpression
  | '-'? (REAL_OR_EXPONENT_NUMBER | INT) # numberLiteral
  | currentNode # currentNodeExpression
  ;

chainedExpression
  : identifier
  | multiSelectList
  | multiSelectHash
  | functionExpression
  | wildcard
  ;

wildcard : '*' ;

multiSelectList : '[' expression (',' expression)* ']' ;

multiSelectHash
  : '{' '}' #emptyHash
  | '{' keyvalExpr (',' keyvalExpr)* '}'  #nonEmptyHash
  ;

keyvalExpr : identifier ':' expression ;

indexExpression
  : '[' '*' ']' # bracketStar
  | '[' slice ']' # bracketSlice
  | '[' ']' # bracketFlatten
  | '[?' expression ']' # filter
  | '[' expression ']' # select
  ;

slice : start=expression? ':' stop=expression? (':' step=expression?)? ;

COMPARATOR
  : '&lt;'
  | '&lt;='
  | '=='
  | '&gt;='
  | '&gt;'
  | '!='
  | '&lt;&gt;'
  ;

functionExpression
  : NAME '(' functionArg (',' functionArg)* ')'
  | NAME '(' ')'
  ;

functionArg
  : expression
  | expressionType
  ;

currentNode : '@' ;

expressionType : '&amp;' expression ;

identifier
  : NAME
  | QUOTED_NAME
  ;

NAME : [@a-zA-Z_$] [a-zA-Z0-9_$]* ;

QUOTED_NAME : '\'' (ESC | ~ ['\\])* '\'';

JSON_FRAGMENT
  : '`' (STRING | ~ [\\`]+)* '`'
  ;

STRING : '"' (ESC | ~["\\])* '"' ;

fragment ESC : '\\' (~[u] | UNICODE);

fragment UNICODE
  : 'u' HEX HEX HEX HEX
  ;

fragment HEX
  : [0-9a-fA-F]
  ;

REAL_OR_EXPONENT_NUMBER
  : INT '.' [0-9] + EXP?
  | INT EXP
  ;

INT
  : '0'
  | [1-9] [0-9]*
  ;

fragment EXP
  : [Ee] [+\-]? INT
  ;

WS
  : [ \t\n\r] + -&gt; skip
  ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to the grammar, there is the following token precedence that goes
from weakest to tightest binding:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>pipe: <code>|</code></p>
</li>
<li>
<p>or: <code>||</code></p>
</li>
<li>
<p>and: <code>&amp;&amp;</code></p>
</li>
<li>
<p>concatenate: <code>&amp;</code></p>
</li>
<li>
<p>add: <code>+</code>, subtract: <code>-</code></p>
</li>
<li>
<p>multiply: <code>*</code>, divide: <code>/</code>, union: <code>~</code></p>
</li>
<li>
<p>Equals: <code>=</code> (or <code>==</code>), Greater than: <code>&gt;</code>, Less than: <code>&lt;</code>, Greater than or equal: <code>&gt;=</code>, Less than or equal: <code>&lt;=</code>, Not equals: <code>!=</code> (or <code>&lt;&gt;</code>)</p>
</li>
<li>
<p>Flatten: <code>[]</code></p>
</li>
<li>
<p>Unary not <code>!</code>, unary minus: <code>-</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_identifiers">Identifiers</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>identifier
  : NAME
  | QUOTED_NAME
  | JSON_CONSTANT
  ;

JSON_CONSTANT
  : 'true'
  | 'false'
  | 'null'
  ;

NAME : [@a-zA-Z_] [a-zA-Z0-9_]* ;

QUOTED_NAME : '\'' (ESC | ~ ['\\])* '\'';</code></pre>
</div>
</div>
<div class="paragraph">
<p>An <code>identifier</code> is the most basic expression and can be used to extract a
single element from a JSON document.  The return value for an <code>identifier</code> is the value associated with the identifier.  If the <code>identifier</code> does not exist in the JSON document, than a <code>null</code> value is returned.</p>
</div>
<div class="paragraph">
<p>From the grammar rule listed above identifiers can be one or more characters,
and must start with <code>A-Za-z_$</code>.</p>
</div>
<div class="paragraph">
<p>An identifier can also be quoted.  This is necessary when an identifier has
characters not specified in the <code>unquoted-string</code> grammar rule.
In this situation, an identifier is specified with a single quote, followed by
any number of <code>unescaped-char</code> or <code>escaped-char</code> characters, followed by a
single quote.  Any valid string can be used between single quoted, include JSON
supported escape sequences, and six character unicode escape sequences.</p>
</div>
<div class="paragraph">
<p>Note that any identifier that does not start with <code>A-Za-z_$</code> <strong>must</strong>
be quoted.</p>
</div>
<div class="sect2">
<h3 id="_examples_4">Examples</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>   search(foo, {"foo": "value"}) -&gt; "value"
   search(bar, {"foo": "value"}) -&gt; null
   search(foo, {"foo": [0, 1, 2]}) -&gt; [0, 1, 2]
   search('with space', {"with space": "value"}) -&gt; "value"
   search('special chars: !@#"', {"special chars: !@#": "value"}) -&gt; "value"
   search('quote\'char', {"quote\'char": "value"}) -&gt; "value"
   search('\u2713', {"\u2713": "value"}) -&gt; "value"</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_errors">Errors</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Errors may be raised during the json-formula evaluation process. How and when
errors are raised is implementation specific, but implementations should
indicate to the caller when errors have occurred.</p>
</div>
<div class="paragraph">
<p>The following errors are defined:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>invalid-type</code> is raised when an invalid type is encountered during the
evaluation process.</p>
</li>
<li>
<p><code>invalid-value</code> is raised when an invalid value is encountered during the
evaluation process.</p>
</li>
<li>
<p><code>unknown-function</code> is raised when an unknown function is encountered during
the evaluation process.</p>
</li>
<li>
<p><code>invalid-arity</code> is raised when an invalid number of function arguments is
encountered during the evaluation process.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_subexpressions">SubExpressions</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>subExpression: expression '.' chainedExpression

chainedExpression
  : identifier
  | multiSelectList
  | multiSelectHash
  | functionExpression
  | wildcard
  ;

wildcard : '*' ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A subexpression is a combination of two expressions separated by the '.' char.
A subexpression is evaluated as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Evaluate the expression on the left with the original JSON document.</p>
</li>
<li>
<p>Evaluate the expression on the right with the result of the left expression
evaluation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In pseudo-code</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  left-evaluation = search(left-expression, original-json-document)
  result = search(right-expression, left-evaluation)</code></pre>
</div>
</div>
<div class="paragraph">
<p>A subexpression is itself an expression, so there can be multiple levels of
sub-expressions: <code>grandparent.parent.child</code>.</p>
</div>
<div class="sect2">
<h3 id="_examples_5">Examples</h3>
<div class="paragraph">
<p>Given a JSON document: <code>{"foo": {"bar": "baz"}}</code>, and a json-formula expression:
<code>foo.bar</code>, the evaluation process would be</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  left-evaluation = search(foo, {"foo": {"bar": "baz"}}) -&gt; {"bar": "baz"}
  result = search(bar, {"bar": "baz"}) -&gt; "baz"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The final result in this example is <code>"baz"</code>.</p>
</div>
<div class="paragraph">
<p>Additional examples</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>   search(foo.bar, {"foo": {"bar": "value"}}) -&gt; "value"
   search(foo.'bar', {"foo": {"bar": "value"}}) -&gt; "value"
   search(foo.bar, {"foo": {"baz": "value"}}) -&gt; null
   search(foo.bar.baz, {"foo": {"bar": {"baz": "value"}}}) -&gt; "value"</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bracket_expressions">Bracket Expressions</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>expression: expression indexExpression

indexExpression
  : '[' '*' ']' # bracketStar
  | '[' slice ']' # bracketSlice
  | '[' ']' # bracketFlatten
  | '[?' expression ']' # predicate
  | '[' expression ']' # select
  ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>From the <code>indexExpression</code> construction, an index expression is where the brackets contents provide access to the elements in a list or object.</p>
</div>
<div class="paragraph">
<p>When brackets are used with an object, the bracket contents are expected to be an expression that resolves to the name of a property. In the simple case, <code>foo["bar"]</code> is equivalent to <code>foo.bar</code>.</p>
</div>
<div class="paragraph">
<p>Most commonly, brackets are used with lists.  With lists, bracketed expressions are expected to return an integer value to return an index in the list.
Indexing is 0 based. The index of 0 refers to the first element of the list.  A negative number is a
valid index.  A negative number indicates that indexing is relative to the end
of the list, specifically</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  negative-index == (length of array) + negative-index</code></pre>
</div>
</div>
<div class="paragraph">
<p>Given an array of length <code>N</code>, an index of <code>-1</code> would be equal to a positive
index of <code>N - 1</code>, which is the last element of the list.  If an index
expression refers to an index that is greater than the length of the array, a
value of <code>null</code> is returned.</p>
</div>
<div class="paragraph">
<p>Using a "*" character within a <code>indexExpression</code> is discussed below in the
<a href="#_wildcard_expressions">Wildcard Expressions</a> section.</p>
</div>
<div class="paragraph">
<p>Using an expression prefixed with a "?" character within a <code>indexExpression</code> is discussed below in the <a href="#_filter_expressions">Filter Expressions</a> section.</p>
</div>
<div class="sect2">
<h3 id="_slices">Slices</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  slice : start=expression? ':' stop=expression? (':' step=expression?)? ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A slice expression allows you to select a contiguous subset of an array.  A
slice has a <code>start</code>, <code>stop</code>, and <code>step</code> value.  The general form of a
slice is <code>[start:stop:step]</code>, but each component is optional and can
be omitted.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Slices in json-formula have the same semantics as python slices.  If you&#8217;re
familiar with python slices, you&#8217;re familiar with json-formula slices.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Given a <code>start</code>, <code>stop</code>, and <code>step</code> value, the sub elements in an array
are extracted as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The first element in the extracted array is the index denoted by <code>start</code>.</p>
</li>
<li>
<p>The last element in the extracted array is the index denoted by <code>end - 1</code>.</p>
</li>
<li>
<p>The <code>step</code> value determines how many indices to skip after each element
is selected from the array.  An array of 1 (the default step) will not skip
any indices.  A step value of 2 will skip every other index while extracting
elements from an array.  A step value of -1 will extract values in reverse
order from the array.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Slice expressions adhere to the following rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If a negative start position is given, it is calculated as the total length
of the array plus the given start position.</p>
</li>
<li>
<p>If no start position is given, it is assumed to be 0 if the given step is
greater than 0 or the end of the array if the given step is less than 0.</p>
</li>
<li>
<p>If a negative stop position is given, it is calculated as the total length
of the array plus the given stop position.</p>
</li>
<li>
<p>If no stop position is given, it is assumed to be the length of the array if
the given step is greater than 0 or 0 if the given step is less than 0.</p>
</li>
<li>
<p>If the given step is omitted, it it assumed to be 1.</p>
</li>
<li>
<p>If the given step is 0, an <code>invalid-value</code> error MUST be raised.</p>
</li>
<li>
<p>If the element being sliced is not an array, the result is <code>null</code>.</p>
</li>
<li>
<p>If the element being sliced is an array and yields no results, the result
MUST be an empty array.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_examples_6">Examples</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  search(foo["bar"], {"foo": {"bar": 21}}) -&gt; 21
  search([0:4:1], [0, 1, 2, 3]) -&gt; [0, 1, 2, 3]
  search([0:4], [0, 1, 2, 3]) -&gt; [0, 1, 2, 3]
  search([0:3], [0, 1, 2, 3]) -&gt; [0, 1, 2]
  search([:2], [0, 1, 2, 3]) -&gt; [0, 1]
  search([::2], [0, 1, 2, 3]) -&gt; [0, 2]
  search([::-1], [0, 1, 2, 3]) -&gt; [3, 2, 1, 0]
  search([-2:], [0, 1, 2, 3]) -&gt; [2, 3]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_flatten_operator">Flatten Operator</h3>
<div class="paragraph">
<p>When the character sequence <code>[]</code> is provided as a bracket specifier, then
a flattening operation occurs on the current result.  The flattening operator
will merge sub-lists in the current result into a single list.  The flattening
operator has the following semantics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create an empty result list.</p>
</li>
<li>
<p>Iterate over the elements of the current result.</p>
</li>
<li>
<p>If the current element is not a list, add to the end of the result list.</p>
</li>
<li>
<p>If the current element is a list, add each element of the current element
to the end of the result list.</p>
</li>
<li>
<p>The result list is now the new current result.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once the flattening operation has been performed, subsequent operations
are projected onto the flattened list with the same semantics as a
wildcard expression.  Thus the difference between <code>[*]</code> and <code>[]</code> is that
<code>[]</code> will first flatten sub-lists in the current result.</p>
</div>
</div>
<div class="sect2">
<h3 id="_examples_7">Examples</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  search([0], ["first", "second", "third"]) -&gt; "first"
  search([-1], ["first", "second", "third"]) -&gt; "third"
  search([100], ["first", "second", "third"]) -&gt; null
  search(foo[0], {"foo": ["first", "second", "third"]}) -&gt; "first"
  search(foo[100], {"foo": ["first", "second", "third"]}) -&gt; null
  search(foo[0][0], {"foo": [[0, 1], [1, 2]]}) -&gt; 0
  search(foo[], {"foo": [[0, 1], [1, 2]]}) -&gt; [0,1,1,2]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_operators">Operators</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_comparison_operators">Comparison Operators</h3>
<div class="paragraph">
<p>The following comparison operators are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>'=' / <code>==</code>, test for equality.</p>
</li>
<li>
<p><code>!=</code>, "&lt;&gt;", test for inequality.</p>
</li>
<li>
<p><code>&lt;</code>, less than.</p>
</li>
<li>
<p><code>&lt;=</code>, less than or equal to.</p>
</li>
<li>
<p><code>&gt;</code>, greater than.</p>
</li>
<li>
<p><code>&gt;=</code>, greater than or equal to.</p>
</li>
<li>
<p>If both operands are numbers, a numeric comparison is performed.</p>
</li>
<li>
<p>If both operands are strings, they are compared as strings, based on the values of the Unicode code points they contain.</p>
</li>
<li>
<p>If operands are mixed types, follow the <a href="#_type_coercion">type coercion</a> rules.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The comparison semantics for each operator are defined in the discussion on <a href="#_type_coercion">type coercion</a>.</p>
</div>
<div class="sect3">
<h4 id="_equality_operators">Equality Operators</h4>
<div class="paragraph">
<p>Two representations of the equality and inequality operators are supported: <code>=</code> and <code>==</code> are equivalent in functionality.  Both variations are supported provide familiarity to users with experience with similar grammars. Similarly, <code>!=</code> and <code>&lt;&gt;</code> function identically.</p>
</div>
<div class="paragraph">
<p>For <code>string/number/true/false/null</code> types, equality is an exact match. A
<code>string</code> is equal to another <code>string</code> if they they have the exact same sequence
of code points.  The literal values <code>true/false/null</code> are equal only to their
own literal values.  Two JSON objects are equal if they have the same set of
keys and values (given two JSON objects <code>x</code> and <code>y</code>, for each key value
pair <code>(i, j)</code> in <code>x</code>, there exists an equivalent pair <code>(i, j)</code> in <code>y</code>).
Two JSON arrays are equal if they have equal elements in the same order (given
two arrays <code>x</code> and <code>y</code>, for each <code>i</code> from <code>0</code> until <code>length(x)</code>,
<code>x[i] == y[i]</code>).</p>
</div>
</div>
<div class="sect3">
<h4 id="_ordering_operators">Ordering Operators</h4>
<div class="ulist">
<ul>
<li>
<p>If both operands are numbers, a numeric comparison is performed.</p>
</li>
<li>
<p>If both operands are strings, they are compared as strings, based on the values of the Unicode code points they contain.</p>
</li>
<li>
<p>If operands are mixed types, follow the <a href="#_type_coercion">type coercion</a> rules.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_numeric_operators">Numeric operators</h3>
<div class="paragraph">
<p>The following operators operate on numbers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>addition: <code>+</code></p>
</li>
<li>
<p>subtraction: <code>-</code></p>
</li>
<li>
<p>multiplication <code>*</code></p>
</li>
<li>
<p>division: <code>/</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  search(left + right, {"left": 8, "right": 12 }) -&gt; 20
  search(right - left - 10, {"left": 8, "right": 12 }) -&gt; -6
  search(4 + 2 * 4, {}) -&gt; 12
  search(10 / 2 * 3, {}) -&gt; 15</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_concatenation_operator">Concatenation Operator</h3>
<div class="paragraph">
<p>The concatenation operator takes two string operands and combines them to form a single string.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  search(left &amp; "\"" &amp; value &amp; "\"" &amp; right, {"left": "[", "right": "]", "value": "abc" }) -&gt;
      "[\"abc\"]"
  search(map(&amp;"$" &amp; @, values), {"values": [123.45, 44.32, 99.00] }) -&gt;
      ["$123.45", "$44.32", "$99"]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_union_operator">Union Operator</h3>
<div class="paragraph">
<p>The union operator (<code>~</code>) combines the contents of two arrays into a single array.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  search(a ~ b, {"a": [0,1,2], "b": [3,4,5]}) -&gt; [0,1,2,3,4,5]
  search(a ~ b, {"a": [[0,1,2]], "b": [[3,4,5]]}) -&gt; [[0,1,2],[3,4,5]]
  search(a[] ~ b[], {"a": [[0,1,2]], "b": [[3,4,5]]}) -&gt; [0,1,2,3,4,5]
  search(a ~ 10, {"a": [0,1,2]}) -&gt; [0,1,2,10]
  search(a ~ `null`, {}) -&gt; [0,1,2]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_array_operators">Array Operators</h3>
<div class="paragraph">
<p>The numeric and concatenation operators (<code><strong></code>, <code>+</code>, <code>-</code>, <code></strong></code>, <code>/</code>, <code>&amp;</code>) have special behavior when applied to arrays.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When these operators are provided arrays for both operands, the operator is applied to each element of the left operand array with the corresponding element from the right operand array</p>
</li>
<li>
<p>If both operands are arrays and they do not have the same size, the shorter array is padded with null values</p>
</li>
<li>
<p>If one operand is an array and one is a scalar value, the operator is applied with the scalar against each element in the array.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  search([1,2,3] + [2,3,4], {}) =&gt; [3,5,7]
  search([1,2,3,4] * [1,2,3], {}) =&gt; [1,4,9,0]
  search([1,2,3,4] &amp; "%", {}) =&gt; ["1%", "2%", "3%", "4%"]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_or_expressions">Or Expressions</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  orExpression = expression '||' expression</code></pre>
</div>
</div>
<div class="paragraph">
<p>An or expression will evaluate to either the left expression or the right
expression.  If the evaluation of the left expression can be coerced to a true value, it is used
as the return value.  If the left expression cannot be coerced to a true value, then the evaluation of the right expression is used as the return value.
The following conditions cannot be coerced to true:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Empty list: <code>[]</code></p>
</li>
<li>
<p>Empty object: <code>{}</code></p>
</li>
<li>
<p>Empty string: <code>""</code></p>
</li>
<li>
<p>False boolean: <code>false</code></p>
</li>
<li>
<p>Null value: <code>null</code></p>
</li>
<li>
<p>zero value: <code>0</code></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_examples_8">Examples</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  search(foo || bar, {"foo": "foo-value"}) -&gt; "foo-value"
  search(foo || bar, {"bar": "bar-value"}) -&gt; "bar-value"
  search(foo || bar, {"foo": "foo-value", "bar": "bar-value"}) -&gt; "foo-value"
  search(foo || bar, {"baz": "baz-value"}) -&gt; null
  search(foo || bar || baz, {"baz": "baz-value"}) -&gt; "baz-value"
  search(override || mylist[-1], {"mylist": ["one", "two"]}) -&gt; "two"
  search(override || mylist[-1], {"mylist": ["one", "two"], "override": "yes"}) -&gt; "yes"</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_and_expressions">And Expressions</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  andExpression  = expression '&amp;&amp;' expression</code></pre>
</div>
</div>
<div class="paragraph">
<p>An and expression will evaluate to either the left expression or the right
expression.  If the expression on the left hand side is a truth-like value,
then the value on the right hand side is returned.  Otherwise the result of the
expression on the left hand side is returned.  This also reduces to the
expected truth table:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">LHS</th>
<th class="tableblock halign-left valign-top">RHS</th>
<th class="tableblock halign-left valign-top">Result</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This is the standard truth table for a
`logical conjunction [AND](<a href="https://en.wikipedia.org/wiki/Truth_table#Logical_conjunction_.28AND.29" class="bare">https://en.wikipedia.org/wiki/Truth_table#Logical_conjunction_.28AND.29</a>).</p>
</div>
<div class="sect2">
<h3 id="_examples_9">Examples</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  search(True &amp;&amp; False, {"True": true, "False": false}) -&gt; false
  search(Number &amp;&amp; EmptyList, {"Number": 5, "EmptyList": []}) -&gt; []
  search(foo[?a == `1` &amp;&amp; b == `2`],
         {"foo": [{"a": 1, "b": 2}, {"a": 1, "b": 3}]}) -&gt; [{"a": 1, "b": 2}]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_paren_expressions">Paren Expressions</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  parenExpression  = '(' expression ')'</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>parenExpression</code> allows a user to override the precedence order of
an expression, e.g. <code>(a || b) &amp;&amp; c</code>.</p>
</div>
<div class="sect2">
<h3 id="_examples_10">Examples</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  search(foo[?(a == 1 || b == 2) &amp;&amp; c == 5],
         {"foo": [{"a": 1, "b": 2, "c": 3}, {"a": 3, "b": 4}]}) -&gt; []</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_not_expressions">Not Expressions</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    notExpression    = '!' expression</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>notExpression</code> negates the result of an expression.  If the expression
results in a truth-like value, a <code>notExpression</code> will change this value to
<code>false</code>.  If the expression results in a false-like value, a
<code>notExpression</code> will change this value to <code>true</code>.</p>
</div>
<div class="sect2">
<h3 id="_examples_11">Examples</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  search(!True, {"True": true}) -&gt; false
  search(!False, {"False": false}) -&gt; true
  search(!Number, {"Number": 5}) -&gt; false
  search(!EmptyList, {"EmptyList": []}) -&gt; true</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_multiselect_list">MultiSelect List</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    multiSelectList : '[' expression (',' expression)* ']' ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A multiselect expression is used to extract a subset of elements from a JSON object or array.  There are two version of multiselect, one in which the multiselect expression is enclosed in <code>{&#8230;&#8203;}</code> and one which is enclosed in <code>[&#8230;&#8203;]</code>.
This section describes the <code>[&#8230;&#8203;]</code> version.  Within the start and closing
characters is one or more expressions separated by a comma.  Each
expression will be evaluated against the JSON document.  Each returned element
will be the result of evaluating the expression. A <code>multi-select-list</code> with
<code>N</code> expressions will result in a list of length <code>N</code>.  Given a multiselect
expression <code>[expr-1,expr-2,&#8230;&#8203;,expr-n]</code>, the evaluated expression will return
<code>[evaluate(expr-1), evaluate(expr-2), &#8230;&#8203;, evaluate(expr-n)]</code>.</p>
</div>
<div class="sect2">
<h3 id="_examples_12">Examples</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  search([foo,bar], {"foo": "a", "bar": "b", "baz": "c"}) -&gt; ["a", "b"]
  search([foo,bar[0]], {"foo": "a", "bar": ["b"], "baz": "c"}) -&gt; ["a", "b"]
  search([foo,bar.baz], {"foo": "a", "bar": {"baz": "b"}}) -&gt; ["a", "b"]
  search([foo,baz], {"foo": "a", "bar": "b"}) -&gt; ["a", null]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_multiselect_hash">MultiSelect Hash</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    multi-select-hash = "{" ( keyval-expr ( "," keyval-expr )*)? "}"
    keyval-expr       = identifier ":" expression</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>multi-select-hash</code> expression is similar to a <code>multi-select-list</code>
expression, except that a hash is created instead of a list.  A
<code>multi-select-hash</code> expression also requires key names to be provided, as
specified in the <code>keyval-expr</code> rule.  Given the following rule</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    keyval-expr = identifier ":" expression</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>identifier</code> is used as the key name and the result of evaluating the
<code>expression</code> is the value associated with the <code>identifier</code> key.</p>
</div>
<div class="paragraph">
<p>Each <code>keyval-expr</code> within the <code>multi-select-hash</code> will correspond to a
single key value pair in the created hash.
Unlike the multi-select-list, a multi-select-hash may be empty.</p>
</div>
<div class="sect2">
<h3 id="_examples_13">Examples</h3>
<div class="paragraph">
<p>Given a <code>multi-select-hash</code> expression <code>{foo: one.two, bar: bar}</code> and the
data <code>{"bar": "bar", {"one": {"two": "one-two"}}}</code>, the expression is
evaluated as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A hash is created: <code>{}</code></p>
</li>
<li>
<p>A key <code>foo</code> is created whose value is the result of evaluating <code>one.two</code>
against the provided JSON document: <code>{"foo": evaluate(one.two, &lt;data&gt;)}</code></p>
</li>
<li>
<p>A key <code>bar</code> is created whose value is the result of evaluating the
expression <code>bar</code> against the provided JSON document.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The final result will be: <code>{"foo": "one-two", "bar": "bar"}</code>.</p>
</div>
<div class="paragraph">
<p>Additional examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  search({foo: foo, bar: bar}, {"foo": "a", "bar": "b", "baz": "c"})
                -&gt; {"foo": "a", "bar": "b"}
  search({foo: foo, firstbar: bar[0]}, {"foo": "a", "bar": ["b"]})
                -&gt; {"foo": "a", "firstbar": "b"}
  search({foo: foo, 'bar.baz': bar.baz}, {"foo": "a", "bar": {"baz": "b"}})
                -&gt; {"foo": "a", "bar.baz": "b"}
  search({foo: foo, baz: baz}, {"foo": "a", "bar": "b"})
                -&gt; {"foo": "a", "baz": null}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wildcard_expressions">Wildcard Expressions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are two forms of wildcard expression: <code>[*]</code> from the <code>indexExpression</code> construction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>indexExpression
  : '[' '*' ']' # bracketStar
  | '[' slice ']' # bracketSlice
  | '[' ']' # bracketFlatten
  | '[?' expression ']' # predicate
  | '[' expression ']' # select
  ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And <code>.*</code> from the chainedExpression construction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>expression : expression '.' chainedExpression

chainedExpression
  : identifier
  | multiSelectList
  | multiSelectHash
  | functionExpression
  | wildcard
  ;

wildcard : '*' ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A wildcard expression is a expression of either <code>.<strong></code> or <code>[</strong>]</code>.  A wildcard
expression can return multiple elements, and the remaining expressions are
evaluated against each returned element from a wildcard expression.  The
<code>[<strong>]</code> syntax applies to a list type and the <code>.</strong></code> syntax applies to a hash
type.</p>
</div>
<div class="paragraph">
<p>The <code>[<strong>]</code> syntax (referred to as a list wildcard expression) will return all
the elements in a list.  Any subsequent expressions will be evaluated against
each individual element.  Given an expression <code>[</strong>].child-expr</code>, and a list of
N elements, the evaluation of this expression would be <code>[child-expr(el-0),
child-expr(el-2), &#8230;&#8203;, child-expr(el-N)]</code>.  This is referred to as a
<strong>projection</strong>, and the <code>child-expr</code> expression is projected onto the
elements of the resulting list.</p>
</div>
<div class="paragraph">
<p>Once a projection has been created, all subsequent expressions are projected
onto the resulting list.</p>
</div>
<div class="paragraph">
<p>The <code>*</code> syntax (referred to as a hash wildcard expression) will return a list
of the hash element&#8217;s values.  Any subsequent expression will be evaluated
against each individual element in the list (this is also referred to as a
<strong>projection</strong>).</p>
</div>
<div class="paragraph">
<p>Note that if any subsequent expression after a wildcard expression returns a
<code>null</code> value, it is omitted from the final result list.</p>
</div>
<div class="paragraph">
<p>A list wildcard expression is valid only for the JSON array type.  If a list
wildcard expression is applied to any other JSON type, a value of <code>null</code> is
returned.</p>
</div>
<div class="paragraph">
<p>Similarly, a hash wildcard expression is valid only for the JSON object type.
If a hash wildcard expression is applied to any other JSON type, a value of
<code>null</code> is returned.  Note that JSON hashes are explicitly defined as
unordered.  Therefore a hash wildcard expression can return the values
associated with the hash in any order.  Implementations are not required
to return the hash values in any specific order.</p>
</div>
<div class="sect2">
<h3 id="_examples_14">Examples</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  search([*].foo, [{"foo": 1}, {"foo": 2}, {"foo": 3}]) -&gt; [1, 2, 3]
  search([*].foo, [{"foo": 1}, {"foo": 2}, {"bar": 3}]) -&gt; [1, 2]
  search(*.foo, {"a": {"foo": 1}, "b": {"foo": 2}, "c": {"bar": 1}}) -&gt; [1, 2]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_json_literal_expressions">JSON Literal Expressions</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    jsonLiteral = '`' jsonValue '`'</code></pre>
</div>
</div>
<div class="paragraph">
<p>A JSON literal expression is an expression that allows arbitrary JSON objects to be
specified.  This is useful in filter expressions as well as multi select hashes
(to create arbitrary key value pairs), but is allowed anywhere an expression is
allowed.  The specification includes the definition for JSON, implementations should
use an existing JSON parser to parse literal values.  Note that the
<code>\</code> character must now be escaped in a <code>json-value</code> which means
implementations need to handle this case before passing the resulting string to
a JSON parser.</p>
</div>
<div class="sect2">
<h3 id="_examples_15">Examples</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  search(`"foo"`, {}) -&gt; "foo"
  search(`"foo\`bar"`, {}) -&gt; "foo`bar"
  search(`[1, 2]`, {}) -&gt; [1, 2]
  search(`true`, {}) -&gt; true
  search(`{"a": "b"}`.a, {}) -&gt; "b"
  search({first: a, type: `"mytype"`}, {"a": "b", "c": "d"}) -&gt; {"first": "b", "type": "mytype"}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_raw_string_literals">Raw String Literals</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>RAW_STRING : '"' (RAW_ESC | ~["\\])* '"' ;

fragment RAW_ESC : '\\' . ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A raw string is an expression that allows for a literal string value to be
specified.  The result of evaluating the raw string literal expression is a
literal string value.  It is a simpler form of a JSON literal expression that is
special cased for strings.  For example, the following expressions both
evaluate to the same value: "foo"</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    search(`"foo"`, "{}") -&gt; "foo"
    search("foo", "{}") -&gt; "foo"</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see in the examples above, it is meant as a more succinct
form of the common scenario of specifying a json literal string value.</p>
</div>
<div class="paragraph">
<p>In addition, it does not perform any of the
additional processing that JSON strings supports including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Not expanding unicode escape sequences</p>
</li>
<li>
<p>Not expanding newline characters</p>
</li>
<li>
<p>Not expanding tab characters or any other escape sequences documented
in RFC 4627 section 2.5.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  search("foo", {}) -&gt; "foo"
  search(" bar ", {}) -&gt; " bar "
  search("[baz]", {}) -&gt; "[baz]"
  search("[baz]", {}) -&gt; "[baz]"
  search("\u03a6", {}) -&gt; "\u03a6"
  search("\"\\\"", {}) -&gt; "\\"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_number_literals">Number literals</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>numberLiteral = (REAL_OR_EXPONENT_NUMBER | SIGNED_INT)
REAL_OR_EXPONENT_NUMBER
  : '-'? INT '.' [0-9] + EXP?
  | '-'? INT EXP
  ;

SIGNED_INT : '-'? INT ;

fragment INT
  : '0'
  | [1-9] [0-9]*
  ;

fragment EXP
  : [Ee] [+\-]? INT
  ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with raw strings, json-formula allows literal numbers in expressions.
Allowing numbers in expressions does lead to some ambiguity.
A bracket with a single signed digit e.g.: <code>[0]</code> can be interpreted as a flatten operation or a multi-select list with the number zero. To handle this ambiguity, the grammar sets a precedence so that <code>[-?[0-9]]</code> is consistently treated as a an index operation.  To explicitly express an array with one element, use a JSON literal: <code> `[0]` </code></p>
</div>
<div class="sect2">
<h3 id="_examples_16">Examples</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  search(44, {}) -&gt; 44
  search([12, 13], {}) -&gt; [12, 13]
  search({a: 12, b: 13}, {}) -&gt; {"a": 12, "b": 13}
  search(foo | [1], {"foo": [3,4,5]}) -&gt; 4
  search(foo | @[-1], {"foo": [3,4,5]}) -&gt; 5
  search(foo | [1, 2], {"foo": [3,4,5]}) -&gt; [1, 2]
  search(6 / 3, {}) -&gt; 2</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_filter_expressions">Filter Expressions</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>indexExpression
  : '[' '*' ']' # bracketStar
  | '[' slice ']' # bracketSlice
  | '[' ']' # bracketFlatten
  | '[?' expression ']' # filter
  | '[' expression ']' # select
  ;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A filter expression is defined by a <code>indexExpression</code> where the bracket contents are prefixed with a question mark character (<code>?</code>).
A filter expression provides a way to select JSON elements based on a
comparison to another expression.  A filter expression is evaluated as follows:
for each element in an array evaluate the <code>expression</code> against the
element.  If the expression evaluates to a truth-like value, the item (in its
entirety) is added to the result list.  Otherwise it is excluded from the
result list.  A filter expression is defined only for a JSON array.  Attempting
to evaluate a filter expression against any other type will return <code>null</code>.</p>
</div>
<div class="sect2">
<h3 id="_examples_17">Examples:</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>search(foo[?a &lt; b], {"foo": [
          {"a": "char", "b": "bar"},
          {"a": 2, "b": 1},
          {"a": 1, "b": 2},
          {"a": false, "b": "1"},
          {"a": 10, "b": "12"}
        ]})
  =&gt;
  [ {"a": 1, "b": 2},
    {"a": false, "b": "1"},
    {"a": 10, "b": "12"} ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The five elements in the foo list are evaluated against <code>a &lt; b</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The first element resolves to the comparison <code>"char" &lt; "bar"</code>, and because these types are string, the comparison of code points returns <code>false</code>, and the first element is excluded from the result list.</p>
</li>
<li>
<p>The second element resolves to <code>2 &lt; 1</code>,
which is <code>false</code>, so the second element is excluded from the result list.</p>
</li>
<li>
<p>The third expression resolves to <code>1 &lt; 2</code> which evaluates to <code>true</code>, so the third element is included in the result list.</p>
</li>
<li>
<p>The fourth expression resolves to <code>false &lt; "1"</code>. Since the left hand operand is boolean, both operands are coerced to numbers and evaluated as: <code>0 &lt; 1</code> and so the fourth element included in the result list.</p>
</li>
<li>
<p>The final expression resolves to <code>10 &lt; "12"</code>.  Since we have mixed operands, the right hand operand is coerced to the same type as the left hand operand (numeric) and evaluated as: <code>10 &lt; 12</code> and the last element is included in the result list.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_examples_18">Examples</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  search(foo[?bar==10], {"foo": [{"bar": 1}, {"bar": 10}]}) -&gt; [{"bar": 10}]
  search([?bar==10], [{"bar": 1}, {"bar": 10}]}) -&gt; [{"bar": 10}]
  search(foo[?a==b], {"foo": [{"a": 1, "b": 2}, {"a": 2, "b": 2}]}) -&gt; [{"a": 2, "b": 2}]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_function_expressions">Function Expressions</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    function-expression = unquoted-string  (
                            no-args  /
                            one-or-more-args )
    no-args             = "(" ")"
    one-or-more-args    = "(" ( function-arg *( "," function-arg ) ) ")"
    function-arg        = expression / current-node / expression-type
    current-node        = "@"
    expression-type     = "&amp;" expression</code></pre>
</div>
</div>
<div class="paragraph">
<p>Functions allow users to easily transform and filter data in json-formula
expressions.</p>
</div>
<div class="sect2">
<h3 id="_current_node">current-node</h3>
<div class="paragraph">
<p>The <code>current-node</code> token can be used to represent the current node being
evaluated. The <code>current-node</code> token is useful for functions that require the
current node being evaluated as an argument. For example, given:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>{
  "family": [
    {"name": "Joe", "age": 22},
    {"name": "Jane", "age": 23, "occupation": "lawyer"}
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following
expression creates an array of arrays where each nested array contains the total number of elements in the object and the 'name' property of the object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    family[].[length(@), name]</code></pre>
</div>
</div>
<div class="paragraph">
<p>json-formula assumes that all function arguments operate on the current node unless the argument is a literal.  Because of this, an
expression such as <code>@.name`</code> would be equivalent to just <code>name</code>.</p>
</div>
<div class="sect3">
<h4 id="_current_node_state">current-node state</h4>
<div class="paragraph">
<p>At the start of an expression, the value of the current node is the data
being evaluated by the json-formula expression. As an expression is evaluated, the
value the current node represents MUST change to reflect the node currently
being evaluated. When in a projection, the current node value must be changed
to the node currently being evaluated by the projection.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_function_evaluation">Function Evaluation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Functions are evaluated in applicative order.  Each argument must be an
expression, each argument expression must be evaluated before evaluating the
function. The function is then called with the evaluated function arguments.
The one exception to this rule is the <code>if(expr, result1, result2)</code> function. In this case either result1 or result2 is evaluated, depending on the outcome of <code>expr</code>.
The result of the <code>function-expression</code> is the result returned by the
function call.  If a <code>function-expression</code> is evaluated for a function that
does not exist, the json-formula implementation must indicate to the caller that an
<code>unknown-function</code> error occurred.  How and when this error is raised is
implementation specific, but implementations should indicate to the caller that
this specific error occurred.</p>
</div>
<div class="paragraph">
<p>Functions can either have a specific arity or be variadic with a minimum
number of arguments.  If a <code>function-expression</code> is encountered where the
arity does not match or the minimum number of arguments for a variadic function
is not provided, then implementations must indicate to the caller than an
<code>invalid-arity</code> error occurred.  How and when this error is raised is
implementation specific.</p>
</div>
<div class="paragraph">
<p>Each function signature declares the types of its input parameters.  If any
type constraints are not met, implementations must indicate that an
<code>invalid-type</code> error occurred.</p>
</div>
<div class="paragraph">
<p>In order to accommodate type constraints, function implementations will attempt to coerce parameters to the correct type.  If implicit coercion is not sufficient, explicit functions are provided to convert
values to other types (<code>toString()</code>, <code>toNumber()</code>).</p>
</div>
<div class="paragraph">
<p>Function expressions are also allowed as the child element of a sub expression.
This allows functions to be used with projections, which can enable functions
to be applied to every element in a projection.  For example, given the input
data of <code>["1", "2", "3", "notanumber", true]</code>, the following expression can
be used to convert (and filter) all elements to numbers</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    search([].toNumber(@), ["1", "2", "3", "notanumber", null, true]) -&gt; [1,2,3,0,1]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This provides a simple mechanism to explicitly convert types when needed.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_built_in_functions">Built-in Functions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>json-formula has a robust set of built-in functions that operate on different
data types. Each function below has a signature
that defines the expected types of the input and the type of the returned
output.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    return_type function_name(type $argname)
    return_type function_name2(type1|type2 $argname)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The list of data types supported by a function are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>number (integers and double-precision floating-point format in JSON)</p>
</li>
<li>
<p>string</p>
</li>
<li>
<p>boolean (<code>true</code> or <code>false</code>)</p>
</li>
<li>
<p>array (an ordered, sequence of values)</p>
</li>
<li>
<p>object (an unordered collection of key value pairs)</p>
</li>
<li>
<p>null</p>
</li>
<li>
<p>expression (denoted by <code>&amp;expression</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With the exception of the last item, all of the above types correspond
to the types provided by JSON.</p>
</div>
<div class="paragraph">
<p>If the resolved arguments do not
match the types specified in the signature, an <code>invalid-type</code> error occurs.</p>
</div>
<div class="paragraph">
<p>The <code>array</code> type can further specify requirements on the type of the elements
if they want to enforce homogeneous types.  The subtype is surrounded by
<code>[type]</code>, for example, the function signature requires its input
argument resolves to an array of numbers</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    return_type foo(array[number] $argname)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a shorthand, the type <code>any</code> is used to indicate that the argument can be
of any type (<code>array|object|number|string|boolean|null</code>).</p>
</div>
<div class="paragraph">
<p>json-formula functions are required to attempt to coerce values to the required type and are required to type check the resulting coerced arguments.
Specifying an invalid type for a function argument will result in a
<code>invalid-type</code> error.</p>
</div>
<div class="paragraph">
<p>The expression type, denoted by <code>&amp;expression</code>, is used to specify a
expression that is not immediately evaluated.  Instead, a reference to that
expression is provided to the function being called.  The function can then
choose to apply the expression reference as needed.  It is semantically similar
to an anonymous function. See the <code>sortBy</code> function for an example
usage of the expression type.</p>
</div>
<div class="paragraph">
<p>Similarly how arrays can specify a type within a list using the
<code>array[type]</code> syntax, expressions can specify their resolved type using
<code>expression&#8594;type</code> syntax.  This means that the resolved type of the function
argument must be an expression that itself will resolve to <code>type</code>.</p>
</div>
<div class="paragraph">
<p>To demonstrate the above points, consider this example using the <code>abs()</code> function.  Given:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    {"foo": -1, "bar": "2"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Evaluating <code>abs(foo)</code> works as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Evaluate the input argument against the current data:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>     search(foo, {"foo": -1, "bar": "2"}) -&gt; -1</code></pre>
</div>
</div>
</li>
<li>
<p>Coerce the type of the resolved argument if needed.  In this case <code>-1</code> is of type <code>number</code> so no coercion is needed.</p>
</li>
<li>
<p>Validate the type of the coerced argument.  In this case <code>-1</code> is of type <code>number</code> so it passes the type check.</p>
</li>
<li>
<p>Call the function with the resolved argument:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>     abs(-1) -&gt; 1</code></pre>
</div>
</div>
</li>
<li>
<p>The value of <code>1</code> is the resolved value of the function expression <code>abs(foo)</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Below is the same steps for evaluating <code>abs(bar)</code>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Evaluate the input argument against the current data:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>     search(bar, {"foo": -1, "bar": "2"}) -&gt; "2"</code></pre>
</div>
</div>
</li>
<li>
<p>Attempt to coerce the result to the required number type.  In this case, coerce <code>"2"</code> to <code>2</code>.</p>
</li>
<li>
<p>Validate the type of the coerced argument.  In this case <code>2</code> is of type <code>number</code> so it passes the type check.</p>
</li>
<li>
<p>Call the function with the resolved and coerced argument:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>     abs(2) -&gt; 2</code></pre>
</div>
</div>
</li>
<li>
<p>The value of <code>2</code> is the resolved value of the function expression <code>abs(bar)</code></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pipe_expressions">Pipe Expressions</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    pipeExpression  = expression '|' expression</code></pre>
</div>
</div>
<div class="paragraph">
<p>A pipe expression combines two expressions, separated by the <code>|</code> character.
It is similar to a <code>sub-expression</code> with two important distinctions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Any expression can be used on the right hand side.  A <code>sub-expression</code>
restricts the type of expression that can be used on the right hand side.</p>
</li>
<li>
<p>A <code>pipe-expression</code> <strong>stops projections on the left hand side for
propagating to the right hand side</strong>.  If the left expression creates a
projection, it does <strong>not</strong> apply to the right hand side.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example, given the following data</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    {"foo": [{"bar": ["first1", "second1"]}, {"bar": ["first2", "second2"]}]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The expression <code>foo[*].bar</code> gives the result of</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    [
        [
            "first1",
            "second1"
        ],
        [
            "first2",
            "second2"
        ]
    ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first part of the expression, <code>foo[<strong>]</code>, creates a projection.  At this
point, the remaining expression, <code>bar</code> is projected onto each element of the
list created from <code>foo[</strong>]</code>.  If you project the <code>[0]</code> expression, you will
get the first element from each sub list.  The expression <code>foo[*].bar[0]</code>
will return</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    ["first1", "first2"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you instead wanted <strong>only</strong> the first sub list, <code>["first1", "second1"]</code>, you
can use a <code>pipe-expression</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    foo[*].bar[0] -&gt; ["first1", "first2"]
    foo[*].bar | [0] -&gt; ["first1", "second1"]</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_examples_19">Examples</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>   search(foo | bar, {"foo": {"bar": "baz"}}) -&gt; "baz"
   search(foo[*].bar | [0], {
       "foo": [{"bar": ["first1", "second1"]},
               {"bar": ["first2", "second2"]}]}) -&gt; ["first1", "second1"]
   search(foo | [0], {"foo": [0, 1, 2]}) -&gt; 0</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_integrations">Integrations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The json-formula API allows integrations to customize various json-formula behaviors.</p>
</div>
<div class="sect2">
<h3 id="_globals">Globals</h3>
<div class="paragraph">
<p>By default, json-formula has one global symbol: <code>@</code>. A host may inject additional global identifiers.  These identifiers must be prefixed with the dollar (<code>$</code>) symbol.</p>
</div>
<div class="sect3">
<h4 id="_examples_20">Examples</h4>
<div class="paragraph">
<p>Given: a global symbol:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>  {
    "$days": [
       "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"
    ]
  }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>    search(value($days, weekday(datetime(date.year, date.month, date.day), 3)),
    {
      "date": {
        "year": 2023,
        "month": 9,
        "day": 13
      }
    }) -&gt; "Wednesday"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_specify_locale">Specify locale</h3>
<div class="paragraph">
<p>The default locale for json-formula is <code>en-US</code>.  A host may specify an alternate locale.  Overall, the locale setting has little effect on processing.  One specific area that is affected is the behavior of the <code>casefold()</code> function.</p>
</div>
</div>
<div class="sect2">
<h3 id="_custom_tonumber">Custom toNumber</h3>
<div class="paragraph">
<p>In various contexts, json-formula converts values to numbers.  The default string-to-number functionality will make a modest attempt to convert currencies or date values to number&#8201;&#8212;&#8201;however this functionality is rudimentary and is not necessarily consistent in different locales.
A host may provide its own <code>toNumber()</code> function that json-formula will use in place of the default functionality.  For example, a custom <code>toNumber()</code> could make use of locale-specific date formats to attempt to convert a string to a date value.</p>
</div>
</div>
<div class="sect2">
<h3 id="_additional_functions">Additional Functions</h3>
<div class="paragraph">
<p>A host may provide its own set of functions to augment the base set provided by json-formula</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-09-18 11:58:12 -0400
</div>
</div>
</body>
</html>